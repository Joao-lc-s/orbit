<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbit v7.0 | Cloud Study OS Ultimate (Enhanced)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace']
                    },
                    colors: {
                        brand: {
                            50: 'var(--brand-50)', 100: 'var(--brand-100)', 200: 'var(--brand-200)',
                            300: 'var(--brand-300)', 400: 'var(--brand-400)', 500: 'var(--brand-500)',
                            600: 'var(--brand-600)', 700: 'var(--brand-700)', 800: 'var(--brand-800)',
                            900: 'var(--brand-900)',
                        },
                        bg: { main: 'var(--bg-main)', panel: 'var(--bg-panel)', card: 'var(--bg-card)' },
                        txt: { main: 'var(--text-main)', muted: 'var(--text-muted)' }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- DEFINIÇÃO DE TEMAS (CSS VARIABLES) --- */
        :root {
            /* Padrão Light */
            --bg-main: #f8fafc; --bg-panel: #ffffff; --bg-card: #ffffff;
            --text-main: #0f172a; --text-muted: #64748b;
            --brand-50: #eff6ff; --brand-100: #dbeafe; --brand-200: #bfdbfe;
            --brand-500: #3b82f6; --brand-600: #2563eb; --brand-900: #1e3a8a;
        }
        .theme-dark {
            --bg-main: #0f172a; --bg-panel: #1e293b; --bg-card: #1e293b;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
            --brand-50: #1e1b4b; --brand-100: #312e81; --brand-200: #3730a3;
            --brand-500: #6366f1; --brand-600: #4f46e5; --brand-900: #c7d2fe;
        }
        .theme-dracula {
            --bg-main: #282a36; --bg-panel: #44475a; --bg-card: #44475a;
            --text-main: #f8f8f2; --text-muted: #bd93f9;
            --brand-50: #ff79c6; --brand-100: #bd93f9; --brand-200: #ff79c6;
            --brand-500: #ff79c6; --brand-600: #bd93f9; --brand-900: #f1fa8c;
        }
        .theme-forest {
            --bg-main: #1a2f23; --bg-panel: #243c2f; --bg-card: #2f4b3b;
            --text-main: #e8f5e9; --text-muted: #a5d6a7;
            --brand-50: #1b5e20; --brand-100: #2e7d32; --brand-200: #4caf50;
            --brand-500: #66bb6a; --brand-600: #81c784; --brand-900: #c8e6c9;
        }

        /* --- ESTILOS GERAIS --- */
        body { background-color: var(--bg-main); color: var(--text-main); transition: background-color 0.4s ease, color 0.4s ease; margin: 0; overflow: hidden; }
        
        /* Scrollbar Customizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); opacity: 0.2; border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-500); }

        /* Mapa Mental Fix & Infinite Canvas */
        .mindmap-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-card);
            cursor: grab;
            touch-action: none; /* Importante para mobile */
        }
        .mindmap-viewport:active { cursor: grabbing; }
        
        /* O "mundo" que movemos dentro da viewport */
        .mindmap-world {
            position: absolute;
            top: 0;
            left: 0;
            width: 0; 
            height: 0;
            overflow: visible;
            transform-origin: 0 0;
            will-change: transform;
        }
        
        /* Grid de fundo */
        .mindmap-bg {
            position: absolute;
            top: -5000px;
            left: -5000px;
            width: 10000px;
            height: 10000px;
            background-image: radial-gradient(var(--text-muted) 1px, transparent 1px);
            background-size: 24px 24px;
            opacity: 0.3;
            pointer-events: none;
        }

        .mm-node {
            position: absolute;
            min-width: 140px;
            min-height: 60px;
            padding: 12px;
            background-color: var(--bg-card);
            border: 2px solid; 
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            user-select: none;
            transition: box-shadow 0.2s;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            resize: both;
            overflow: hidden;
            z-index: 10;
        }
        
        /* Alça de resize customizada */
        .mm-node::-webkit-resizer {
            background-color: transparent;
            border-bottom: 2px solid var(--text-muted);
            border-right: 2px solid var(--text-muted);
        }
        
        .mm-node:active { cursor: grabbing; z-index: 40; }
        .mm-node.selected { 
            box-shadow: 0 0 0 4px var(--brand-200); 
            z-index: 50 !important;
        }

        .mm-node textarea {
            background: transparent;
            width: 100%;
            height: 100%;
            resize: none;
            outline: none;
            border: none;
            font-weight: bold;
            text-align: center;
            font-family: inherit;
            color: var(--text-main);
            overflow: hidden;
            pointer-events: auto;
        }
        /* Re-habilita edição ao focar/clicar explicitamente */
        .mm-node.editing textarea { pointer-events: auto; }

        /* Utilitários */
        .zen-hidden { display: none !important; }
        .active-nav { background-color: var(--brand-50); color: var(--brand-600); border-left: 4px solid var(--brand-600); }
        .active-sett-tab { background-color: var(--brand-50) !important; color: var(--brand-600) !important; border-left: 4px solid var(--brand-600); }
        
        /* Modo Leitura */
        .readonly .mm-toolbar { display: none !important; }
        .readonly .mm-node { resize: none; cursor: default; }
        .readonly .mm-node::-webkit-resizer { display: none; }
    </style>
</head>
<body class="h-screen w-screen font-sans selection:bg-brand-500 selection:text-white">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-bg-main flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative w-24 h-24">
            <div class="absolute inset-0 border-4 border-slate-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-brand-500 rounded-full border-t-transparent animate-spin"></div>
            <i class="ph-fill ph-planet absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl text-brand-600 animate-pulse"></i>
        </div>
        <h2 class="mt-4 text-2xl font-bold tracking-widest text-txt-main">ORBIT <span class="text-brand-500">v7.0</span></h2>
        <p class="text-xs text-txt-muted mt-2 font-mono" id="loading-text">Carregando Sistema...</p>
    </div>

    <div id="app-layout" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        
        <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>
        
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-[280px] bg-bg-main border-r border-slate-200 flex flex-col z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 shadow-2xl lg:shadow-none">
            <div class="h-20 flex items-center px-6 border-b border-slate-200/10 shrink-0">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-brand-700 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
                    <i class="ph-bold ph-planet text-xl"></i>
                </div>
                <div class="ml-3">
                    <h1 class="font-bold text-xl text-txt-main tracking-tight">Orbit</h1>
                    <div class="flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <p class="text-[10px] uppercase font-bold text-txt-muted tracking-widest">Enhanced</p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="ml-auto lg:hidden text-txt-muted p-2 rounded hover:bg-bg-main"><i class="ph-bold ph-x"></i></button>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-[10px] font-bold text-txt-muted uppercase px-3 mb-2 tracking-wider">Principal</div>
                
                <button onclick="router('dashboard')" id="nav-dashboard" class="w-full flex items-center p-3 rounded-xl text-txt-muted hover:bg-bg-main hover:text-brand-600 transition-all font-medium text-sm group">
                    <i class="ph ph-squares-four text-xl mr-3 group-hover:scale-110 transition-transform"></i> Visão Geral
                </button>
                <button onclick="router('cronograma')" id="nav-cronograma" class="w-full flex items-center p-3 rounded-xl text-txt-muted hover:bg-bg-main hover:text-brand-600 transition-all font-medium text-sm group">
                    <i class="ph ph-calendar-check text-xl mr-3 group-hover:scale-110 transition-transform"></i> Cronograma
                    <span id="badge-tasks" class="ml-auto text-[10px] bg-brand-100 text-brand-700 px-1.5 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="router('mindmap')" id="nav-mindmap" class="w-full flex items-center p-3 rounded-xl text-txt-muted hover:bg-bg-main hover:text-brand-600 transition-all font-medium text-sm group">
                    <i class="ph ph-tree-structure text-xl mr-3 group-hover:scale-110 transition-transform"></i> Mapa Mental
                </button>

                <div class="text-[10px] font-bold text-txt-muted uppercase px-3 mt-6 mb-2 tracking-wider">Ferramentas</div>
                
                <button onclick="router('foco')" id="nav-foco" class="w-full flex items-center p-3 rounded-xl text-txt-muted hover:bg-bg-main hover:text-brand-600 transition-all font-medium text-sm group">
                    <i class="ph ph-timer text-xl mr-3 group-hover:scale-110 transition-transform"></i> Modo Foco
                </button>
                <button onclick="router('questoes')" id="nav-questoes" class="w-full flex items-center p-3 rounded-xl text-txt-muted hover:bg-bg-main hover:text-brand-600 transition-all font-medium text-sm group">
                    <i class="ph ph-graduation-cap text-xl mr-3 group-hover:scale-110 transition-transform"></i> Vestibular
                </button>
                <button onclick="router('loja')" id="nav-loja" class="w-full flex items-center p-3 rounded-xl text-txt-muted hover:bg-bg-main hover:text-brand-600 transition-all font-medium text-sm group">
                    <i class="ph ph-storefront text-xl mr-3 group-hover:scale-110 transition-transform"></i> Conquistas
                </button>
            </nav>

            <div class="p-4 border-t border-slate-200/10 bg-bg-main/50 relative">
                <button onclick="toggleUserMenu()" class="w-full flex items-center gap-3 p-2 rounded-xl hover:bg-bg-card transition-all border border-transparent hover:border-slate-200/10">
                    <img id="user-avatar" src="https://ui-avatars.com/api/?name=Estudante&background=random" class="w-9 h-9 rounded-full border-2 border-brand-200">
                    <div class="flex-1 min-w-0 text-left">
                        <p id="user-name" class="text-xs font-bold text-txt-main truncate">Visitante</p>
                        <p class="text-[10px] text-txt-muted truncate">Clique para menu</p>
                    </div>
                    <i class="ph-bold ph-caret-up text-txt-muted"></i>
                </button>

                <div id="user-menu" class="absolute bottom-[80px] left-4 right-4 bg-bg-main rounded-2xl shadow-2xl border border-slate-200/10 hidden flex-col overflow-hidden animate-slide-up origin-bottom z-50">
                    <div class="p-3 border-b border-slate-200/10 bg-bg-main/30">
                        <p class="text-[10px] font-bold text-txt-muted uppercase">Conta</p>
                    </div>
                    <button onclick="openSettings()" class="p-3 text-sm text-txt-main hover:bg-bg-main hover:text-brand-600 flex items-center gap-3 text-left">
                        <i class="ph-bold ph-gear"></i> Configurações
                    </button>
                    <button onclick="openSettings(), Settings.tab('data')" class="p-3 text-sm text-txt-main hover:bg-bg-main hover:text-brand-600 flex items-center gap-3 text-left">
                        <i class="ph-bold ph-cloud"></i> API & Dados
                    </button>
                    <button onclick="openTrash()" class="p-3 text-sm text-txt-main hover:bg-bg-main hover:text-red-500 flex items-center gap-3 text-left">
                        <i class="ph-bold ph-trash"></i> Lixeira (24h)
                    </button>
                    <div class="h-px bg-slate-200/10 my-1"></div>
                    <button onclick="Auth.login()" id="btn-auth" class="p-3 text-sm text-brand-600 font-bold hover:bg-brand-50 flex items-center gap-3 text-left w-full justify-between">
                        <span>Conectar (Anon)</span> <i class="ph-bold ph-sign-in"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 min-w-0 flex flex-col h-full relative overflow-hidden bg-bg-main transition-colors duration-500">
            
            <header class="h-16 px-6 flex items-center justify-between z-30 shrink-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 text-txt-main rounded-lg bg-bg-main shadow-sm border border-slate-200/10 w-10 h-10"><i class="ph-bold ph-list"></i></button>
                    <div>
                        <h2 id="page-title" class="text-xl font-bold text-txt-main leading-tight">Dashboard</h2>
                        <p id="current-date" class="text-[11px] font-mono text-txt-muted hidden md:block opacity-70">...</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="toggleZen()" class="p-2 rounded-lg bg-bg-main border border-slate-200/10 text-txt-muted hover:text-brand-600 hover:border-brand-500 transition-all shadow-sm w-10 h-10" title="Modo Zen">
                        <i class="ph-fill ph-arrows-out-simple"></i>
                    </button>
                    <div class="flex items-center gap-2 bg-bg-main border border-brand-200 px-3 py-1.5 rounded-full shadow-sm">
                        <i class="ph-fill ph-star text-yellow-400 drop-shadow-sm"></i>
                        <span id="display-xp" class="font-bold text-txt-main text-sm">0 XP</span>
                    </div>
                </div>
            </header>

            <div id="content-scroll" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative">
                
                <div id="view-dashboard" class="space-y-8 max-w-7xl mx-auto animate-slide-up">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-card p-6 rounded-3xl border border-slate-200/10 shadow-lg shadow-slate-200/5 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-fire text-8xl text-orange-500"></i></div>
                            <p class="text-txt-muted text-xs font-bold uppercase tracking-wider">Sequência</p>
                            <h3 id="stat-streak" class="text-4xl font-bold text-txt-main mt-1">0 Dias</h3>
                            <p class="text-xs text-brand-600 mt-2 font-bold flex items-center gap-1"><i class="ph-bold ph-trend-up"></i> Mantenha o ritmo!</p>
                        </div>

                        <div class="bg-card p-6 rounded-3xl border border-slate-200/10 shadow-lg shadow-slate-200/5 relative overflow-hidden group">
                             <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-check-circle text-8xl text-emerald-500"></i></div>
                            <p class="text-txt-muted text-xs font-bold uppercase tracking-wider">Produtividade Hoje</p>
                            <h3 id="stat-tasks-done" class="text-4xl font-bold text-txt-main mt-1">0/0</h3>
                            <p class="text-xs text-txt-muted mt-2">Tarefas concluídas</p>
                        </div>

                        <div class="bg-gradient-to-br from-brand-600 to-brand-900 p-6 rounded-3xl text-white shadow-xl shadow-brand-500/20 relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-brand-200 text-xs font-bold uppercase tracking-wider">Nível Atual</p>
                                <div class="flex justify-between items-end mt-1">
                                    <h3 id="stat-level" class="text-3xl font-bold">Iniciante</h3>
                                    <span id="stat-xp-detail" class="text-xs font-mono bg-white/10 px-2 py-1 rounded">0/1000 XP</span>
                                </div>
                                <div class="w-full bg-black/20 h-2 mt-4 rounded-full overflow-hidden">
                                    <div id="xp-bar" class="bg-white h-full transition-all duration-1000 w-0"></div>
                                </div>
                            </div>
                            <i class="ph-fill ph-medal absolute -bottom-6 -right-6 text-[10rem] text-white opacity-5 rotate-12"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <section>
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-txt-main flex items-center gap-2"><i class="ph-fill ph-anchor-simple"></i> Âncoras (Hábitos)</h3>
                                    <button onclick="openAnchorModal()" class="text-xs font-bold bg-bg-main border border-slate-200/10 text-txt-muted hover:text-brand-600 px-3 py-1.5 rounded-lg transition-colors">+ Adicionar</button>
                                </div>
                                <div id="anchors-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    </div>
                            </section>

                            <section>
                                <h3 class="text-lg font-bold text-txt-main mb-4 flex items-center gap-2"><i class="ph-fill ph-list-checks"></i> Agenda de Hoje</h3>
                                <div id="today-tasks" class="bg-card rounded-3xl p-6 border border-slate-200/10 min-h-[200px] flex flex-col justify-center items-center text-txt-muted">
                                    </div>
                            </section>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-bg-main p-6 rounded-3xl border border-slate-200/10">
                                <h4 class="font-bold text-txt-main mb-4">Acesso Rápido</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="router('mindmap')" class="p-3 bg-bg-main rounded-xl text-xs font-bold text-txt-muted hover:bg-brand-50 hover:text-brand-600 transition-colors text-center">
                                        <i class="ph-bold ph-tree-structure text-2xl mb-1 block"></i> Mapa
                                    </button>
                                    <button onclick="router('questoes')" class="p-3 bg-bg-main rounded-xl text-xs font-bold text-txt-muted hover:bg-brand-50 hover:text-brand-600 transition-colors text-center">
                                        <i class="ph-bold ph-exam text-2xl mb-1 block"></i> Prova
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-cronograma" class="hidden h-full flex flex-col animate-slide-up">
                    <div class="flex justify-end mb-4 px-2 gap-3">
                         <button onclick="distributePomodoro()" class="flex items-center gap-2 text-xs font-bold bg-brand-100 text-brand-700 px-4 py-2 rounded-xl hover:bg-brand-200 transition shadow-sm">
                            <i class="ph-fill ph-calculator"></i> Calcular Tempo (Pomodoro)
                        </button>
                    </div>
                    <div class="flex-1 overflow-x-auto pb-4 cursor-grab active:cursor-grabbing" id="kanban-container">
                        <div class="flex gap-6 min-w-max h-full px-2" id="week-columns">
                            </div>
                    </div>
                </div>

                <!-- VIEW DO MAPA MENTAL -->
                <div id="view-mindmap" class="hidden h-full flex flex-col animate-slide-up relative bg-bg-card rounded-3xl border border-slate-200/10 overflow-hidden shadow-inner">
                    
                    <!-- 1. EXPLORER: LISTA DE MAPAS -->
                    <div id="mm-explorer" class="absolute inset-0 bg-bg-main z-20 flex flex-col p-6 overflow-y-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-2xl font-bold text-txt-main flex items-center gap-3">
                                <i class="ph-fill ph-files text-brand-500"></i> Meus Mapas
                            </h2>
                            <button onclick="document.getElementById('modal-create-map').showModal()" class="bg-brand-600 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-brand-700 transition shadow-lg flex items-center gap-2">
                                <i class="ph-bold ph-plus"></i> Novo Mapa
                            </button>
                        </div>
                        
                        <div id="mm-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- JS vai preencher aqui -->
                        </div>
                    </div>

                    <!-- 2. WORKSPACE -->
                    <div id="mm-workspace" class="hidden absolute inset-0 z-30 flex flex-col bg-bg-card">
                        <!-- Header do Workspace -->
                        <div class="absolute top-4 left-4 z-40 flex flex-col gap-2 pointer-events-auto">
                            <div class="flex items-center gap-2 bg-bg-panel p-2 rounded-xl border border-slate-200 shadow-lg mb-2">
                                <button onclick="MindMap.close()" class="w-10 h-10 rounded-lg hover:bg-slate-100 text-txt-muted flex items-center justify-center transition-colors text-lg" title="Voltar"><i class="ph-bold ph-arrow-left"></i></button>
                                <div class="px-2 border-l border-slate-200">
                                    <h4 id="mm-current-title" class="text-xs font-bold text-txt-main">Sem Título</h4>
                                    <p id="mm-current-subject" class="text-[10px] text-txt-muted">Geral</p>
                                </div>
                                <!-- Modo Visualização apenas indicador -->
                                <div id="indicator-readonly" class="hidden ml-2 px-2 py-1 bg-brand-100 text-brand-700 text-[10px] font-bold rounded uppercase">Leitura</div>
                            </div>

                            <div class="mm-toolbar bg-bg-panel p-2 rounded-xl border border-slate-200 shadow-lg flex flex-col gap-2">
                                <input type="color" id="mm-color-picker" class="w-10 h-10 rounded-full cursor-pointer border-2 border-slate-200 p-0 overflow-hidden [&::-webkit-color-swatch-wrapper]:p-0 [&::-webkit-color-swatch]:border-none [&::-webkit-color-swatch]:rounded-full" value="#2563eb" title="Cor do Nó/Texto" onchange="MindMap.updateColor(this.value)">
                                <div class="h-px bg-slate-200 my-1"></div>
                                <button onclick="window.MindMap.addNode()" class="w-10 h-10 rounded-lg hover:bg-brand-50 text-brand-600 flex items-center justify-center transition-colors text-xl" title="Adicionar Nó"><i class="ph-bold ph-plus"></i></button>
                                
                                <button onclick="window.MindMap.deleteSelectedNode()" class="w-10 h-10 rounded-lg hover:bg-orange-50 text-orange-500 flex items-center justify-center transition-colors text-xl" title="Excluir Nó"><i class="ph-bold ph-eraser"></i></button>
                                
                                <button onclick="window.MindMap.save()" class="w-10 h-10 rounded-lg hover:bg-brand-50 text-brand-600 flex items-center justify-center transition-colors text-xl" title="Salvar"><i class="ph-bold ph-floppy-disk"></i></button>
                                <button onclick="window.MindMap.deleteMap()" class="w-10 h-10 rounded-lg hover:bg-red-50 text-red-500 flex items-center justify-center transition-colors text-xl" title="Excluir Mapa"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>

                        <!-- Viewport + World -->
                        <div id="mm-viewport" class="mindmap-viewport">
                            <div id="mm-world" class="mindmap-world">
                                <div class="mindmap-bg"></div>
                                <!-- Camada de Linhas (SVG) -->
                                <svg id="mm-svg" class="absolute top-0 left-0 overflow-visible pointer-events-none z-0" style="width: 10000px; height: 10000px; transform: translate(-5000px, -5000px);"></svg>
                                <!-- Camada de Nós (HTML) -->
                                <div id="mm-nodes-layer" class="absolute top-0 left-0 w-0 h-0 z-10"></div>
                            </div>
                        </div>
                        
                        <div id="keys-map" class="absolute bottom-4 right-4 bg-bg-main/80 p-3 rounded-xl text-xs text-txt-muted pointer-events-none border border-slate-200/10 backdrop-blur-md z-40 shadow-lg">
                            <p class="font-bold">Controles:</p>
                            <ul class="list-disc pl-4 mt-1 space-y-1">
                                <li>Duplo clique: Criar Nó</li>
                                <li>Arrastar fundo: Mover Mapa</li>
                                <li>Ctrl+Click: Conectar Nós</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="view-foco" class="hidden h-full flex flex-col items-center justify-center relative animate-slide-up">
                    <div class="relative z-10 text-center">
                        <div class="inline-block mb-6 px-4 py-1 rounded-full bg-brand-100 text-brand-700 font-bold text-sm animate-pulse-slow" id="timer-status">PRONTO PARA FOCAR?</div>
                        
                        <div class="relative group cursor-pointer" onclick="Timer.edit()">
                            <h1 id="timer-display" class="text-[8rem] md:text-[12rem] font-mono font-bold leading-none tracking-tighter text-txt-main tabular-nums group-hover:text-brand-500 transition-colors">25:00</h1>
                            <input type="text" id="timer-input" class="hidden text-[8rem] md:text-[12rem] font-mono font-bold leading-none tracking-tighter bg-transparent text-center text-brand-500 w-full outline-none" onblur="Timer.saveEdit()" onkeydown="if(event.key==='Enter')this.blur()">
                        </div>

                        <div class="flex gap-6 justify-center mt-12">
                            <button onclick="Timer.toggle()" id="btn-timer-main" class="w-24 h-24 rounded-3xl bg-brand-600 text-white text-4xl flex items-center justify-center shadow-xl shadow-brand-500/40 hover:scale-110 active:scale-95 transition-all">
                                <i class="ph-fill ph-play"></i>
                            </button>
                            <button onclick="Timer.reset()" class="w-24 h-24 rounded-3xl bg-bg-main border-2 border-slate-200/10 text-txt-muted text-4xl flex items-center justify-center hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all">
                                <i class="ph-bold ph-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="view-questoes" class="hidden max-w-6xl mx-auto animate-slide-up space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div class="md:col-span-8 space-y-4">
                            <div class="bg-card p-4 rounded-2xl border border-slate-200/10 flex flex-wrap gap-4 items-center justify-between">
                                <h2 class="font-bold text-xl text-txt-main">Banco de Questões</h2>
                                <div class="flex gap-2">
                                    <input type="text" id="q-search" oninput="Quiz.render()" placeholder="Pesquisar..." class="bg-bg-main border-none rounded-xl px-4 py-2 text-sm text-txt-main w-48 focus:ring-2 focus:ring-brand-500">
                                    <button onclick="document.getElementById('modal-import').showModal()" class="bg-brand-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-brand-700 transition-colors">
                                        <i class="ph-bold ph-upload-simple"></i> Importar
                                    </button>
                                </div>
                            </div>
                            <div id="quiz-list" class="space-y-4 pb-20">
                                </div>
                        </div>

                        <div class="md:col-span-4 space-y-6">
                            <div class="bg-card p-6 rounded-3xl border border-slate-200/10 sticky top-4">
                                <h3 class="font-bold text-txt-main mb-4">Seu Desempenho</h3>
                                <div class="relative h-48 w-full flex items-center justify-center">
                                    <canvas id="chart-performance"></canvas>
                                </div>
                                <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-emerald-50 p-3 rounded-2xl">
                                        <p class="text-xs text-emerald-600 font-bold uppercase">Acertos</p>
                                        <p class="text-2xl font-bold text-emerald-700" id="stat-hits">0</p>
                                    </div>
                                    <div class="bg-red-50 p-3 rounded-2xl">
                                        <p class="text-xs text-red-600 font-bold uppercase">Erros</p>
                                        <p class="text-2xl font-bold text-red-700" id="stat-misses">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-loja" class="hidden max-w-5xl mx-auto animate-slide-up">
                    <div class="text-center py-12">
                        <h2 class="text-4xl font-bold text-txt-main mb-2">Loja de Conquistas</h2>
                        <p class="text-txt-muted">Troque seu esforço por glória.</p>
                        <div class="mt-6 inline-flex items-center gap-2 bg-yellow-400/20 text-yellow-700 px-6 py-2 rounded-full font-bold border border-yellow-400/30">
                            <i class="ph-fill ph-coins"></i> Saldo: <span id="shop-balance">0 XP</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6" id="shop-grid">
                        </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL CREATE MAP -->
    <dialog id="modal-create-map" class="bg-transparent p-0 backdrop:bg-black/60 w-full max-w-sm rounded-3xl shadow-2xl">
        <div class="bg-bg-main p-6 border border-slate-200/10">
            <h3 class="font-bold text-xl mb-4 text-txt-main">Novo Mapa Mental</h3>
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-1">Nome do Mapa</label>
            <input type="text" id="map-name" class="w-full bg-bg-main border border-slate-200/10 rounded-xl p-3 mb-4 text-txt-main focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ex: Fotossíntese">
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-1">Matéria / Pasta</label>
            <input type="text" id="map-subject" class="w-full bg-bg-main border border-slate-200/10 rounded-xl p-3 mb-6 text-txt-main focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ex: Biologia">
            
            <div class="flex gap-3">
                <button onclick="MindMap.create()" class="flex-1 bg-brand-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-brand-500/20 hover:scale-[1.02] transition-transform">Criar</button>
                <button onclick="document.getElementById('modal-create-map').close()" class="px-6 py-3 rounded-xl text-txt-muted font-bold hover:bg-bg-main transition-colors">Cancelar</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-task" class="bg-transparent p-0 backdrop:bg-black/60 w-full max-w-md rounded-3xl shadow-2xl">
        <div class="bg-bg-main p-6 border border-slate-200/10">
            <h3 class="font-bold text-xl mb-4 text-txt-main">Adicionar Tarefa</h3>
            <input type="hidden" id="task-day-ref">
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-1">Título</label>
            <input type="text" id="task-title" class="w-full bg-bg-main border border-slate-200/10 rounded-xl p-3 mb-4 text-txt-main focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ex: Estudar Matemática" onkeydown="if(event.key==='Enter') addTask()">
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-1">Tag (Matéria)</label>
            <input type="text" id="task-tag" class="w-full bg-bg-main border border-slate-200/10 rounded-xl p-3 mb-6 text-txt-main focus:ring-2 focus:ring-brand-500 outline-none" placeholder="Ex: Álgebra">
            
            <div class="flex gap-3">
                <button onclick="addTask()" class="flex-1 bg-brand-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-brand-500/20 hover:scale-[1.02] transition-transform">Confirmar</button>
                <button onclick="document.getElementById('modal-task').close()" class="px-6 py-3 rounded-xl text-txt-muted font-bold hover:bg-bg-main transition-colors">Cancelar</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-import" class="bg-transparent p-0 backdrop:bg-black/60 w-full max-w-2xl rounded-3xl shadow-2xl">
        <div class="bg-bg-main p-8 flex flex-col h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-txt-main">Importador Inteligente</h3>
                <button onclick="document.getElementById('modal-import').close()" class="text-txt-muted hover:text-red-500"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div class="bg-blue-50 text-blue-700 p-4 rounded-xl text-sm mb-4 flex gap-3">
                <i class="ph-fill ph-info text-xl"></i>
                <p>Cole o texto do PDF ou JSON. Detecta automaticamente: <br><strong>1. Enunciado</strong> • <strong>a) Alternativas</strong> ou <strong>[JSON]</strong>.</p>
            </div>
            
            <div class="flex gap-4 mb-4">
                 <input type="text" id="import-subject" placeholder="Matéria (ex: Biologia)" class="flex-1 bg-bg-main border border-slate-200/10 rounded-xl p-3 text-txt-main">
            </div>

            <textarea id="import-area" class="flex-1 w-full bg-bg-main border border-slate-200/10 rounded-xl p-4 font-mono text-xs text-txt-main focus:ring-2 focus:ring-brand-500 outline-none resize-none" placeholder="Cole a questão ou JSON aqui..."></textarea>
            
            <button onclick="Quiz.processImport()" class="w-full mt-4 bg-brand-600 text-white py-3 rounded-xl font-bold hover:bg-brand-700 transition-colors">Processar Texto</button>
        </div>
    </dialog>

    <dialog id="modal-settings" class="bg-transparent p-0 backdrop:bg-black/60 w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-bg-main flex flex-col md:flex-row h-[600px]">
            <div class="w-full md:w-64 bg-bg-main border-r border-slate-200/10 p-6 flex flex-col gap-2">
                <h3 class="font-bold text-txt-main mb-4">Preferências</h3>
                <button id="tab-btn-theme" onclick="Settings.tab('theme')" class="sett-tab active-sett-tab w-full text-left p-3 rounded-xl text-sm font-bold text-txt-muted hover:bg-bg-card transition-all">Aparência</button>
                <button id="tab-btn-data" onclick="Settings.tab('data')" class="sett-tab w-full text-left p-3 rounded-xl text-sm font-bold text-txt-muted hover:bg-bg-card transition-all">Dados & Nuvem</button>
                <button id="tab-btn-danger" onclick="Settings.tab('danger')" class="sett-tab w-full text-left p-3 rounded-xl text-sm font-bold text-txt-muted hover:bg-bg-card transition-all text-red-500 hover:text-red-600">Zona de Perigo</button>
                <div class="mt-auto">
                     <button onclick="document.getElementById('modal-settings').close()" class="w-full py-2 border border-slate-200/10 rounded-xl text-sm font-bold text-txt-muted">Fechar</button>
                </div>
            </div>
            
            <div class="flex-1 p-8 overflow-y-auto bg-card text-txt-main relative">
                
                <div id="tab-theme" class="sett-content space-y-6">
                    <h4 class="text-xl font-bold">Temas Visuais</h4>
                    <div class="grid grid-cols-2 gap-4">
                         <button onclick="Settings.setTheme('light')" class="h-24 rounded-2xl border-2 border-slate-200 bg-slate-50 hover:border-brand-500 relative overflow-hidden group">
                             <span class="absolute bottom-2 left-3 font-bold text-slate-700 text-sm">Light</span>
                             <div class="absolute top-2 right-2 w-4 h-4 rounded-full bg-blue-500"></div>
                         </button>
                         <button onclick="Settings.setTheme('dark')" class="h-24 rounded-2xl border-2 border-slate-700 bg-slate-900 hover:border-brand-500 relative overflow-hidden group">
                             <span class="absolute bottom-2 left-3 font-bold text-slate-200 text-sm">Dark</span>
                             <div class="absolute top-2 right-2 w-4 h-4 rounded-full bg-indigo-500"></div>
                         </button>
                         <button onclick="Settings.setTheme('dracula')" class="h-24 rounded-2xl border-2 border-purple-900 bg-[#282a36] hover:border-pink-500 relative overflow-hidden group">
                             <span class="absolute bottom-2 left-3 font-bold text-[#f8f8f2] text-sm">Dracula</span>
                             <div class="absolute top-2 right-2 w-4 h-4 rounded-full bg-pink-500"></div>
                         </button>
                         <button onclick="Settings.setTheme('forest')" class="h-24 rounded-2xl border-2 border-green-900 bg-[#1a2f23] hover:border-green-500 relative overflow-hidden group">
                             <span class="absolute bottom-2 left-3 font-bold text-[#e8f5e9] text-sm">Forest</span>
                             <div class="absolute top-2 right-2 w-4 h-4 rounded-full bg-green-500"></div>
                         </button>
                    </div>
                </div>

                <div id="tab-data" class="sett-content hidden space-y-6">
                    <h4 class="text-xl font-bold">Nuvem Orbit</h4>
                    <div class="bg-green-50 text-green-700 p-4 rounded-xl text-sm flex items-center gap-3">
                        <i class="ph-fill ph-cloud-check text-2xl"></i>
                        <p>O sistema está configurado automaticamente para usar a nuvem Orbit Study.</p>
                    </div>
                </div>

                <div id="tab-danger" class="sett-content hidden space-y-6">
                    <h4 class="text-xl font-bold text-red-500">Zona de Perigo</h4>
                    <div class="bg-red-50 border border-red-100 p-4 rounded-xl">
                        <h5 class="font-bold text-red-700 mb-1">Resetar Fábrica</h5>
                        <p class="text-xs text-red-600 mb-3">Isso apagará todos os dados locais e deslogará da conta.</p>
                        <button onclick="Settings.hardReset()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-600">Apagar Tudo</button>
                    </div>
                </div>

            </div>
        </div>
    </dialog>
    
    <dialog id="modal-trash" class="bg-transparent p-0 backdrop:bg-black/60 w-full max-w-lg rounded-3xl shadow-2xl">
        <div class="bg-bg-main p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-txt-main">Lixeira (24h)</h3>
                <button onclick="Trash.empty()" class="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded font-bold">Esvaziar</button>
            </div>
            <div id="trash-container" class="space-y-2 max-h-[300px] overflow-y-auto min-h-[100px]">
                </div>
            <button onclick="document.getElementById('modal-trash').close()" class="w-full mt-4 py-3 bg-bg-main rounded-xl font-bold text-sm text-txt-muted">Fechar</button>
        </div>
    </dialog>

    <div id="toast-area" class="fixed bottom-6 right-6 z-[80] flex flex-col gap-2 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // CONFIGURAÇÃO EMBUTIDA (HARDCODED)
        // =================================================================
        const embeddedFirebaseConfig = {
           "apiKey":"AIzaSyB8HXoAZkq9uPVbN3SjISFcrl6EgsFcxRc",
           "authDomain":"orbit-study.firebaseapp.com",
           "projectId":"orbit-study",
           "storageBucket":"orbit-study.firebasestorage.app",
           "messagingSenderId":"1084558202713",
           "appId":"1:1084558202713:web:8419805db15349cead1e48",
           "measurementId":"G-FLCZBTKFWJ"
        };

        // =================================================================
        // ESTADO GLOBAL DA APLICAÇÃO (DATA STORE)
        // =================================================================
        const Store = {
            state: {
                user: { xp: 0, level: 1, streak: 0, inventory: [], name: 'Visitante' },
                settings: { theme: 'light', keybinds: { 'zen': 'z', 'new': 'n' } },
                week: { 'segunda': [], 'terca': [], 'quarta': [], 'quinta': [], 'sexta': [], 'sabado': [], 'domingo': [] },
                anchors: [], 
                quiz: [], 
                quizHistory: [], // NOVO: Histórico para corrigir stats ao deletar
                stats: { hits: 0, misses: 0 },
                mindmaps: [], 
                trash: [], 
                lastLogin: null
            },
            firebase: { db: null, auth: null, userRef: null },
            
            init() {
                // Carregar LocalStorage
                try {
                    const local = localStorage.getItem('orbit_v7_state');
                    if(local) {
                        const parsed = JSON.parse(local);
                        this.state = { ...this.state, ...parsed };
                        
                        // Migração de dados legados
                        if(parsed.mindmap && (!this.state.mindmaps || this.state.mindmaps.length === 0)) {
                            this.state.mindmaps = [{
                                id: 'default-' + Date.now(),
                                name: 'Rascunho Geral',
                                subject: 'Geral',
                                nodes: parsed.mindmap.nodes || [],
                                lines: parsed.mindmap.lines || [],
                                createdAt: Date.now()
                            }];
                            delete this.state.mindmap;
                            this.save();
                        }
                    }
                } catch(e) { console.error("Erro no State:", e); }

                if(!this.state.mindmaps) this.state.mindmaps = [];
                if(!this.state.quizHistory) this.state.quizHistory = []; // Garante array se migrando de versão antiga

                // Conectar Firebase Automaticamente
                this.connectFirebase(embeddedFirebaseConfig);
                
                // Verificações
                this.checkDailyReset();
                this.cleanTrash();
                Settings.setTheme(this.state.settings.theme);
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('app-layout').classList.remove('opacity-0');
                }, 800);

                UI.renderAll();
                setTimeout(() => MindMap.renderExplorer(), 100);
            },

            save() {
                localStorage.setItem('orbit_v7_state', JSON.stringify(this.state));
                if(this.firebase.userRef) {
                    setDoc(this.firebase.userRef, this.state, {merge: true}).catch(console.error);
                }
                UI.renderStats(); 
            },

            async connectFirebase(config) {
                try {
                    const app = initializeApp(config);
                    this.firebase.auth = getAuth(app);
                    this.firebase.db = getFirestore(app);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'orbit-v7';
                    
                    // Auth Logic Mandated by System Rules
                    // FIX: Envolver em try/catch para ignorar erro de token mismatch em projetos customizados
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(this.firebase.auth, __initial_auth_token);
                        }
                    } catch (e) {
                        console.warn("Token do sistema ignorado (Projeto Customizado):", e.code);
                        // Se falhar o token customizado, tentamos anônimo se não houver usuário persistido
                        if (!this.firebase.auth.currentUser) {
                             // Opcional: await signInAnonymously(this.firebase.auth);
                             // Deixamos sem nada para o onAuthStateChanged decidir ou o usuário clicar em logar
                        }
                    }

                    onAuthStateChanged(this.firebase.auth, (u) => {
                        if(u && !u.isAnonymous) {
                            // CORREÇÃO CRÍTICA DE CAMINHO (PATH FIX)
                            this.firebase.userRef = doc(this.firebase.db, 'artifacts', appId, 'users', u.uid, 'data', 'orbit_state');
                            
                            document.getElementById('user-name').innerText = u.displayName || "Usuário";
                            document.getElementById('user-avatar').src = u.photoURL || "https://ui-avatars.com/api/?name=User&background=random";
                            document.getElementById('btn-auth').innerHTML = `<span>Sair</span> <i class="ph-bold ph-sign-out"></i>`;
                            document.getElementById('btn-auth').onclick = Auth.logout;
                            
                            onSnapshot(this.firebase.userRef, (snap) => {
                                if(snap.exists()) {
                                    this.state = {...this.state, ...snap.data()};
                                    UI.renderAll();
                                    MindMap.renderExplorer();
                                    if(MindMap.currentMap) MindMap.render(); 
                                }
                            });
                        } else {
                            // Usuário anônimo ou deslogado
                            document.getElementById('user-name').innerText = "Visitante";
                            document.getElementById('btn-auth').innerHTML = `<span>Entrar com Google</span> <i class="ph-bold ph-google-logo"></i>`;
                            document.getElementById('btn-auth').onclick = Auth.login;
                        }
                    });
                } catch(e) { console.error("Erro Firebase", e); UI.toast("Erro na conexão Cloud", "error"); }
            },

            checkDailyReset() {
                const now = new Date();
                const formatter = new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Sao_Paulo', year: 'numeric', month: '2-digit', day: '2-digit' });
                const todayStr = formatter.format(now);

                if (this.state.lastLogin !== todayStr) {
                    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = formatter.format(yesterday);

                    // Streak lógica: Se logou ontem, aumenta. Se não, reseta.
                    if (this.state.lastLogin === yesterdayStr) this.state.user.streak++;
                    else if (this.state.lastLogin) this.state.user.streak = 0; // Resetou

                    this.state.anchors.forEach(a => a.completed = false);
                    this.state.lastLogin = todayStr;
                    this.save();
                }
            },
            
            incrementStreak() {
                // Função para garantir que streak aumente com atividade
                // Se o usuário ainda não ganhou streak hoje por atividade (opcional), poderia ser implementado
                // Por enquanto, apenas salva o estado atual
                this.save();
            },

            cleanTrash() {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                this.state.trash = this.state.trash.filter(item => (now - item.dateDeleted) < oneDay);
            }
        };

        // =================================================================
        // AUTH
        // =================================================================
        window.Auth = {
            login() {
                if(Store.firebase.auth) {
                    const provider = new GoogleAuthProvider();
                    signInWithPopup(Store.firebase.auth, provider)
                        .then((result) => {
                            UI.toast("Conectado: " + result.user.displayName, "success");
                            // Recarrega para garantir sync limpo se necessário, ou deixa o listener lidar
                        })
                        .catch(e => UI.toast("Erro login Google: " + e.message, "error"));
                } else {
                    UI.toast("Erro no módulo Auth", "error");
                }
            },
            logout() {
                if(Store.firebase.auth) signOut(Store.firebase.auth);
                location.reload();
            }
        };

        // =================================================================
        // UI & RENDERIZADORES
        // =================================================================
        const UI = {
            renderAll() {
                this.renderDashboard();
                this.renderCronograma();
                this.renderStats();
                Quiz.render();
                Shop.render();
                
                const dateOpts = { weekday: 'long', day: 'numeric', month: 'long' };
                document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', dateOpts);
            },

            renderStats() {
                const currentXP = Store.state.user.xp;
                const nextLevel = Store.state.user.level * 1000;
                const pct = (currentXP % 1000) / 10;
                
                document.getElementById('display-xp').innerText = `${currentXP} XP`;
                document.getElementById('stat-level').innerText = `Nível ${Store.state.user.level}`;
                document.getElementById('stat-xp-detail').innerText = `${currentXP}/${nextLevel} XP`;
                document.getElementById('xp-bar').style.width = `${pct}%`;
                document.getElementById('stat-streak').innerText = `${Store.state.user.streak} Dias`;
                document.getElementById('shop-balance').innerText = `${currentXP} XP`;
            },

            renderDashboard() {
                const agrid = document.getElementById('anchors-grid');
                agrid.innerHTML = Store.state.anchors.map((a, i) => `
                    <div onclick="Actions.toggleAnchor(${i})" class="bg-card p-4 rounded-2xl border ${a.completed ? 'border-brand-500 bg-brand-50' : 'border-slate-200/10'} hover:scale-[1.02] transition-all cursor-pointer select-none relative group">
                        <button onclick="event.stopPropagation(); Actions.deleteAnchor(${i})" class="absolute top-2 right-2 text-txt-muted hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-bold ph-trash"></i></button>
                        <i class="ph-fill ph-${a.icon} text-2xl ${a.completed ? 'text-brand-600' : 'text-txt-muted'} mb-2 block"></i>
                        <span class="font-bold text-sm text-txt-main ${a.completed ? 'line-through opacity-50' : ''}">${a.title}</span>
                    </div>
                `).join('');
                
                const days = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                const dayKey = days[new Date().getDay()];
                const tasks = Store.state.week[dayKey] || [];
                const done = tasks.filter(t => t.completed).length;
                document.getElementById('stat-tasks-done').innerText = `${done}/${tasks.length}`;
                
                const tContainer = document.getElementById('today-tasks');
                if (tasks.length === 0) {
                    tContainer.innerHTML = `<i class="ph-duotone ph-coffee text-4xl mb-2"></i><p class="text-sm">Livre por hoje!</p>`;
                } else {
                    tContainer.classList.remove('items-center', 'justify-center');
                    tContainer.innerHTML = `<div class="w-full space-y-2">${tasks.map(t => this.generateTaskHTML(t, dayKey)).join('')}</div>`;
                }
            },

            renderCronograma() {
                const map = { 'segunda': 'Seg', 'terca': 'Ter', 'quarta': 'Qua', 'quinta': 'Qui', 'sexta': 'Sex', 'sabado': 'Sáb', 'domingo': 'Dom' };
                const container = document.getElementById('week-columns');
                
                container.innerHTML = Object.keys(Store.state.week).map(day => `
                    <div class="w-72 bg-card rounded-2xl border border-slate-200/10 flex flex-col h-full shrink-0 shadow-sm">
                        <div class="p-4 border-b border-slate-200/10 flex justify-between items-center bg-bg-main/50 rounded-t-2xl">
                            <span class="font-bold text-txt-main">${map[day]}</span>
                            <button onclick="Actions.openTaskModal('${day}')" class="w-8 h-8 rounded-lg hover:bg-brand-100 text-brand-600 flex items-center justify-center transition-colors"><i class="ph-bold ph-plus"></i></button>
                        </div>
                        <div class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar">
                            ${Store.state.week[day].map(t => this.generateTaskHTML(t, day)).join('')}
                        </div>
                    </div>
                `).join('');
            },

            generateTaskHTML(t, day) {
                return `
                <div class="group bg-bg-bg-main p-3 rounded-xl border ${t.completed ? 'border-brand-200 bg-brand-50/30' : 'border-slate-200/10'} hover:border-brand-300 transition-all shadow-sm">
                    <div class="flex items-start gap-3">
                        <div onclick="Actions.toggleTask('${day}', '${t.id}')" class="mt-1 w-5 h-5 rounded border cursor-pointer flex items-center justify-center transition-colors ${t.completed ? 'bg-brand-500 border-brand-500 text-white' : 'border-slate-300 bg-white'}">
                            ${t.completed ? '<i class="ph-bold ph-check text-xs"></i>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold text-txt-main truncate ${t.completed ? 'line-through text-txt-muted' : ''}">${t.title}</p>
                            <div class="flex items-center gap-2 mt-1">
                                ${t.tag ? `<span class="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded font-bold">${t.tag}</span>` : ''}
                                ${t.pomodoros ? `<span class="text-[10px] px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded font-bold flex items-center gap-1"><i class="ph-fill ph-clock"></i> ${t.pomodoros}m</span>` : ''}
                            </div>
                        </div>
                        <div class="hidden group-hover:flex flex-col gap-1">
                            <button onclick="Actions.addSubtask('${day}', '${t.id}')" class="text-txt-muted hover:text-brand-600" title="Add Subtarefa"><i class="ph-bold ph-list-plus"></i></button>
                            <button onclick="Actions.deleteTask('${day}', '${t.id}')" class="text-txt-muted hover:text-red-500" title="Excluir"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                    
                    ${(t.subtasks && t.subtasks.length > 0) ? `
                        <div class="mt-3 pl-3 border-l-2 border-slate-100 space-y-1">
                            ${t.subtasks.map((st, idx) => `
                                <div class="flex items-center gap-2 text-xs text-txt-muted group/sub">
                                    <input type="checkbox" ${st.checked ? 'checked' : ''} onchange="Actions.toggleSubtask('${day}', '${t.id}', ${idx})" class="accent-brand-500 w-3 h-3 cursor-pointer">
                                    <span class="${st.checked ? 'line-through' : ''} flex-1 truncate">${st.text}</span>
                                    <button onclick="Actions.deleteSubtask('${day}', '${t.id}', ${idx})" class="opacity-0 group-hover/sub:opacity-100 hover:text-red-500"><i class="ph-bold ph-x"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>`;
            },

            toast(msg, type='info') {
                const el = document.createElement('div');
                const colors = { success: 'bg-emerald-600', error: 'bg-red-500', info: 'bg-slate-800' };
                el.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg shadow-black/10 text-xs font-bold flex items-center gap-2 animate-slide-up backdrop-blur-md`;
                el.innerHTML = msg;
                document.getElementById('toast-area').appendChild(el);
                setTimeout(() => el.remove(), 3500);
            }
        };

        // =================================================================
        // LÓGICA DE AÇÕES
        // =================================================================
        window.Actions = {
            openTaskModal(day) {
                document.getElementById('task-day-ref').value = day;
                document.getElementById('modal-task').showModal();
                setTimeout(() => document.getElementById('task-title').focus(), 100);
            },
            
            toggleAnchor(idx) {
                Store.state.anchors[idx].completed = !Store.state.anchors[idx].completed;
                if(Store.state.anchors[idx].completed) {
                     Store.state.user.xp += 50; UI.toast("+50 XP Hábito!");
                }
                Store.save(); UI.renderDashboard();
            },

            deleteAnchor(idx) {
                if(confirm("Remover hábito?")) {
                    Store.state.anchors.splice(idx, 1); Store.save(); UI.renderDashboard();
                }
            },
            
            toggleTask(day, id) {
                const t = Store.state.week[day].find(x => x.id === id);
                if(t) {
                    t.completed = !t.completed;
                    if(t.completed) { 
                        Store.state.user.xp += 20; 
                        Store.state.user.streak++; // Aumenta sequencia ao fazer tarefa
                        UI.toast("+20 XP e Sequência!", "success"); 
                    } else Store.state.user.xp -= 20;
                    Store.save(); UI.renderAll();
                }
            },

            deleteTask(day, id) {
                const idx = Store.state.week[day].findIndex(x => x.id === id);
                if(idx > -1) {
                    const item = Store.state.week[day][idx];
                    Trash.add(item, 'task', day);
                    Store.state.week[day].splice(idx, 1);
                    Store.save(); UI.renderAll();
                }
            },

            addSubtask(day, id) {
                const text = prompt("Nome da subtarefa:");
                if(!text) return;
                const t = Store.state.week[day].find(x => x.id === id);
                if(!t.subtasks) t.subtasks = [];
                t.subtasks.push({ text, checked: false });
                Store.save(); UI.renderAll();
            },

            toggleSubtask(day, tid, sidx) {
                const t = Store.state.week[day].find(x => x.id === tid);
                t.subtasks[sidx].checked = !t.subtasks[sidx].checked;
                Store.save(); UI.renderAll();
            },
            
            deleteSubtask(day, tid, sidx) {
                const t = Store.state.week[day].find(x => x.id === tid);
                t.subtasks.splice(sidx, 1);
                Store.save(); UI.renderAll();
            }
        };

        window.addTask = () => {
            const day = document.getElementById('task-day-ref').value;
            const title = document.getElementById('task-title').value;
            const tag = document.getElementById('task-tag').value;
            
            if(!title) return;
            
            Store.state.week[day].push({
                id: 't' + Date.now(),
                title,
                tag,
                completed: false,
                pomodoros: 0,
                subtasks: []
            });
            
            document.getElementById('task-title').value = '';
            document.getElementById('task-tag').value = '';
            document.getElementById('modal-task').close();
            Store.save(); UI.renderAll();
        };

        // =================================================================
        // MAPA MENTAL AVANÇADO (Pan & Mobile)
        // =================================================================
        window.MindMap = {
            drag: { active: false, node: null, offset: {x:0, y:0} },
            pan: { active: false, start: {x:0, y:0}, offset: {x:0, y:0} },
            selected: null,
            canvas: null,
            currentMap: null,
            isReadOnly: false,

            init() {
                this.canvas = document.getElementById('mm-viewport');
                const world = document.getElementById('mm-world');
                
                // --- Eventos de Mouse ---
                this.canvas.addEventListener('mousedown', (e) => this.onStart(e));
                window.addEventListener('mousemove', (e) => this.onMove(e));
                window.addEventListener('mouseup', () => this.onEnd());
                
                // --- Eventos de Touch (Mobile) ---
                this.canvas.addEventListener('touchstart', (e) => this.onStart(e), {passive: false});
                window.addEventListener('touchmove', (e) => this.onMove(e), {passive: false});
                window.addEventListener('touchend', () => this.onEnd());

                this.canvas.addEventListener('dblclick', (e) => {
                    if(e.target === this.canvas || e.target.id === 'mm-svg' || e.target.classList.contains('mindmap-bg')) {
                        if(!this.isReadOnly) this.addNodeAt(e.offsetX - this.pan.offset.x, e.offsetY - this.pan.offset.y);
                    }
                });
            },

            // Unifica Mouse e Touch
            getPoint(e) {
                if(e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                return { x: e.clientX, y: e.clientY };
            },

            onStart(e) {
                const pt = this.getPoint(e);
                const target = e.target;
                
                // 1. Verificar se clicou em um NÓ
                const nodeEl = target.closest('.mm-node');
                
                if (nodeEl && !this.isReadOnly) {
                    // Lógica de Nó
                    const rect = nodeEl.getBoundingClientRect();
                    // Área de Resize (canto inferior direito)
                    if (pt.x > rect.right - 20 && pt.y > rect.bottom - 20) {
                        return; // Deixa o navegador fazer o resize nativo
                    }

                    e.stopPropagation();
                    const id = parseInt(nodeEl.id.replace('node-', ''));
                    
                    // CTRL + Click (Conectar)
                    if(e.ctrlKey) {
                        if(this.selected && this.selected !== id) {
                            this.currentMap.lines.push({from: this.selected, to: id});
                            this.selected = null;
                            UI.toast("Conectado!");
                        } else {
                            this.selected = id;
                            UI.toast("Selecione outro para conectar");
                        }
                    } else {
                        // Iniciar Arrasto do Nó
                        this.selected = id;
                        const n = this.currentMap.nodes.find(node => node.id === id);
                        if(n && n.color) document.getElementById('mm-color-picker').value = n.color;

                        this.drag.active = true;
                        this.drag.node = n;
                        
                        // Offset relativo ao mundo (considerando o pan atual)
                        // Posição Real do Mouse no Mundo = (MouseClient - CanvasRect) - PanOffset
                        const canvasRect = this.canvas.getBoundingClientRect();
                        const worldMouseX = pt.x - canvasRect.left - this.pan.offset.x;
                        const worldMouseY = pt.y - canvasRect.top - this.pan.offset.y;
                        
                        this.drag.offset = {
                            x: worldMouseX - n.x,
                            y: worldMouseY - n.y
                        };
                    }
                    this.render();
                } else {
                    // 2. Clicou no Fundo -> Pan (Mover câmera)
                    this.selected = null;
                    this.pan.active = true;
                    this.pan.start = { x: pt.x - this.pan.offset.x, y: pt.y - this.pan.offset.y };
                    this.render();
                }
            },

            onMove(e) {
                const pt = this.getPoint(e);
                
                if (this.drag.active && this.drag.node) {
                    e.preventDefault(); // Evita scroll no mobile
                    const canvasRect = this.canvas.getBoundingClientRect();
                    const worldMouseX = pt.x - canvasRect.left - this.pan.offset.x;
                    const worldMouseY = pt.y - canvasRect.top - this.pan.offset.y;

                    this.drag.node.x = worldMouseX - this.drag.offset.x;
                    this.drag.node.y = worldMouseY - this.drag.offset.y;
                    this.render();
                } 
                else if (this.pan.active) {
                    e.preventDefault();
                    this.pan.offset.x = pt.x - this.pan.start.x;
                    this.pan.offset.y = pt.y - this.pan.start.y;
                    this.updateWorldTransform();
                }
            },

            onEnd() {
                if (this.drag.active) {
                    this.drag.active = false;
                    this.drag.node = null;
                    Store.save();
                }
                if (this.pan.active) {
                    this.pan.active = false;
                }
                // Check resize
                if(this.selected) {
                    const el = document.getElementById(`node-${this.selected}`);
                    const n = this.currentMap.nodes.find(node => node.id === this.selected);
                    if(el && n && (el.offsetWidth !== n.width || el.offsetHeight !== n.height)) {
                        n.width = el.offsetWidth;
                        n.height = el.offsetHeight;
                        Store.save();
                        this.render();
                    }
                }
            },

            updateWorldTransform() {
                const world = document.getElementById('mm-world');
                if(world) world.style.transform = `translate(${this.pan.offset.x}px, ${this.pan.offset.y}px)`;
            },

            render() {
                if(!this.currentMap) return;
                const l = document.getElementById('mm-nodes-layer');
                const svg = document.getElementById('mm-svg');
                const nodes = this.currentMap.nodes || [];
                const lines = this.currentMap.lines || [];

                if(svg) {
                    svg.innerHTML = lines.map(line => {
                        const n1 = nodes.find(n => n.id === line.from);
                        const n2 = nodes.find(n => n.id === line.to);
                        if(n1 && n2) {
                            // Calcula o centro baseado no tamanho salvo ou padrão
                            const w1 = parseInt(n1.width) || 140; const h1 = parseInt(n1.height) || 60;
                            const w2 = parseInt(n2.width) || 140; const h2 = parseInt(n2.height) || 60;
                            return `<line x1="${n1.x + w1/2 + 5000}" y1="${n1.y + h1/2 + 5000}" x2="${n2.x + w2/2 + 5000}" y2="${n2.y + h2/2 + 5000}" stroke="#94a3b8" stroke-width="2" />`;
                        }
                        return '';
                    }).join('');
                }

                if(l) {
                    l.innerHTML = nodes.map(n => {
                        const isSelected = this.selected === n.id;
                        // Força a borda transparente se não selecionado para ficar bonito com cor cheia
                        const borderStyle = isSelected ? `border-color: var(--text-main);` : `border-color: transparent;`;
                        const bgStyle = `background-color: ${n.color || 'var(--brand-500)'};`;
                        // APLICA O TAMANHO SALVO AQUI
                        const sizeStyle = n.width ? `width:${n.width}px; height:${n.height}px;` : '';
                        
                        return `
                        <div id="node-${n.id}" class="mm-node ${isSelected ? 'selected' : ''}" 
                             style="transform: translate(${n.x}px, ${n.y}px); ${bgStyle} ${borderStyle} ${sizeStyle}"
                             onmousedown="MindMap.onNodeDown(event, ${n.id})"
                             onmouseup="MindMap.onNodeUp(event, ${n.id})">
                            <textarea oninput="MindMap.updateText(${n.id}, this.value)" onmousedown="event.stopPropagation()">${n.text}</textarea>
                        </div>`;
                    }).join('');
                }
            },

            // 2. Impede que o arraste comece se você clicar na pontinha de redimensionar
            onNodeDown(e, id) {
                const el = e.currentTarget;
                const rect = el.getBoundingClientRect();
                // Se clicar nos ultimos 20px (canto inferior direito), é resize, não drag
                if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) {
                    e.stopPropagation();
                    return; 
                }

                e.stopPropagation();
                // Lógica de Conexão com CTRL
                if(e.ctrlKey) {
                    if(this.selected && this.selected !== id) {
                        this.currentMap.lines.push({from: this.selected, to: id});
                        this.selected = null;
                        UI.toast("Conectado!");
                    } else {
                        this.selected = id;
                        UI.toast("Selecione outro para conectar");
                    }
                    this.render();
                    return;
                }

                // Inicia Drag
                this.selected = id;
                const n = this.currentMap.nodes.find(node => node.id === id);
                if(n && n.color) document.getElementById('mm-color-picker').value = n.color;

                this.drag.active = true;
                this.drag.node = n;
                
                const canvasRect = this.canvas.getBoundingClientRect();
                const worldMouseX = (e.touches ? e.touches[0].clientX : e.clientX) - canvasRect.left - this.pan.offset.x;
                const worldMouseY = (e.touches ? e.touches[0].clientY : e.clientY) - canvasRect.top - this.pan.offset.y;
                
                this.drag.offset = { x: worldMouseX - n.x, y: worldMouseY - n.y };
                this.render();
            },

            // 3. SALVA O NOVO TAMANHO QUANDO VOCÊ SOLTA O MOUSE
            onNodeUp(e, id) {
                const el = document.getElementById(`node-${id}`);
                const n = this.currentMap.nodes.find(node => node.id === id);
                
                if(el && n) {
                    // Verifica se o tamanho visual (offsetWidth) é diferente do salvo
                    if(el.offsetWidth !== n.width || el.offsetHeight !== n.height) {
                        n.width = el.offsetWidth;
                        n.height = el.offsetHeight;
                        Store.save(); // Salva no banco
                        this.render(); // Redesenha para ajustar as linhas
                    }
                }
            },

            toggleViewMode() {
                this.isReadOnly = !this.isReadOnly;
                const ws = document.getElementById('mm-workspace');
                const btn = document.getElementById('btn-mm-view');
                const indicator = document.getElementById('indicator-readonly');
                
                if(this.isReadOnly) {
                    ws.classList.add('readonly');
                    btn.classList.add('bg-brand-100', 'text-brand-700');
                    indicator.classList.remove('hidden');
                    UI.toast("Modo Visualização Ativado");
                } else {
                    ws.classList.remove('readonly');
                    btn.classList.remove('bg-brand-100', 'text-brand-700');
                    indicator.classList.add('hidden');
                    UI.toast("Modo Edição");
                }
            },

            renderExplorer() {
                const list = document.getElementById('mm-list');
                const maps = Store.state.mindmaps || [];
                const grouped = maps.reduce((acc, map) => {
                    const subj = map.subject || 'Geral';
                    if(!acc[subj]) acc[subj] = [];
                    acc[subj].push(map); return acc;
                }, {});

                if(maps.length === 0) { list.innerHTML = `<div class="col-span-full text-center py-12 opacity-50">Nenhum mapa criado.</div>`; return; }

                let html = '';
                for(const [subj, items] of Object.entries(grouped)) {
                    html += `<div class="col-span-full font-bold text-xs text-txt-muted uppercase mt-4 mb-2 tracking-wider">${subj}</div>`;
                    items.forEach(map => {
                        html += `
                        <div class="bg-card p-6 rounded-2xl border border-slate-200/10 hover:border-brand-300 hover:shadow-lg transition-all group flex flex-col h-48 relative">
                             <div onclick="MindMap.open('${map.id}', false)" class="flex-1 flex items-center justify-center opacity-20 group-hover:opacity-40 transition-opacity cursor-pointer">
                                <i class="ph-fill ph-tree-structure text-5xl text-brand-500"></i>
                             </div>
                             <div class="mt-4 mb-3">
                                <h3 class="font-bold text-txt-main truncate">${map.name}</h3>
                                <p class="text-xs text-txt-muted">${new Date(map.createdAt).toLocaleDateString()}</p>
                             </div>
                             <div class="flex gap-2 mt-auto">
                                <button id="btn-mm-view" onclick="MindMap.open('${map.id}', true)" class="flex-1 bg-bg-main hover:bg-brand-50 text-brand-600 py-2 rounded-lg text-xs font-bold transition-colors border border-slate-100">
                                    <i class="ph-bold ph-eye"></i> Ver
                                </button>
                                <button onclick="MindMap.open('${map.id}', false)" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-2 rounded-lg text-xs font-bold transition-colors">
                                    <i class="ph-bold ph-pencil-simple"></i> Editar
                                </button>
                             </div>
                        </div>`;
                    });
                }
                list.innerHTML = html;
            },
            
            create() {
                const name = document.getElementById('map-name').value;
                const subject = document.getElementById('map-subject').value;
                if(!name) return;
                const newMap = { id: 'map-' + Date.now(), name, subject: subject || 'Geral', createdAt: Date.now(), nodes: [{id: 1, x: 300, y: 200, text: name, color: '#2563eb'}], lines: [] };
                Store.state.mindmaps.push(newMap); Store.save();
                document.getElementById('map-name').value = ''; document.getElementById('map-subject').value = '';
                document.getElementById('modal-create-map').close();
                this.renderExplorer(); this.open(newMap.id, false);
            },
            
            open(id, readOnly = false) {
                this.currentMap = Store.state.mindmaps.find(m => m.id === id);
                if(!this.currentMap) return;
                
                document.getElementById('mm-explorer').classList.add('hidden');
                document.getElementById('mm-workspace').classList.remove('hidden');
                document.getElementById('mm-current-title').innerText = this.currentMap.name;
                document.getElementById('mm-current-subject').innerText = this.currentMap.subject;
                
                // Set ReadOnly State explicitly
                this.isReadOnly = readOnly;
                const ws = document.getElementById('mm-workspace');
                const btn = document.getElementById('btn-mm-view');
                const indicator = document.getElementById('indicator-readonly');
                
                if(this.isReadOnly) {
                    ws.classList.add('readonly');
                    btn.classList.add('bg-brand-100', 'text-brand-700');
                    indicator.classList.remove('hidden');
                    document.getElementById('keys-map').classList.add('hidden');

                } else {
                    ws.classList.remove('readonly');
                    btn.classList.remove('bg-brand-100', 'text-brand-700');
                    indicator.classList.add('hidden');
                    document.getElementById('keys-map').classList.remove('hidden');
                }

                this.pan.offset = {x:0, y:0}; this.updateWorldTransform(); // Reset Cam
                this.render();
            },
            
            close() {
                this.currentMap = null;
                document.getElementById('mm-workspace').classList.add('hidden');
                document.getElementById('mm-explorer').classList.remove('hidden');
                document.getElementById('keys-map').classList.remove('hidden');
                this.renderExplorer();
            },
            
            deleteMap() {
                if(!this.currentMap) return;
                if(confirm(`Excluir permanentemente "${this.currentMap.name}"?`)) {
                    Store.state.mindmaps = Store.state.mindmaps.filter(m => m.id !== this.currentMap.id);
                    Store.save(); this.close();
                }
            },
            addNode() { this.addNodeAt(300 - this.pan.offset.x, 300 - this.pan.offset.y); },
            addNodeAt(x, y) {
                if(!this.currentMap) return;
                const color = document.getElementById('mm-color-picker').value;
                this.currentMap.nodes.push({ id: Date.now(), x: x - 70, y: y - 25, text: 'Nova Ideia', color: color, width: 140, height: 60 });
                Store.save(); this.render();
            },
            
            deleteSelectedNode() {
                if (this.selected && this.currentMap) {
                    this.currentMap.lines = this.currentMap.lines.filter(l => l.from !== this.selected && l.to !== this.selected);
                    this.currentMap.nodes = this.currentMap.nodes.filter(n => n.id !== this.selected);
                    
                    this.selected = null;
                    Store.save();
                    this.render();
                    UI.toast("Nó removido.");
                } else {
                    UI.toast("Selecione um nó para remover.");
                }
            },
            updateText(id, txt) { const n = this.currentMap.nodes.find(n => n.id === id); if(n) n.text = txt; },
            updateColor(color) { if(this.selected && this.currentMap) { const n = this.currentMap.nodes.find(n => n.id === this.selected); if(n) { n.color = color; this.render(); Store.save(); } } },
            save() { Store.save(); UI.toast("Mapa salvo!"); }
        };
        setTimeout(() => MindMap.init(), 500);

        // =================================================================
        // LIXEIRA & SETTINGS
        // =================================================================
        window.Trash = {
            add(item, type, context) {
                Store.state.trash.push({ item, type, context, dateDeleted: Date.now() });
                Store.save();
            },
            restore(index) {
                const trashItem = Store.state.trash[index];
                if(trashItem.type === 'task') {
                    if(!Store.state.week[trashItem.context]) Store.state.week[trashItem.context] = [];
                    Store.state.week[trashItem.context].push(trashItem.item);
                    UI.toast("Tarefa restaurada!");
                }
                Store.state.trash.splice(index, 1);
                Store.save();
                this.open(); // Re-render modal
                UI.renderAll();
            },
            open() {
                const c = document.getElementById('trash-container');
                if(Store.state.trash.length === 0) c.innerHTML = '<p class="text-center text-xs text-txt-muted py-4">Lixeira Vazia.</p>';
                else c.innerHTML = Store.state.trash.map((t, i) => `
                    <div class="flex justify-between items-center p-2 border-b border-slate-100 text-xs" style="color: var(--text-main);">
                        <div><span class="font-bold ">${t.type}:</span> ${t.item.title || 'Item'}</div>
                        <div class="flex items-center gap-2">
                            <span class="text-txt-muted">${new Date(t.dateDeleted).toLocaleTimeString()}</span>
                            <button onclick="Trash.restore(${i})" class="text-brand-600 hover:bg-brand-50 p-1 rounded" title="Restaurar"><i class="ph-bold ph-arrow-u-up-left"></i></button>
                        </div>
                    </div>`).join('');
                document.getElementById('modal-trash').showModal();
            },
            empty() { Store.state.trash = []; Store.save(); this.open(); }
        };

        window.Settings = {
            setTheme(t) {
                Store.state.settings.theme = t;
                document.body.className = `h-screen w-screen font-sans theme-${t}`;
                if(t === 'light') document.body.classList.remove('theme-light');
                Store.save();
            },
            tab(id) {
                document.querySelectorAll('.sett-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('tab-'+id).classList.remove('hidden');
                // Fix: Highlight active tab
                document.querySelectorAll('.sett-tab').forEach(b => b.classList.remove('active-sett-tab'));
                document.getElementById('tab-btn-'+id).classList.add('active-sett-tab');
            },
            saveCloud() {
                // Deprecated manual config
                UI.toast("Configuração automática ativa.");
            },
            hardReset() { if(confirm("CERTEZA ABSOLUTA?")) { localStorage.clear(); location.reload(); } }
        };

        // =================================================================
        // QUIZ IMPORT JSON
        // =================================================================
        // =================================================================
        // QUIZ IMPORT JSON
        // =================================================================
        window.Quiz = {
            render() {
                const list = document.getElementById('quiz-list');
                const search = document.getElementById('q-search').value.toLowerCase();
                const filtered = Store.state.quiz.filter(q => q.text.toLowerCase().includes(search));
                
                // ATUALIZAR GRÁFICO SEMPRE (Mesmo se lista vazia)
                this.updateChart();
                
                if(filtered.length === 0) { 
                    list.innerHTML = `<div class="text-center py-10 opacity-50">Sem questões. Importe alguma!</div>`; 
                    return; 
                }
                
                list.innerHTML = filtered.map((q) => `
                    <div class="bg-card p-5 rounded-2xl border border-slate-200/10 shadow-sm relative group">
                        <button onclick="Quiz.delete('${q.id}')" class="absolute top-3 right-3 p-2 text-txt-muted hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity z-10" title="Excluir Questão">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                        <div class="mb-3"><span class="text-[10px] uppercase font-bold bg-brand-50 text-brand-600 px-2 py-1 rounded">${q.topic}</span></div>
                        <p class="font-bold text-txt-main mb-4 text-sm leading-relaxed pr-8">${q.text}</p>
                        <div class="space-y-2">
                            ${q.options.map((opt, i) => `
                                <button onclick="Quiz.answer('${q.id}', ${i}, this)" class="w-full text-left p-3 rounded-xl border border-slate-200/10 hover:bg-brand-50 transition-all text-sm text-txt-muted flex gap-3 group">
                                    <span class="w-6 h-6 rounded bg-bg-main border border-slate-200 flex items-center justify-center text-xs font-bold group-hover:bg-brand-500 group-hover:text-white uppercase">${String.fromCharCode(97+i)}</span>
                                    <span>${opt}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>`).join('');
            },
            
            delete(id) {
                if(confirm("Tem certeza que deseja excluir esta questão?")) {
                    // Correção de Estatísticas (Acertos/Erros)
                    if(Store.state.quizHistory) {
                        const related = Store.state.quizHistory.filter(h => h.qId == id);
                        
                        // Subtrai do placar o que foi ganho/perdido com essa questão
                        related.forEach(h => {
                            if(h.result === 'hit') Store.state.stats.hits = Math.max(0, Store.state.stats.hits - 1);
                            if(h.result === 'miss') Store.state.stats.misses = Math.max(0, Store.state.stats.misses - 1);
                        });

                        // Limpa do histórico
                        Store.state.quizHistory = Store.state.quizHistory.filter(h => h.qId != id);
                    }

                    Store.state.quiz = Store.state.quiz.filter(q => q.id != id);

                    // RESET TOTAL se não houver mais questões
                    if(Store.state.quiz.length === 0) {
                        Store.state.stats.hits = 0;
                        Store.state.stats.misses = 0;
                        Store.state.quizHistory = [];
                    }

                    Store.save();
                    this.render();
                    UI.toast("Questão removida.");
                }
            },

            processImport() {
                const text = document.getElementById('import-area').value.trim();
                const subject = document.getElementById('import-subject').value || 'Geral';
                
                // Tenta importar como JSON
                try {
                    if(text.startsWith('[') || text.startsWith('{')) {
                        const data = JSON.parse(text);
                        const items = Array.isArray(data) ? data : [data];
                        let count = 0;
                        items.forEach(item => {
                            if(item.text && item.options) {
                                // CORREÇÃO DE INDEX (1-based input -> 0-based internal)
                                // Se o usuário coloca "2", ele quer a 2ª opção (B), que é index 1.
                                // Se coloca "1", quer A (index 0).
                                let rawIndex = (item.correctIndex !== undefined) ? parseInt(item.correctIndex) : 1;
                                // Garante que seja pelo menos 1 antes de subtrair
                                if(rawIndex < 1) rawIndex = 1;
                                
                                Store.state.quiz.push({
                                    id: Date.now() + Math.random(),
                                    topic: item.topic || subject,
                                    text: item.text,
                                    options: item.options,
                                    correctIndex: rawIndex - 1
                                });
                                count++;
                            }
                        });
                        UI.toast(`Importadas ${count} questões via JSON!`);
                        finishImport(); return;
                    }
                } catch(e) { console.log("Não é JSON, tentando texto..."); }

                // Parser Texto (Fallback)
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                if(lines.length === 0) return;
                let questionText = lines[0]; let options = [];
                const optRegex = /^[a-eA-E][).]\s*(.*)/;
                lines.forEach((line, i) => {
                    if(i === 0) return;
                    const match = line.match(optRegex);
                    if(match) options.push(match[1]); else if(options.length === 0) questionText += " " + line; 
                });
                if(options.length < 2) options = ["Verdadeiro", "Falso"];
                
                Store.state.quiz.push({ 
                    id: Date.now(), 
                    topic: subject, 
                    text: questionText, 
                    options: options, 
                    correctIndex: 0 
                });
                finishImport();

                function finishImport() {
                    document.getElementById('modal-import').close();
                    document.getElementById('import-area').value = '';
                    Store.save(); UI.renderAll();
                }
            },

            answer(qId, optIdx, btn) {
                // Busca a questão pelo ID para garantir consistência
                const question = Store.state.quiz.find(q => q.id == qId);
                if (!question) return;

                const isCorrect = (optIdx === question.correctIndex);
                
                // Grava no histórico para permitir rollback se deletar
                if(!Store.state.quizHistory) Store.state.quizHistory = [];
                Store.state.quizHistory.push({ qId: qId, result: isCorrect ? 'hit' : 'miss' });

                const parent = btn.parentNode;
                parent.querySelectorAll('button').forEach(b => { b.disabled = true; b.classList.add('opacity-50'); });
                btn.classList.remove('opacity-50');
                
                if(isCorrect) {
                    btn.classList.add('bg-emerald-100', 'border-emerald-500', 'text-emerald-700');
                    Store.state.stats.hits++; 
                    Store.state.user.xp += 15; 
                    UI.toast("Correto! +15XP", "success");
                } else {
                    btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                    Store.state.stats.misses++;
                    
                    // Mostra a correta
                    const correctBtn = parent.children[question.correctIndex];
                    if(correctBtn) {
                        correctBtn.classList.remove('opacity-50');
                        correctBtn.classList.add('bg-emerald-100', 'border-emerald-500');
                    }
                    
                    UI.toast("Incorreto", "error");
                }
                Store.save(); this.updateChart();
            },

            updateChart() {
                const ctx = document.getElementById('chart-performance');
                if(!ctx) return;
                if(window.perfChart) window.perfChart.destroy();
                
                document.getElementById('stat-hits').innerText = Store.state.stats.hits;
                document.getElementById('stat-misses').innerText = Store.state.stats.misses;
                
                window.perfChart = new Chart(ctx, { 
                    type: 'doughnut', 
                    data: { 
                        labels: ['Acertos', 'Erros'], 
                        datasets: [{ 
                            data: [Store.state.stats.hits, Store.state.stats.misses], 
                            backgroundColor: ['#10b981', '#ef4444'], 
                            borderWidth: 0, 
                        }] 
                    }, 
                    options: { cutout: '75%', plugins: { legend: { display: false } } } 
                });
            }
        };

        window.openTrash = () => Trash.open();
        // Resto dos utils permanece...
        window.router = (view) => {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+view).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('bg-brand-50', 'text-brand-600'));
            document.getElementById('nav-'+view).classList.add('bg-brand-50', 'text-brand-600');
            if(window.innerWidth < 1024) toggleSidebar();
            if(view === 'mindmap') setTimeout(() => { MindMap.renderExplorer(); }, 50);
            if(view === 'questoes') Quiz.updateChart();
        };
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('mobile-overlay');
            if (sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); } 
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        };
        window.openSettings = () => document.getElementById('modal-settings').showModal();
        window.toggleUserMenu = () => { const m = document.getElementById('user-menu'); m.classList.toggle('hidden'); m.classList.toggle('flex'); };
        window.toggleZen = () => {
            const sb = document.getElementById('sidebar'); const hdr = document.querySelector('header');
            if(sb.classList.contains('zen-hidden')) { sb.classList.remove('zen-hidden'); hdr.classList.remove('zen-hidden'); } 
            else { sb.classList.add('zen-hidden'); UI.toast("Modo Zen Ativado (Z para sair)"); }
        };
        window.distributePomodoro = () => {
            const min = prompt("Minutos totais para hoje:", "120"); if(!min) return;
            const day = ['domingo','segunda','terca','quarta','quinta','sexta','sabado'][new Date().getDay()];
            const tasks = Store.state.week[day]; if(!tasks || !tasks.length) return alert("Sem tarefas hoje.");
            const perTask = Math.floor(parseInt(min) / tasks.length);
            tasks.forEach(t => t.pomodoros = perTask); Store.save(); UI.renderAll(); UI.toast(`Distribuído: ${perTask}m por tarefa`);
        };
        window.openAnchorModal = () => { const title = prompt("Nome do novo hábito:"); if(title) { Store.state.anchors.push({title, icon: 'star', completed: false}); Store.save(); UI.renderDashboard(); } };
        window.Shop = {
            render() {
                const items = [ { id: 'badge_focus', name: 'Mestre do Foco', price: 500, icon: 'brain', color: 'text-pink-500' }, { id: 'badge_fire', name: 'Imparável', price: 1000, icon: 'fire', color: 'text-orange-500' }, { id: 'badge_king', name: 'Rei dos Estudos', price: 5000, icon: 'crown', color: 'text-yellow-500' } ];
                document.getElementById('shop-grid').innerHTML = items.map(i => {
                    const owned = Store.state.user.inventory.includes(i.id);
                    return `<div class="bg-card p-6 rounded-3xl border ${owned ? 'border-brand-500 bg-brand-50/20' : 'border-slate-200/10'} text-center relative overflow-hidden group"><div class="bg-bg-main w-20 h-20 rounded-full mx-auto flex items-center justify-center mb-4 shadow-inner"><i class="ph-fill ph-${i.icon} text-4xl ${i.color}"></i></div><h3 class="font-bold text-txt-main">${i.name}</h3><p class="text-sm font-bold text-brand-600 mb-4">${i.price} XP</p><button onclick="Shop.buy('${i.id}', ${i.price})" ${owned ? 'disabled' : ''} class="w-full py-2 rounded-xl font-bold text-sm transition-all ${owned ? 'bg-green-500 text-white' : 'bg-brand-600 text-white hover:bg-brand-700'}">${owned ? 'Adquirido' : 'Comprar'}</button></div>`;
                }).join('');
            },
            buy(id, price) {
                if(Store.state.user.xp >= price) { Store.state.user.xp -= price; Store.state.user.inventory.push(id); Store.save(); UI.renderAll(); UI.toast("Item comprado!", "success"); } 
                else { UI.toast("XP Insuficiente", "error"); }
            }
        }
        document.addEventListener('keydown', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if(e.key.toLowerCase() === 'z') toggleZen();
            if(e.key.toLowerCase() === 'n') Actions.openTaskModal(['domingo','segunda','terca','quarta','quinta','sexta','sabado'][new Date().getDay()]);
        });
        Store.init();
    </script>
</body>
</html>
