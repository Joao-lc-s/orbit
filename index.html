<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbit</title>

    <meta name="apple-mobile-web-app-title" content="Orbit">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="https://i.ibb.co/FL1VDQtv/Gemini-Generated-Image-uf01f5uf01f5uf01-1.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/FL1VDQtv/Gemini-Generated-Image-uf01f5uf01f5uf01-1.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace']
                    },
                    colors: {
                        brand: {
                            50: 'var(--brand-50)', 100: 'var(--brand-100)', 200: 'var(--brand-200)',
                            300: 'var(--brand-300)', 400: 'var(--brand-400)', 500: 'var(--brand-500)',
                            600: 'var(--brand-600)', 700: 'var(--brand-700)', 800: 'var(--brand-800)',
                            900: 'var(--brand-900)',
                        },
                        bg: { main: 'var(--bg-main)', panel: 'var(--bg-panel)', card: 'var(--bg-card)', surface: 'var(--bg-surface)' },
                        txt: { main: 'var(--text-main)', muted: 'var(--text-muted)', light: 'var(--text-light)' }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
                        'subtle': '0 2px 10px rgba(0,0,0,0.03)',
                        'float': '0 20px 40px -10px rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');

        /* --- SISTEMA DE CORES REFINADO --- */
        :root {
            /* Light Mode: Clean, Airy, Crisp */
            --bg-main: #f3f4f6;
            --bg-surface: #ffffff;
            --bg-panel: rgba(255, 255, 255, 0.85);
            --bg-card: #ffffff;
            
            --text-main: #111827;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            
            /* Brand: Indigo/Blue Vibrant */
            --brand-50: #eff6ff; --brand-100: #dbeafe; --brand-200: #bfdbfe;
            --brand-300: #93c5fd; --brand-400: #60a5fa; --brand-500: #3b82f6;
            --brand-600: #2563eb; --brand-700: #1d4ed8; --brand-800: #1e40af;
            --brand-900: #1e3a8a;
        }

        .theme-dark {
            /* Dark Mode: Deep Navy, OLED Friendly, High Contrast Text */
            --bg-main: #020617; /* Slate 950 */
            --bg-surface: #0f172a; /* Slate 900 */
            --bg-panel: rgba(15, 23, 42, 0.8);
            --bg-card: #1e293b; /* Slate 800 */
            
            --text-main: #f9fafb;
            --text-muted: #94a3b8;
            --text-light: #475569;

            --brand-50: #1e1b4b; --brand-100: #312e81; --brand-200: #3730a3;
            --brand-300: #4338ca; --brand-400: #4f46e5; --brand-500: #6366f1;
            --brand-600: #818cf8; --brand-700: #a5b4fc; --brand-800: #c7d2fe;
            --brand-900: #e0e7ff;
        }

        /* Outros temas preservados mas modernizados */
        .theme-dracula {
            --bg-main: #282a36; --bg-surface: #44475a; --bg-panel: rgba(68, 71, 90, 0.9); --bg-card: #44475a;
            --text-main: #f8f8f2; --text-muted: #bd93f9;
            --brand-500: #ff79c6; --brand-600: #bd93f9;
        }
        
        .theme-forest {
            --bg-main: #052e16; --bg-surface: #14532d; --bg-panel: rgba(20, 83, 45, 0.9); --bg-card: #166534;
            --text-main: #f0fdf4; --text-muted: #86efac;
            --brand-500: #4ade80; --brand-600: #22c55e;
        }

        /* --- GLOBAL RESET & UTILS --- */
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.5s ease, color 0.3s ease;
            margin: 0;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Glassmorphism Classes */
        .glass {
            background: var(--bg-panel);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .theme-dark .glass {
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Scrollbar Minimalista */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); opacity: 0.2; border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--brand-500); }

        /* --- MAPA MENTAL --- */
        .mindmap-viewport {
            position: relative; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg-main); /* Fundo igual ao main para imersão */
            cursor: grab; touch-action: none;
            border-radius: 24px;
        }
        .mindmap-viewport:active { cursor: grabbing; }
        .mindmap-world {
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0; will-change: transform;
        }
        .mindmap-bg {
            position: absolute; top: -5000px; left: -5000px; width: 10000px; height: 10000px;
            background-image: radial-gradient(var(--text-muted) 1.5px, transparent 1.5px);
            background-size: 40px 40px; opacity: 0.15; pointer-events: none;
        }

        .mm-node {
            position: absolute; min-width: 75px; min-height: 75px; padding: 16px;
            background-color: var(--bg-card);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 16px;
            box-shadow: var(--shadow-float), 0 4px 6px rgba(0,0,0,0.02);
            -webkit-user-select: none; user-select: none;
            transition: box-shadow 0.2s;
            cursor: grab; display: flex; flex-direction: column; align-items: center; justify-content: center;
            resize: both; overflow: hidden; z-index: 10;
        }
        
        .theme-dark .mm-node { border: 1px solid rgba(255,255,255,0.1); }
        .mm-node:hover { transform: translateY(-4px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); z-index: 11; }
        .mm-node:active { cursor: grabbing; }
        .mm-node.selected { 
            box-shadow: 0 0 0 3px var(--brand-500), 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
            z-index: 50 !important; border-color: transparent;
        }
        .mm-node textarea {
            background: transparent; width: 100%; height: 100%; resize: none; outline: none; border: none;
            font-weight: 600; text-align: center; font-family: inherit; color: var(--text-main); font-size: 0.95rem;
        }

        /* SVG Connections */
        #mm-svg { width: 10000px; height: 10000px; transform: translate(-5000px, -5000px); pointer-events: none; }
        #mm-svg path { stroke-width: 2px; stroke: var(--text-muted); opacity: 0.4; transition: stroke 0.3s; }

        /* --- UI HELPERS --- */
        .active-nav { 
            background-color: var(--brand-50); 
            color: var(--brand-700); 
            font-weight: 700;
        }

        .readonly .mm-toolbar { display: none !important; }

        .readonly .mm-node { 
            resize: none !important; 
            cursor: default !important;
            pointer-events: none !important;
        }
        
        .readonly .mm-node textarea {
            pointer-events: none !important;
        }
        
        .readonly .mm-node::-webkit-resizer { display: none; }
        
        .theme-dark .active-nav {
            background-color: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
        }
        .active-nav i { color: var(--brand-600); }
        .theme-dark .active-nav i { color: #818cf8; }

        /* Caderno de Redação - Visual Realista Moderno */
        .notebook-sheet {
            width: 100%; height: 100%;
            font-family: 'JetBrains Mono', monospace; font-size: 15px; line-height: 32px;
            padding: 32px 32px 32px 70px;
            color: var(--text-main); background-color: var(--bg-surface);
            border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);
            resize: none; outline: none;
            background-image: 
                linear-gradient(90deg, transparent 59px, #ef4444 59px, #ef4444 60px, transparent 60px),
                linear-gradient(transparent 31px, rgba(0,0,0,0.05) 31px);
            background-size: 100% 100%, 100% 32px; background-attachment: local;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
        }
        .theme-dark .notebook-sheet {
            background-image: 
                linear-gradient(90deg, transparent 59px, #7f1d1d 59px, #7f1d1d 60px, transparent 60px),
                linear-gradient(transparent 31px, rgba(255,255,255,0.05) 31px);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* 3D Flashcards */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Utilitários */
        .zen-hidden { display: none !important; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--brand-500);}
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-sm md:text-base selection:bg-brand-500 selection:text-white">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[100] bg-bg-main flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative w-24 h-24">
            <div class="absolute inset-0 rounded-full border-4 border-brand-100 opacity-20"></div>
            <div class="absolute inset-0 rounded-full border-4 border-t-brand-600 border-r-transparent border-b-transparent border-l-transparent animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="ph-fill ph-planet text-4xl text-brand-600 animate-pulse-slow"></i>
            </div>
        </div>
        <h2 class="mt-6 text-3xl font-extrabold tracking-tight text-txt-main">ORBIT</h2>
        <p class="text-xs font-medium text-txt-muted mt-2 tracking-widest uppercase" id="loading-text">Inicializando...</p>
    </div>

    <div id="app-layout" class="flex h-full w-full opacity-0 transition-opacity duration-700">
        
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 hidden lg:hidden transition-opacity duration-300"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-[280px] bg-bg-surface glass border-r border-white/5 flex flex-col z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl lg:shadow-none">
            <!-- Brand -->
            <div class="h-24 flex items-center px-8 shrink-0">
                <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
                    <i class="ph-bold ph-planet text-xl"></i>
                </div>
                <div class="ml-4">
                    <h1 class="font-extrabold text-xl text-txt-main tracking-tight">Orbit</h1>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <p class="text-[10px] uppercase font-bold text-txt-muted tracking-widest">Pro</p>
                    </div>
                </div>
                <button title="fechar/abrir barra lateral" onclick="toggleSidebar()" class="ml-auto lg:hidden p-2 text-txt-muted hover:text-brand-600 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto px-4 py-2 space-y-1 custom-scrollbar">
                <p class="px-4 text-[10px] font-bold text-txt-light uppercase tracking-widest mb-2 mt-2">Workspace</p>
                
                <button onclick="router('dashboard')" id="nav-dashboard" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-squares-four text-lg mr-3 group-hover:scale-110 transition-transform"></i> Visão Geral
                </button>
                <button onclick="router('cronograma')" id="nav-cronograma" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-calendar-check text-lg mr-3 group-hover:scale-110 transition-transform"></i> Cronograma
                    <span id="badge-tasks" class="ml-auto text-[10px] bg-brand-500 text-white px-2 py-0.5 rounded-full font-bold shadow-sm hidden">0</span>
                </button>
                <button onclick="router('mindmap')" id="nav-mindmap" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-tree-structure text-lg mr-3 group-hover:scale-110 transition-transform"></i> Mapa Mental
                </button>
                <button onclick="Whiteboard.open()" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph-bold ph-scribble-loop text-lg mr-3 group-hover:scale-110 transition-transform"></i> Whiteboard
                </button>

                <p class="px-4 text-[10px] font-bold text-txt-light uppercase tracking-widest mb-2 mt-6">Estudo</p>
                
                <button onclick="router('foco')" id="nav-foco" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-timer text-lg mr-3 group-hover:scale-110 transition-transform"></i> Foco
                </button>
                <button onclick="router('questoes')" id="nav-questoes" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-graduation-cap text-lg mr-3 group-hover:scale-110 transition-transform"></i> Vestibular
                </button>
                <button onclick="router('flashcards')" id="nav-flashcards" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-cards text-lg mr-3 group-hover:scale-110 transition-transform"></i> Flashcards
                </button>
                <button onclick="router('redacao')" id="nav-redacao" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-pen-nib text-lg mr-3 group-hover:scale-110 transition-transform"></i> Redação
                </button>
                <button onclick="router('simulado')" id="nav-simulado" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-timer text-lg mr-3 group-hover:scale-110 transition-transform"></i> Simulado
                </button>
                <button onclick="router('loja')" id="nav-loja" class="w-full flex items-center px-4 py-3 rounded-xl text-txt-muted hover:bg-brand-50 hover:text-brand-700 transition-all font-medium text-sm group">
                    <i class="ph ph-storefront text-lg mr-3 group-hover:scale-110 transition-transform"></i> Loja
                </button>
            </nav>

            <!-- User Profile -->
            <div class="p-4 border-t border-white/5 bg-bg-surface/50 relative">
                <button onclick="toggleUserMenu()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-bg-main transition-colors group">
                    <div class="relative">
                        <img title="Perfil" id="user-avatar" src="https://ui-avatars.com/api/?name=Estudante&background=random" class="w-10 h-10 rounded-full border-2 border-brand-200 group-hover:border-brand-500 transition-colors">
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-bg-surface rounded-full"></span>
                    </div>
                    <div class="flex-1 min-w-0 text-left">
                        <p id="user-name" class="text-sm font-bold text-txt-main truncate">Visitante</p>
                        <p class="text-xs text-txt-muted truncate">Estudante</p>
                    </div>
                    <i class="ph-bold ph-caret-up text-txt-muted group-hover:text-brand-600"></i>
                </button>

                <!-- Popover Menu -->
                <div id="user-menu" class="absolute bottom-[85px] left-4 right-4 bg-bg-surface rounded-2xl shadow-float border border-white/10 hidden flex-col overflow-hidden animate-scale-in origin-bottom z-50 ring-1 ring-black/5">
                    <div class="px-4 py-3 border-b border-white/5 bg-bg-main/50">
                        <p class="text-[10px] font-bold text-txt-muted uppercase tracking-wider">Gerenciar</p>
                    </div>
                    <div class="p-2 space-y-1">
                        <button onclick="openSettings()" class="w-full px-3 py-2.5 rounded-lg text-sm text-txt-main hover:bg-brand-50 hover:text-brand-700 flex items-center gap-3 text-left transition-colors">
                            <i class="ph-bold ph-gear"></i> Ajustes
                        </button>
                        <button onclick="openSettings(), Settings.tab('data')" class="w-full px-3 py-2.5 rounded-lg text-sm text-txt-main hover:bg-brand-50 hover:text-brand-700 flex items-center gap-3 text-left transition-colors">
                            <i class="ph-bold ph-cloud"></i> Dados & API
                        </button>
                        <button onclick="openTrash()" class="w-full px-3 py-2.5 rounded-lg text-sm text-txt-main hover:bg-red-50 hover:text-red-600 flex items-center gap-3 text-left transition-colors">
                            <i class="ph-bold ph-trash"></i> Lixeira
                        </button>
                        <div class="h-px bg-white/10 my-1 mx-2"></div>
                        <button onclick="Auth.login()" id="btn-auth" class="w-full px-3 py-2.5 rounded-lg text-sm text-brand-600 font-bold hover:bg-brand-50 flex items-center justify-between text-left transition-colors">
                            <span>Login</span> <i class="ph-bold ph-sign-in"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 min-w-0 flex flex-col h-full relative overflow-hidden bg-bg-main transition-colors duration-500">
            
            <!-- Topbar -->
            <header class="h-20 px-6 md:px-8 flex items-center justify-between z-30 shrink-0 bg-transparent">
                <div class="flex items-center gap-4">
                    <button title="Menu" id="sidebarMenu" onclick="toggleSidebar()" class="lg:hidden p-2.5 text-txt-main rounded-xl bg-bg-surface shadow-subtle hover:scale-105 transition-transform"><i class="ph-bold ph-list text-lg"></i></button>
                    <div>
                        <h2 id="page-title" class="text-2xl font-extrabold text-txt-main tracking-tight leading-none">Dashboard</h2>
                        <p id="current-date" class="text-xs font-medium text-txt-muted mt-1 opacity-80 hidden md:block">Carregando data...</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="toggleZen()" class="w-10 h-10 rounded-full bg-bg-surface border border-white/5 text-txt-muted hover:text-brand-600 hover:shadow-subtle transition-all flex items-center justify-center" title="Modo Zen">
                        <i class="ph-fill ph-arrows-out-simple"></i>
                    </button>
                    <div class="flex items-center gap-2 bg-bg-surface px-4 py-2 rounded-full shadow-subtle border border-white/5">
                        <i class="ph-fill ph-star text-yellow-400 drop-shadow-sm"></i>
                        <span id="display-xp" class="font-bold text-txt-main text-sm">0 XP</span>
                    </div>
                </div>
            </header>

            <!-- Scroll Area -->
            <div id="content-scroll" class="flex-1 overflow-y-auto px-6 md:px-8 pb-8 scroll-smooth relative">
                
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="space-y-8 max-w-7xl mx-auto animate-slide-up">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Stats 1 -->
                        <div class="bg-bg-surface p-6 rounded-3xl border border-white/5 shadow-subtle relative overflow-hidden group hover:translate-y-[-2px] transition-all duration-300">
                            <div class="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-fire text-8xl text-orange-500"></i></div>
                            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-500/20 rounded-2xl flex items-center justify-center text-orange-600 dark:text-orange-400 mb-4">
                                <i class="ph-fill ph-fire text-2xl"></i>
                            </div>
                            <p class="text-txt-light text-xs font-bold uppercase tracking-wider">Sequência</p>
                            <h3 id="stat-streak" class="text-3xl font-bold text-txt-main mt-1">0 Dias</h3>
                            <div class="mt-2 inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-orange-50 dark:bg-orange-500/10 text-orange-600 dark:text-orange-400 text-[10px] font-bold">
                                <i class="ph-bold ph-trend-up"></i> Continue assim!
                            </div>
                        </div>

                        <!-- Stats 2 -->
                        <div class="bg-bg-surface p-6 rounded-3xl border border-white/5 shadow-subtle relative overflow-hidden group hover:translate-y-[-2px] transition-all duration-300">
                             <div class="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-check-circle text-8xl text-emerald-500"></i></div>
                             <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-500/20 rounded-2xl flex items-center justify-center text-emerald-600 dark:text-emerald-400 mb-4">
                                <i class="ph-fill ph-check-circle text-2xl"></i>
                            </div>
                            <p class="text-txt-light text-xs font-bold uppercase tracking-wider">Produtividade</p>
                            <h3 id="stat-tasks-done" class="text-3xl font-bold text-txt-main mt-1">0/0</h3>
                            <p class="text-xs text-txt-muted mt-2">Tarefas finalizadas hoje</p>
                        </div>

                        <!-- Level Card -->
                        <div class="bg-gradient-to-br from-brand-600 to-brand-800 p-6 rounded-3xl text-white shadow-xl shadow-brand-500/20 relative overflow-hidden group">
                            <div class="relative z-10">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-brand-200 text-xs font-bold uppercase tracking-wider">Nível Atual</p>
                                        <h3 id="stat-level" class="text-3xl font-extrabold mt-1">Iniciante</h3>
                                    </div>
                                    <span id="stat-xp-detail" class="text-xs font-mono bg-white/20 px-2 py-1 rounded backdrop-blur-sm">0/1000 XP</span>
                                </div>
                                <div class="w-full bg-black/20 h-2 mt-6 rounded-full overflow-hidden">
                                    <div id="xp-bar" class="bg-white h-full shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-1000 w-0"></div>
                                </div>
                            </div>
                            <i class="ph-fill ph-medal absolute -bottom-6 -right-6 text-[9rem] text-white opacity-10 rotate-12 group-hover:rotate-0 transition-transform duration-500"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Anchors -->
                            <section>
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-txt-main flex items-center gap-2"><i class="ph-fill ph-anchor-simple text-brand-500"></i> Hábitos</h3>
                                    <button onclick="openAnchorModal()" class="text-xs font-bold bg-bg-surface border border-white/5 text-txt-muted hover:text-brand-600 px-4 py-2 rounded-xl transition-all hover:shadow-subtle hover:scale-105">+ Novo</button>
                                </div>
                                <div id="anchors-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <!-- Injected -->
                                </div>
                            </section>

                            <!-- Today Agenda -->
                            <section>
                                <h3 class="text-lg font-bold text-txt-main mb-4 flex items-center gap-2"><i class="ph-fill ph-list-checks text-brand-500"></i> Agenda</h3>
                                <div id="today-tasks" class="bg-bg-surface rounded-3xl p-6 border border-white/5 shadow-subtle min-h-[180px] flex flex-col justify-center items-center text-txt-muted gap-3">
                                    <!-- Injected -->
                                </div>
                            </section>
                        </div>

                        <!-- Quick Access -->
                        <div class="bg-bg-surface p-6 rounded-3xl border border-white/5 shadow-subtle h-full flex flex-col">
                            <h4 class="font-bold text-txt-main mb-6 text-sm uppercase tracking-wide opacity-70">Acesso Rápido</h4>
                            <div class="grid grid-cols-2 gap-4 flex-1">
                                <button onclick="router('mindmap')" class="p-4 bg-bg-main rounded-2xl flex flex-col items-center justify-center gap-2 text-xs font-bold text-txt-muted hover:bg-brand-50 hover:text-brand-600 transition-all group">
                                    <div class="w-10 h-10 bg-white dark:bg-white/5 rounded-xl flex items-center justify-center text-brand-500 shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="ph-bold ph-tree-structure text-xl"></i>
                                    </div>
                                    Mapa
                                </button>
                                <button onclick="router('questoes')" class="p-4 bg-bg-main rounded-2xl flex flex-col items-center justify-center gap-2 text-xs font-bold text-txt-muted hover:bg-brand-50 hover:text-brand-600 transition-all group">
                                    <div class="w-10 h-10 bg-white dark:bg-white/5 rounded-xl flex items-center justify-center text-purple-500 shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="ph-bold ph-exam text-xl"></i>
                                    </div>
                                    Prova
                                </button>
                                <button onclick="router('flashcards')" class="p-4 bg-bg-main rounded-2xl flex flex-col items-center justify-center gap-2 text-xs font-bold text-txt-muted hover:bg-brand-50 hover:text-brand-600 transition-all group">
                                    <div class="w-10 h-10 bg-white dark:bg-white/5 rounded-xl flex items-center justify-center text-orange-500 shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="ph-bold ph-cards text-xl"></i>
                                    </div>
                                    Cards
                                </button>
                                <button onclick="router('foco')" class="p-4 bg-bg-main rounded-2xl flex flex-col items-center justify-center gap-2 text-xs font-bold text-txt-muted hover:bg-brand-50 hover:text-brand-600 transition-all group">
                                    <div class="w-10 h-10 bg-white dark:bg-white/5 rounded-xl flex items-center justify-center text-emerald-500 shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="ph-bold ph-timer text-xl"></i>
                                    </div>
                                    Foco
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FLASHCARDS VIEW -->
                <div id="view-flashcards" class="hidden h-full flex flex-col animate-slide-up max-w-5xl mx-auto">
                    <div id="fc-decks-view">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-2xl font-bold text-txt-main">Meus Baralhos</h2>
                            <button onclick="document.getElementById('modal-create-deck').showModal()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition-all hover:scale-105">
                                <i class="ph-bold ph-plus"></i> Novo Baralho
                            </button>
                        </div>
                        <div id="fc-decks-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                    </div>

                    <div id="fc-study-view" class="hidden flex flex-col items-center justify-center h-full relative">
                        <button onclick="Flashcards.closeStudy()" class="absolute top-0 left-0 text-txt-muted hover:text-brand-600 flex items-center gap-2 font-medium bg-bg-surface px-3 py-1.5 rounded-lg border border-white/5">
                            <i class="ph-bold ph-arrow-left"></i> Voltar
                        </button>

                        <div class="perspective-1000 w-full max-w-lg h-96 cursor-pointer group" onclick="Flashcards.flip()">
                            <div id="fc-card-inner" class="relative w-full h-full text-center transition-transform duration-500 transform-style-3d shadow-2xl rounded-[32px]">
                                <div class="absolute w-full h-full backface-hidden bg-bg-surface border border-white/5 rounded-[32px] p-10 flex flex-col items-center justify-center shadow-float">
                                    <span class="px-3 py-1 bg-brand-50 text-brand-600 rounded-full text-[10px] font-bold uppercase tracking-widest mb-6">Pergunta</span>
                                    <h3 id="fc-front-text" class="text-3xl font-extrabold text-txt-main leading-tight">?</h3>
                                    <p class="text-xs text-txt-muted mt-auto font-medium opacity-60 flex items-center gap-2"><i class="ph-bold ph-hand-tap"></i> Toque para virar</p>
                                </div>
                                <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-brand-600 to-brand-800 text-white rounded-[32px] p-10 flex flex-col items-center justify-center rotate-y-180 border border-white/10 shadow-float">
                                    <span class="px-3 py-1 bg-white/20 rounded-full text-[10px] font-bold uppercase tracking-widest mb-6 text-white">Resposta</span>
                                    <h3 id="fc-back-text" class="text-2xl font-bold leading-relaxed">!</h3>
                                </div>
                            </div>
                        </div>

                        <div id="fc-controls" class="mt-10 flex gap-4 opacity-0 transition-opacity pointer-events-none">
                            <button onclick="Flashcards.next()" class="px-8 py-4 rounded-2xl bg-bg-surface text-txt-main border border-white/10 font-bold hover:bg-brand-50 hover:text-brand-600 hover:border-brand-200 transition-all shadow-subtle flex items-center gap-2">
                                Próximo <i class="ph-bold ph-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CRONOGRAMA VIEW -->
                <div id="view-cronograma" class="hidden h-full flex flex-col animate-slide-up">
                    <div class="flex justify-end mb-4 px-2">
                         <button onclick="distributePomodoro()" class="flex items-center gap-2 text-xs font-bold bg-brand-50 text-brand-600 px-4 py-2 rounded-xl hover:bg-brand-100 transition shadow-sm border border-brand-100">
                            <i class="ph-fill ph-magic-wand"></i> Otimizar Tempo
                        </button>
                    </div>
                    <div class="flex-1 overflow-x-auto pb-4 cursor-grab active:cursor-grabbing" id="kanban-container">
                        <div class="flex gap-6 min-w-max h-full px-2" id="week-columns"></div>
                    </div>
                </div>

                <!-- MINDMAP VIEW -->
                <div id="view-mindmap" class="hidden h-full flex flex-col animate-slide-up relative bg-bg-surface rounded-3xl border border-white/5 overflow-hidden shadow-subtle">
                    <div id="mm-explorer" class="absolute inset-0 bg-bg-main z-20 flex flex-col p-8 overflow-y-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-2xl font-bold text-txt-main flex items-center gap-3">
                                <div class="p-2 bg-brand-100 dark:bg-brand-500/20 rounded-lg text-brand-600"><i class="ph-fill ph-tree-structure"></i></div>
                                Mapas Mentais
                            </h2>
                            <button onclick="document.getElementById('modal-create-map').showModal()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-brand-700 transition shadow-lg flex items-center gap-2">
                                <i class="ph-bold ph-plus"></i> Novo
                            </button>
                        </div>
                        <div id="mm-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>

                    <div id="mm-workspace" class="hidden absolute inset-0 z-30 flex flex-col bg-bg-main">
                        <div class="items-start absolute top-4 left-4 z-40 flex flex-col gap-2 pointer-events-auto">
                            <div class="flex items-center gap-2 bg-bg-panel glass p-1.5 rounded-xl shadow-float mb-2">
                                <button onclick="MindMap.close()" class="w-9 h-9 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 text-txt-muted flex items-center justify-center transition-colors" title="Voltar"><i class="ph-bold ph-arrow-left"></i></button>
                                <div class="px-2 border-l border-txt-muted/20">
                                    <h4 id="mm-current-title" class="text-xs font-bold text-txt-main">Sem Título</h4>
                                </div>                                
                                <div class="flex gap-0.5 justify-center">
                                    <button onclick="MindMap.zoom(-0.1)" class="w-8 h-8 rounded hover:bg-black/5 dark:hover:bg-white/10 text-txt-muted flex items-center justify-center transition-colors" title="Diminuir zoom"><i class="ph-bold ph-minus"></i></button>
                                    <button onclick="MindMap.resetZoom()" class="w-8 h-8 rounded hover:bg-black/5 dark:hover:bg-white/10 text-txt-muted flex items-center justify-center transition-colors" title="Resetar zoom"><i class="ph-bold ph-arrow-clockwise"></i></button>
                                    <button  onclick="MindMap.zoom(0.1)" class="w-8 h-8 rounded hover:bg-black/5 dark:hover:bg-white/10 text-txt-muted flex items-center justify-center transition-colors" title="Aumentar zoom"><i class="ph-bold ph-plus"></i></button>
                                </div>
                            </div>
                            
                            <div id="indicator-readonly" class="hidden ml-1 px-2 py-1 bg-brand-100 text-brand-700 text-[10px] font-bold rounded uppercase border border-brand-200">Leitura</div>

                            <div class="mm-toolbar bg-bg-panel glass p-2 rounded-xl shadow-float flex flex-col gap-2">
                                <div class="relative w-9 h-9 rounded-full overflow-hidden cursor-pointer border border-white/10 shadow-sm hover:scale-110 transition-transform">
                                     <input title="Cor" type="color" id="mm-color-picker" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 border-0 cursor-pointer" value="#3b82f6" onchange="MindMap.updateColor(this.value)">
                                </div>
                                <div class="h-px bg-txt-muted/10 my-1"></div>
                                <button title="adicionar" onclick="window.MindMap.addNode()" class="w-9 h-9 rounded-lg bg-brand-50 text-brand-600 hover:bg-brand-100 flex items-center justify-center transition-all shadow-sm active:scale-95"><i class="ph-bold ph-plus"></i></button>
                                <button title="remover nó selecionado" onclick="window.MindMap.deleteSelectedNode()" class="w-9 h-9 rounded-lg hover:bg-red-50 text-red-500 flex items-center justify-center transition-colors active:scale-95"><i class="ph-bold ph-eraser"></i></button>
                                <button title="salvar mapa" onclick="window.MindMap.save()" class="w-9 h-9 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 text-txt-muted flex items-center justify-center transition-colors"><i class="ph-bold ph-floppy-disk"></i></button>
                                <button title="excluir mapa" onclick="window.MindMap.deleteMap()" class="w-9 h-9 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 text-txt-muted hover:text-red-500 flex items-center justify-center transition-colors"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>

                        <div id="mm-viewport" class="mindmap-viewport">
                            <div id="mm-world" class="mindmap-world">
                                <div class="mindmap-bg"></div>
                                <svg id="mm-svg" class="absolute top-0 left-0 overflow-visible pointer-events-none z-0"></svg>
                                <div id="mm-nodes-layer" class="absolute top-0 left-0 w-0 h-0 z-10"></div>
                            </div>
                        </div>
                        
                        <div id="keys-map" class="absolute bottom-4 right-4 bg-bg-panel glass px-4 py-3 rounded-xl text-[10px] text-txt-muted pointer-events-none shadow-float z-40">
                            <p class="font-bold text-txt-main mb-1 uppercase tracking-wider">Atalhos</p>
                            <ul class="space-y-1 font-medium opacity-80">
                                <li>Duplo clique: <span class="text-txt-main">Novo Nó</span></li>
                                <li>Arrastar fundo: <span class="text-txt-main">Mover</span></li>
                                <li>Ctrl+Click: <span class="text-txt-main">Conectar</span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- FOCUS VIEW -->
                <div id="view-foco" class="hidden h-full flex flex-col items-center justify-center relative animate-slide-up">
                    <div class="relative z-10 text-center">
                        <div class="inline-block mb-10 px-6 py-2 rounded-full bg-bg-surface border border-brand-200/50 text-brand-600 font-bold text-xs tracking-widest uppercase shadow-subtle animate-pulse-slow" id="timer-status">Pronto para focar</div>
                        
                        <div class="relative group cursor-pointer transition-transform hover:scale-[1.02] duration-300" onclick="Timer.edit()">
                            <h1 id="timer-display" class="text-[7rem] md:text-[11rem] font-sans font-bold leading-none tracking-tighter text-txt-main tabular-nums group-hover:text-brand-500 transition-colors drop-shadow-sm">25:00</h1>
                            <input title="Editar tempo" type="text" id="timer-input" class="hidden text-[7rem] md:text-[11rem] font-sans font-bold leading-none tracking-tighter bg-transparent text-center text-brand-500 w-full outline-none" onblur="Timer.saveEdit()" onkeydown="if(event.key==='Enter')this.blur()">
                        </div>

                        <div class="flex gap-8 justify-center mt-16">
                            <button title="Play/Pause" onclick="Timer.toggle()" id="btn-timer-main" class="w-24 h-24 rounded-[32px] bg-brand-600 text-white text-4xl flex items-center justify-center shadow-lg shadow-brand-500/40 hover:scale-110 hover:bg-brand-500 active:scale-95 transition-all">
                                <i class="ph-fill ph-play ml-1"></i>
                            </button>
                            <button title="Resetar" onclick="Timer.reset()" class="w-24 h-24 rounded-[32px] bg-bg-surface border border-white/10 text-txt-muted text-4xl flex items-center justify-center hover:bg-red-50 hover:text-red-500 shadow-subtle hover:scale-105 active:scale-95 transition-all">
                                <i class="ph-bold ph-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- QUESTÕES VIEW -->
                <div id="view-questoes" class="hidden max-w-6xl mx-auto animate-slide-up space-y-8 pb-10">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                        <div class="md:col-span-8 space-y-6">
                            <div class="bg-bg-surface p-5 rounded-3xl border border-white/5 shadow-subtle flex flex-wrap gap-4 items-center justify-between sticky top-0 z-10 backdrop-blur-md bg-opacity-90">
                                <h2 class="font-bold text-xl text-txt-main">Banco de Questões</h2>
                                <div class="flex gap-3 w-full md:w-auto">
                                    <input type="text" id="q-search" oninput="Quiz.render()" placeholder="Pesquisar..." class="flex-1 bg-bg-main border-none rounded-xl px-4 py-2.5 text-sm text-txt-main focus:ring-2 focus:ring-brand-500 transition-all">
                                    <button onclick="document.getElementById('modal-import').showModal()" class="bg-brand-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-brand-500/20 hover:bg-brand-700 transition-all flex items-center gap-2 whitespace-nowrap">
                                        <i class="ph-bold ph-upload-simple"></i> Importar
                                    </button>
                                </div>
                            </div>
                            <div id="quiz-list" class="space-y-4 pb-20"></div>
                        </div>

                        <div class="md:col-span-4 space-y-6">
                            <div class="bg-bg-surface p-6 rounded-3xl border border-white/5 shadow-subtle sticky top-6">
                                <h3 class="font-bold text-txt-main mb-6">Desempenho</h3>
                                <div class="relative h-48 w-full flex items-center justify-center">
                                    <canvas id="chart-performance"></canvas>
                                </div>
                                <div class="mt-6 grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-emerald-50 dark:bg-emerald-500/10 p-4 rounded-2xl">
                                        <p class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider">Acertos</p>
                                        <p class="text-2xl font-extrabold text-emerald-600 mt-1" id="stat-hits">0</p>
                                    </div>
                                    <div class="bg-red-50 dark:bg-red-500/10 p-4 rounded-2xl">
                                        <p class="text-[10px] text-red-600 font-bold uppercase tracking-wider">Erros</p>
                                        <p class="text-2xl font-extrabold text-red-600 mt-1" id="stat-misses">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOJA VIEW -->
                <div id="view-loja" class="hidden max-w-5xl mx-auto animate-slide-up">
                    <div class="text-center py-16">
                        <h2 class="text-4xl font-extrabold text-txt-main mb-4 tracking-tight">Loja de Conquistas</h2>
                        <p class="text-txt-muted text-lg">Recompensas pelo seu esforço.</p>
                        <div class="mt-8 inline-flex items-center gap-2 bg-yellow-400/10 text-yellow-600 dark:text-yellow-400 px-6 py-2.5 rounded-full font-bold border border-yellow-400/20 backdrop-blur-sm">
                            <i class="ph-fill ph-coins text-xl"></i> Saldo: <span id="shop-balance">0 XP</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 px-4" id="shop-grid"></div>
                </div>

                <!-- REDAÇÃO VIEW -->
                <div id="view-redacao" class="hidden h-full flex flex-col animate-slide-up max-w-6xl mx-auto pb-8">
                    <div class="flex justify-between items-center mb-6 shrink-0">
                        <h2 class="text-xl font-bold text-txt-main hidden md:block">Redação</h2>
                        <div class="flex gap-3 w-full md:w-auto justify-end">
                            <button onclick="Redacao.toggleTimer()" id="btn-red-timer" class="flex items-center gap-2 bg-bg-surface border border-white/10 px-4 py-2.5 rounded-xl font-mono font-bold text-brand-600 hover:bg-brand-50 transition-colors shadow-sm">
                                <i class="ph-bold ph-clock"></i> <span id="red-timer-display">01:00:00</span>
                            </button>
                            <button onclick="GeminiProcessor.analyze()" id="btn-ai-analyze" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold text-sm hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2">
                                <i class="ph-bold ph-sparkle"></i> IA Check
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col lg:flex-row gap-8 overflow-hidden min-h-0">
                        <div class="flex-1 h-full pb-6 relative group">
                            <textarea id="red-full-text" class="notebook-sheet shadow-subtle custom-scrollbar" placeholder="Comece a escrever..." spellcheck="false" oninput="Redacao.updateStats()"></textarea>
                            <div class="absolute top-4 right-8 opacity-40 text-[10px] text-txt-muted pointer-events-none font-bold uppercase tracking-widest bg-bg-surface/80 px-2 rounded">
                                30 Linhas
                            </div>
                        </div>

                        <div class="lg:w-72 shrink-0 flex flex-col gap-6 overflow-y-auto pb-4 custom-scrollbar pr-2">
                            <div class="bg-brand-50 dark:bg-brand-900/20 p-6 rounded-3xl border border-brand-100 dark:border-brand-800/30">
                                <h4 class="font-bold text-brand-800 dark:text-brand-300 text-xs uppercase mb-4 flex items-center gap-2 tracking-wide"><i class="ph-fill ph-chart-bar"></i> Dados</h4>
                                <div class="grid grid-cols-2 gap-3 text-center">
                                    <div class="p-3 bg-white dark:bg-white/5 rounded-2xl shadow-sm">
                                        <span class="block text-xl font-extrabold text-brand-600" id="stat-words">0</span>
                                        <span class="text-[9px] text-brand-400 font-bold uppercase">Palavras</span>
                                    </div>
                                    <div class="p-3 bg-white dark:bg-white/5 rounded-2xl shadow-sm">
                                        <span class="block text-xl font-extrabold text-brand-600" id="stat-lines">0</span>
                                        <span class="text-[9px] text-brand-400 font-bold uppercase">Linhas</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-bg-surface flex-1 rounded-3xl border border-white/5 shadow-subtle p-6">
                                <h4 class="font-bold text-txt-muted text-xs uppercase mb-6 flex items-center gap-2 tracking-wide"><i class="ph-fill ph-puzzle-piece"></i> Conectivos</h4>
                                <div class="space-y-6">
                                    <div>
                                        <p class="text-[10px] font-bold text-brand-500 mb-2.5 uppercase">Início</p>
                                        <div class="flex flex-wrap gap-2">
                                            <button onclick="Redacao.insert('Em primeira análise, ')" class="btn-connective">1ª análise</button>
                                            <button onclick="Redacao.insert('Ademais, ')" class="btn-connective">Ademais</button>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-[10px] font-bold text-brand-500 mb-2.5 uppercase">Oposição</p>
                                        <div class="flex flex-wrap gap-2">
                                            <button onclick="Redacao.insert('Entretanto, ')" class="btn-connective">Entretanto</button>
                                            <button onclick="Redacao.insert('Todavia, ')" class="btn-connective">Todavia</button>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-[10px] font-bold text-brand-500 mb-2.5 uppercase">Conclusão</p>
                                        <div class="flex flex-wrap gap-2">
                                            <button onclick="Redacao.insert('Portanto, ')" class="btn-connective">Portanto</button>
                                            <button onclick="Redacao.insert('Dessa forma, ')" class="btn-connective">Dessa forma</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    .btn-connective { 
                        font-size: 0.75rem; background: var(--bg-main); border: 1px solid var(--text-muted); opacity: 0.6; 
                        padding: 6px 12px; border-radius: 99px; color: var(--text-main); transition: all 0.2s; font-weight: 600; 
                    }
                    .btn-connective:hover { 
                        opacity: 1; background: var(--brand-50); color: var(--brand-600); border-color: var(--brand-200); 
                        transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    }
                </style>

                <!-- SIMULADO VIEW -->
                <div id="view-simulado" class="hidden h-full flex flex-col animate-slide-up max-w-4xl mx-auto">
                    <div id="sim-start" class="flex flex-col items-center justify-center h-full text-center space-y-8">
                        <div class="w-28 h-28 bg-brand-50 dark:bg-brand-900/30 rounded-full flex items-center justify-center mb-4 animate-bounce border border-brand-100 dark:border-brand-800">
                            <i class="ph-fill ph-timer text-5xl text-brand-600"></i>
                        </div>
                        <div>
                            <h2 class="text-4xl font-extrabold text-txt-main mb-3">Simulado Oficial</h2>
                            <p class="text-txt-muted max-w-md mx-auto">Modo prova: sem feedback imediato. Prepare o ambiente.</p>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-4">
                            <button onclick="Simulado.start(10)" class="px-8 py-4 rounded-2xl border border-white/10 bg-bg-surface hover:bg-brand-50 font-bold text-txt-main transition-all shadow-subtle hover:-translate-y-1">10 Questões</button>
                            <button onclick="Simulado.start(30)" class="px-8 py-4 rounded-2xl bg-brand-600 hover:bg-brand-700 text-white font-bold shadow-lg shadow-brand-500/25 transition-transform hover:scale-105">30 Questões</button>
                            <button onclick="Simulado.start(90)" class="px-8 py-4 rounded-2xl border border-white/10 bg-bg-surface hover:bg-brand-50 font-bold text-txt-main transition-all shadow-subtle hover:-translate-y-1">90 Questões</button>
                        </div>
                    </div>

                    <div id="sim-exam" class="hidden flex flex-col h-full">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/5">
                            <h3 class="font-bold text-xl text-txt-main flex items-center gap-2">
                                <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>
                                Em andamento
                            </h3>
                            <button onclick="Simulado.finish()" class="bg-red-50 text-red-600 border border-red-100 px-5 py-2 rounded-xl font-bold text-sm hover:bg-red-600 hover:text-white transition-all">Entregar</button>
                        </div>
                        <div id="sim-questions" class="flex-1 overflow-y-auto space-y-10 pr-2 custom-scrollbar"></div>
                    </div>

                    <div id="sim-result" class="hidden flex flex-col items-center justify-center h-full text-center">
                        <h2 class="text-3xl font-bold text-txt-main mb-2">Resultado Final</h2>
                        <div class="text-8xl font-extrabold text-brand-600 mb-6 tracking-tighter" id="sim-score-display">0%</div>
                        <p class="text-txt-muted mb-10 text-lg bg-bg-surface px-6 py-2 rounded-full border border-white/5" id="sim-msg">...</p>
                        <button onclick="Simulado.close()" class="bg-bg-surface border border-white/10 px-8 py-4 rounded-2xl font-bold text-txt-main hover:bg-bg-main shadow-float transition-all">Voltar ao Início</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS (Redesigned for cleaner look) -->
    
    <dialog id="modal-create-map" class="bg-transparent p-0 backdrop:bg-black/60 backdrop-blur-sm w-full max-w-md rounded-[32px] shadow-2xl transition-all">
        <div class="bg-bg-surface p-8 border border-white/10 rounded-[32px]">
            <h3 class="font-bold text-2xl mb-6 text-txt-main tracking-tight">Novo Mapa Mental</h3>
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-2 tracking-wide">Nome</label>
            <input type="text" id="map-name" class="w-full bg-bg-main border border-transparent rounded-2xl p-4 mb-6 text-txt-main focus:bg-bg-surface transition-all outline-none" placeholder="Ex: Fotossíntese">
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-2 tracking-wide">Matéria</label>
            <input type="text" id="map-subject" class="w-full bg-bg-main border border-transparent rounded-2xl p-4 mb-8 text-txt-main focus:bg-bg-surface transition-all outline-none" placeholder="Ex: Biologia">
            
            <div class="flex gap-4">
                <button onclick="MindMap.create()" class="flex-1 bg-brand-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-[1.02] transition-transform">Criar</button>
                <button onclick="document.getElementById('modal-create-map').close()" class="px-6 py-4 rounded-2xl text-txt-muted font-bold hover:bg-bg-main transition-colors">Cancelar</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-task" class="bg-transparent p-0 backdrop:bg-black/60 backdrop-blur-sm w-full max-w-lg rounded-[32px] shadow-2xl">
        <div class="bg-bg-surface p-8 shadow-2xl rounded-[32px] border border-white/10">
        <h3 class="font-bold text-2xl mb-6 text-txt-main tracking-tight">Nova Atividade</h3>
        
        <input type="text" id="task-text" class="w-full bg-bg-main border-none rounded-2xl p-5 mb-8 text-lg text-txt-main outline-none placeholder:text-txt-light" placeholder="O que vamos estudar?" autofocus>
        
        <div class="flex gap-4 mb-8">
            <div class="w-1/3">
                <label class="text-[10px] font-bold text-txt-muted uppercase mb-2 block tracking-wider">Duração</label>
                <input type="number" id="task-duration" value="25" class="w-full bg-bg-main border-none rounded-2xl p-3 text-txt-main text-center font-bold outline-none">
            </div>

            <div class="w-1/3">
                <label class="text-[10px] font-bold text-txt-muted uppercase mb-2 block tracking-wider">Horário</label>
                <input type="time" id="task-time" class="w-full bg-bg-main border-none rounded-2xl p-3 text-txt-main text-center font-bold outline-none">
            </div>

            <div class="flex-1">
                <label class="text-[10px] font-bold text-txt-muted uppercase mb-2 block tracking-wider">Matéria</label>
                <div class="relative">
                    <select id="task-tag" class="w-full bg-bg-main border-none rounded-2xl p-3 text-txt-main font-bold outline-none appearance-none">
                        <option value="atividades">Geral</option>
                        <option value="matematica">Matemática</option>
                        <option value="natureza">Natureza</option>
                        <option value="humanas">Humanas</option>
                        <option value="linguagens">Linguagens</option>
                        <option value="redacao">Redação</option>
                    </select>
                    <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-txt-muted">
                        <i class="ph-bold ph-caret-down"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex gap-4">
            <button onclick="Actions.addTask()" class="flex-1 bg-brand-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-[1.02] transition-transform">Adicionar</button>
            <button onclick="document.getElementById('modal-task').close()" class="px-6 py-4 rounded-2xl text-txt-muted font-bold hover:bg-bg-main transition-colors">Cancelar</button>
        </div>
    </div>
    </dialog>

    <dialog id="modal-import" class="bg-transparent p-0 backdrop:bg-black/60 backdrop-blur-sm w-full max-w-2xl rounded-[32px] shadow-2xl">
        <div class="bg-bg-surface p-8 flex flex-col h-[75vh] rounded-[32px] border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-2xl text-txt-main">Importador Inteligente</h3>
                <button onclick="document.getElementById('modal-import').close()" class="w-10 h-10 rounded-full hover:bg-red-50 text-txt-muted hover:text-red-500 flex items-center justify-center transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            
            <div class="bg-brand-50 text-brand-700 p-5 rounded-2xl text-sm mb-6 flex gap-4 border border-brand-100 dark:border-brand-900">
                <i class="ph-fill ph-magic-wand text-2xl shrink-0"></i>
                <p>Cole o texto. O sistema detecta automaticamente: <br><strong>Enunciado</strong> e <strong>Alternativas</strong>.</p>
            </div>
            
            <input type="text" id="import-subject" placeholder="Matéria (ex: Biologia)" class="w-full bg-bg-main border-none rounded-2xl p-4 text-txt-main mb-4 outline-none font-medium">

            <textarea id="import-area" class="flex-1 w-full bg-bg-main border-none rounded-2xl p-5 font-mono text-xs text-txt-main outline-none resize-none leading-relaxed" placeholder="Cole a questão ou JSON aqui..."></textarea>
            
            <button onclick="Quiz.processImport()" class="w-full mt-6 bg-brand-600 text-white py-4 rounded-2xl font-bold hover:bg-brand-700 transition-colors shadow-lg">Processar</button>
        </div>
    </dialog>

    <dialog id="modal-settings" class="bg-transparent p-0 backdrop:bg-black/60 backdrop-blur-md w-full max-w-4xl rounded-[32px] shadow-2xl overflow-hidden">
        <div class="bg-bg-card flex flex-col md:flex-row h-[650px] border border-white/10">
            <div class="w-full md:w-72 bg-bg-surface border-r border-white/5 p-6 flex flex-col gap-2">
                <h3 class="font-bold text-txt-main mb-6 px-2 text-lg">Preferências</h3>
                <button id="tab-btn-theme" onclick="Settings.tab('theme')" class="sett-tab active-sett-tab w-full text-left p-4 rounded-2xl text-sm font-bold text-txt-muted hover:bg-bg-main transition-all mb-1">Aparência</button>
                <button id="tab-btn-data" onclick="Settings.tab('data')" class="sett-tab w-full text-left p-4 rounded-2xl text-sm font-bold text-txt-muted hover:bg-bg-main transition-all mb-1">Dados & Nuvem</button>
                <button id="tab-btn-danger" onclick="Settings.tab('danger')" class="sett-tab w-full text-left p-4 rounded-2xl text-sm font-bold text-txt-muted hover:bg-red-50 hover:text-red-500 transition-all">Zona de Perigo</button>
                <div class="mt-auto">
                     <button onclick="document.getElementById('modal-settings').close()" class="w-full py-3 border border-white/10 rounded-2xl text-sm font-bold text-txt-muted hover:bg-bg-main transition-colors">Fechar</button>
                </div>
            </div>
            
            <div class="flex-1 p-10 overflow-y-auto bg-bg-main text-txt-main relative">
                <div id="tab-theme" class="sett-content space-y-8">
                    <h4 class="text-2xl font-bold tracking-tight">Temas</h4>
                    <div class="grid grid-cols-2 gap-6">
                         <button onclick="Settings.setTheme('light')" class="h-32 rounded-3xl border-2 border-slate-200 bg-[#f3f4f6] hover:border-brand-500 hover:scale-[1.02] transition-all relative overflow-hidden group">
                             <span class="absolute bottom-5 left-6 font-bold text-slate-700">Light</span>
                             <div class="absolute top-4 right-4 w-6 h-6 rounded-full bg-blue-500 shadow-lg shadow-blue-500/30"></div>
                          </button>
                          <button onclick="Settings.setTheme('dark')" class="h-32 rounded-3xl border-2 border-slate-700 bg-[#020617] hover:border-brand-500 hover:scale-[1.02] transition-all relative overflow-hidden group">
                             <span class="absolute bottom-5 left-6 font-bold text-slate-200">Dark</span>
                             <div class="absolute top-4 right-4 w-6 h-6 rounded-full bg-indigo-500 shadow-lg shadow-indigo-500/30"></div>
                          </button>
                          <button onclick="Settings.setTheme('dracula')" class="h-32 rounded-3xl border-2 border-purple-900 bg-[#282a36] hover:border-pink-500 hover:scale-[1.02] transition-all relative overflow-hidden group">
                             <span class="absolute bottom-5 left-6 font-bold text-[#f8f8f2]">Dracula</span>
                             <div class="absolute top-4 right-4 w-6 h-6 rounded-full bg-pink-500 shadow-lg shadow-pink-500/30"></div>
                          </button>
                          <button onclick="Settings.setTheme('forest')" class="h-32 rounded-3xl border-2 border-green-900 bg-[#052e16] hover:border-green-500 hover:scale-[1.02] transition-all relative overflow-hidden group">
                             <span class="absolute bottom-5 left-6 font-bold text-[#e8f5e9]">Forest</span>
                             <div class="absolute top-4 right-4 w-6 h-6 rounded-full bg-green-500 shadow-lg shadow-green-500/30"></div>
                          </button>
                    </div>
                </div>

                <div id="tab-data" class="sett-content hidden space-y-8">
                    <h4 class="text-2xl font-bold tracking-tight">Dados & IA</h4>
                    <div class="bg-bg-surface border border-brand-200/50 p-6 rounded-[24px] shadow-sm">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-brand-100 rounded-2xl text-brand-600"><i class="ph-fill ph-robot text-2xl"></i></div>
                            <div>
                                <h5 class="font-bold text-txt-main text-lg">Google Gemini API</h5>
                                <p class="text-xs text-txt-muted mt-0.5">Necessário para correção de redação.</p>
                            </div>
                        </div>
                        <input type="password" id="sett-gemini-key" placeholder="Cole sua API Key aqui (AIza...)" 
                            class="w-full bg-bg-main border-none rounded-2xl p-4 text-sm text-txt-main focus:ring-2 focus:ring-brand-500 outline-none mb-4 font-mono">
                        <button onclick="Settings.saveGeminiKey()" class="w-full bg-brand-600 text-white py-3 rounded-xl text-sm font-bold hover:bg-brand-700 transition-all shadow-lg">Salvar Chave</button>
                        <p class="mt-4 text-[10px] text-center text-txt-muted"><a href="https://aistudio.google.com/app/apikey" rel="noopener" target="_blank" class="text-brand-600 hover:underline font-bold">Gerar chave gratuita</a></p>
                    </div>
                </div>

                <div id="tab-danger" class="sett-content hidden space-y-8">
                    <div class="mt-8 pt-6 border-t border-white/10">
                        <h5 class="text-sm font-bold text-red-500 uppercase mb-6 flex items-center gap-2 tracking-widest"><i class="ph-bold ph-skull"></i> Zona de Perigo</h5>
                        <div class="bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/20 rounded-[24px] p-6 flex items-center justify-between">
                            <div>
                                <p class="text-red-900 dark:text-red-200 font-bold text-lg">Resetar Conta</p>
                                <p class="text-red-700/70 dark:text-red-300/50 text-xs mt-1">Apaga TODOS os dados locais.</p>
                            </div>
                            <button onclick="document.getElementById('modal-danger-reset').showModal()" class="bg-bg-surface border border-red-200 text-red-600 px-6 py-3 rounded-2xl text-xs font-bold hover:bg-red-600 hover:text-white transition-all shadow-sm">Resetar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    
    <dialog id="modal-trash" class="bg-transparent p-0 backdrop:bg-black/40 backdrop-blur-sm w-full max-w-lg rounded-[32px] shadow-2xl">
        <div class="bg-bg-surface p-8 rounded-[32px] border border-white/10">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-2xl text-txt-main">Lixeira (24h)</h3>
                <button onclick="Trash.empty()" class="text-xs text-red-500 hover:bg-red-50 px-4 py-2 rounded-xl font-bold transition-colors">Esvaziar</button>
            </div>
            <div id="trash-container" class="space-y-2 max-h-[300px] overflow-y-auto min-h-[100px] p-1"></div>
            <button onclick="document.getElementById('modal-trash').close()" class="w-full mt-6 py-4 bg-bg-main hover:bg-slate-100 dark:hover:bg-white/5 rounded-2xl font-bold text-sm text-txt-muted transition-colors">Fechar</button>
        </div>
    </dialog>

    <dialog id="modal-redacao-score" class="bg-transparent p-0 backdrop:bg-black/60 backdrop-blur-md w-full max-w-xl rounded-[32px] shadow-2xl">
        <div class="bg-bg-surface p-10 border border-white/10 max-h-[90vh] overflow-y-auto rounded-[32px]">
            <h3 class="font-bold text-2xl mb-2 text-txt-main">Auto-Avaliação</h3>
            <p class="text-sm text-txt-muted mb-8">Avalie seu texto conforme a grade oficial.</p>
            <div class="space-y-6" id="competences-list"></div>
            <div class="mt-10 pt-6 border-t border-white/10 flex justify-between items-center">
                <div class="text-left">
                    <span class="text-xs font-bold text-txt-muted uppercase">Nota Total</span>
                    <p class="text-3xl font-bold text-brand-600" id="red-total-score">0</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('modal-redacao-score').close()" class="px-6 py-3 rounded-2xl text-txt-muted font-bold hover:bg-bg-main transition-all">Cancelar</button>
                    <button onclick="Redacao.save()" class="bg-brand-600 text-white px-8 py-3 rounded-2xl font-bold shadow-lg shadow-brand-500/30 hover:scale-105 transition-all">Salvar</button>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="modal-create-deck" class="bg-transparent p-0 backdrop:bg-black/40 backdrop-blur-sm w-full max-w-sm rounded-[32px] shadow-2xl">
        <div class="bg-bg-surface p-8 border border-white/10 rounded-[32px]">
            <h3 class="font-bold text-2xl mb-6 text-txt-main">Novo Baralho</h3>
            <input type="text" id="deck-name" class="w-full bg-bg-main border-none rounded-2xl p-5 mb-8 text-txt-main outline-none focus:ring-2 focus:ring-brand-500 font-medium" placeholder="Ex: Fórmulas de Física">
            <div class="flex gap-4">
                <button onclick="Flashcards.createDeck()" class="flex-1 bg-brand-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">Criar</button>
                <button onclick="document.getElementById('modal-create-deck').close()" class="px-8 py-4 rounded-2xl text-txt-muted font-bold hover:bg-bg-main transition-colors">Cancelar</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-add-card" class="bg-transparent p-0 backdrop:bg-black/40 backdrop-blur-sm w-full max-w-md rounded-[32px] shadow-2xl">
        <div class="bg-bg-surface p-8 border border-white/10 rounded-[32px]">
            <h3 class="font-bold text-2xl mb-6 text-txt-main">Adicionar Carta</h3>
            <input type="hidden" id="card-deck-id">
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-2 ml-1 tracking-wider">Frente</label>
            <textarea id="card-front" class="w-full bg-bg-main border-none rounded-2xl p-4 mb-6 text-txt-main resize-none focus:ring-2 focus:ring-brand-500 outline-none" rows="3"></textarea>
            
            <label class="block text-xs font-bold text-txt-muted uppercase mb-2 ml-1 tracking-wider">Verso</label>
            <textarea id="card-back" class="w-full bg-bg-main border-none rounded-2xl p-4 mb-8 text-txt-main resize-none focus:ring-2 focus:ring-brand-500 outline-none" rows="3"></textarea>
            
            <div class="flex gap-4">
                <button onclick="Flashcards.addCard()" class="flex-1 bg-brand-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">Salvar</button>
                <button onclick="document.getElementById('modal-add-card').close()" class="px-8 py-4 rounded-2xl text-txt-muted font-bold hover:bg-bg-main transition-colors">Fechar</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-ai-result" class="bg-transparent p-0 backdrop:bg-black/60 backdrop-blur-md w-full max-w-2xl rounded-[32px] shadow-2xl">
        <div class="bg-bg-card p-0 border border-white/10 flex flex-col max-h-[85vh] rounded-[32px] overflow-hidden">
            <div class="p-8 border-b border-white/5 flex justify-between items-center bg-bg-surface">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white shadow-lg shadow-purple-500/30">
                        <i class="ph-fill ph-sparkle text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-txt-main">Análise IA</h3>
                        <p class="text-xs text-txt-muted mt-0.5">Correção detalhada.</p>
                    </div>
                </div>
                <button onclick="document.getElementById('modal-ai-result').close()" class="w-10 h-10 rounded-full hover:bg-black/5 dark:hover:bg-white/10 text-txt-muted flex items-center justify-center transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div id="ai-content" class="p-10 overflow-y-auto text-base leading-relaxed text-txt-main space-y-6 bg-bg-main">
                <div class="animate-pulse space-y-6 opacity-50">
                    <div class="h-4 bg-slate-200 dark:bg-slate-800 rounded-full w-3/4"></div>
                    <div class="h-4 bg-slate-200 dark:bg-slate-800 rounded-full w-1/2"></div>
                    <div class="h-4 bg-slate-200 dark:bg-slate-800 rounded-full w-full"></div>
                </div>
            </div>
            <div class="p-6 border-t border-white/5 bg-bg-surface flex justify-end">
                <button onclick="document.getElementById('modal-ai-result').close()" class="bg-brand-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-brand-700 shadow-lg transition-all">Entendi</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-danger-reset" class="bg-transparent p-0 backdrop:bg-black/80 backdrop-blur-md w-full max-w-sm rounded-[3rem] shadow-2xl animate-scale-in">
        <div class="bg-bg-surface p-10 border border-red-200/20 relative overflow-hidden rounded-[3rem]">
            <div class="absolute -top-12 -right-12 w-40 h-40 bg-red-500/10 rounded-full blur-3xl"></div>
            <div class="flex flex-col items-center text-center relative z-10">
                <div class="w-20 h-20 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-[24px] flex items-center justify-center mb-6 animate-bounce border border-red-100 dark:border-red-900/30">
                    <i class="ph-fill ph-warning-octagon text-4xl"></i>
                </div>
                <h3 class="font-extrabold text-2xl text-txt-main mb-3 leading-tight">Apagar tudo?</h3>
                <p class="text-sm text-txt-muted mb-8 leading-relaxed px-2">Essa ação irá excluir <strong class="text-red-500">permanentemente</strong> todo seu progresso.</p>
                <div class="flex flex-col gap-3 w-full">
                    <button id="btn-nuke" onclick="Settings.confirmHardReset()" class="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-2xl font-bold shadow-xl shadow-red-500/30 transition-all flex items-center justify-center gap-2 group">
                        <i class="ph-bold ph-trash"></i> Sim, apagar tudo
                    </button>
                    <button onclick="document.getElementById('modal-danger-reset').close()" class="w-full bg-transparent hover:bg-bg-main text-txt-main py-4 rounded-2xl font-bold transition-colors">Cancelar</button>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="modal-whiteboard" class="w-full h-full max-w-full max-h-full bg-[#020617] p-0 backdrop:bg-black/90">
        <div class="h-full flex flex-col relative">
            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur-xl border border-white/10 shadow-float rounded-3xl px-6 py-4 flex items-center gap-6 z-50 overflow-x-auto max-w-[90vw]">
                <div class="relative group flex flex-col items-center gap-1.5 shrink-0">
                    <div class="relative w-8 h-8 rounded-full overflow-hidden ring-2 ring-white/20 shadow-lg group hover:ring-brand-500 transition-all cursor-pointer">
                        <input type="color" id="wb-color-picker" value="#3b82f6" onchange="Whiteboard.setColor(this.value)" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 border-0 cursor-pointer appearance-none bg-transparent">
                    </div>
                </div>
                <div class="w-px h-8 bg-white/10 shrink-0"></div>
                <div class="flex gap-2 bg-black/30 p-1 rounded-xl shrink-0">
                    <button id="btn-tool-pen" onclick="Whiteboard.setTool('pen')" class="p-2.5 rounded-lg bg-blue-600 text-white transition-all shadow-lg active:scale-95"><i class="ph-bold ph-pencil-simple text-lg"></i></button>
                    <button id="btn-tool-eraser" onclick="Whiteboard.setTool('eraser')" class="p-2.5 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-all active:scale-95"><i class="ph-bold ph-eraser text-lg"></i></button>
                </div>
                <div class="flex flex-col gap-1 w-24 shrink-0">
                    <label class="text-[9px] text-slate-400 font-bold uppercase flex justify-between">
                        Espessura <span id="wb-size-val">3px</span>
                    </label>

                    <input type="range" min="1" max="50" value="3" oninput="Whiteboard.setSize(this.value)" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                </div>
                
                <div class="w-px h-8 bg-white/10 shrink-0"></div>
                <button onclick="Whiteboard.clear()" class="text-slate-400 hover:text-red-500 transition-colors p-2 shrink-0"><i class="ph-bold ph-trash text-2xl"></i></button>
                <button onclick="document.getElementById('modal-whiteboard').close()" class="text-slate-400 hover:text-white transition-colors p-2 ml-2 shrink-0"><i class="ph-bold ph-x text-2xl"></i></button>
            </div>
            <canvas id="whiteboard-canvas" class="w-full h-full block bg-[#020617] touch-none cursor-crosshair"></canvas>
        </div>
    </dialog>

    <div id="toast-area" class="fixed bottom-8 right-8 z-[80] flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        // 1. IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 2. CONFIGURAÇÃO (Com o nome antigo 'embeddedFirebaseConfig' para não quebrar o Store.init)
        const embeddedFirebaseConfig = {
            apiKey: "AIzaSyB8HXoAZkq9uPVbN3SjISFcrl6EgsFcxRc",
            authDomain: "orbit-study.firebaseapp.com",
            projectId: "orbit-study",
            storageBucket: "orbit-study.firebasestorage.app",
            messagingSenderId: "1084558202713",
            appId: "1:1084558202713:web:8419805db15349cead1e48",
            measurementId: "G-FLCZBTKFWJ"
        };

        // 3. INICIALIZAÇÃO
        const app = initializeApp(embeddedFirebaseConfig); // Usa a config correta
        const db = getFirestore(app);
        const auth = getAuth(app);

        // 4. EXPORTAR PARA O GLOBAL (Essenciais para o Reset funcionar)
        window.orbitDb = db;
        window.orbitAuth = auth;
        window.orbitDoc = doc;
        window.orbitSetDoc = setDoc;
        window.orbitSignOut = signOut;
        
        window.embeddedFirebaseConfig = embeddedFirebaseConfig;

        // =================================================================
        // REDAÇÃO & AUTO-AVALIAÇÃO
        // =================================================================
        window.Redacao = {
            timer: null,
            seconds: 3600,
            isRunning: false,
            
            toggleTimer() {
                // ... (Mantenha a lógica do timer igual, não mudou nada aqui) ...
                const btn = document.getElementById('btn-red-timer');
                if(this.isRunning) {
                    clearInterval(this.timer);
                    this.isRunning = false;
                    btn.classList.remove('bg-red-50', 'text-red-600', 'border-red-200');
                    btn.classList.add('bg-bg-card', 'text-brand-600');
                } else {
                    this.isRunning = true;
                    btn.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
                    btn.classList.remove('bg-bg-card', 'text-brand-600');
                    this.timer = setInterval(() => {
                        this.seconds--;
                        const h = Math.floor(this.seconds / 3600);
                        const m = Math.floor((this.seconds % 3600) / 60);
                        const s = this.seconds % 60;
                        document.getElementById('red-timer-display').innerText = 
                            `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                        if(this.seconds <= 0) this.toggleTimer();
                    }, 1000);
                }
            },

            updateStats() {
                // Agora pega de UM lugar só
                const text = document.getElementById('red-full-text').value;
                
                // Contagem de palavras
                const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
                
                // Contagem de linhas (Visual + Quebras de linha)
                // Estimativa: Caracteres / 65 (média por linha) OU quebras de linha reais
                const linesByChar = Math.ceil(text.length / 65);
                const linesByEnter = text.split('\n').length;
                const lines = Math.max(linesByChar, linesByEnter);

                document.getElementById('stat-words').innerText = words;
                document.getElementById('stat-lines').innerText = lines;
                
                // Alerta visual se passar de 30 linhas
                const statEl = document.getElementById('stat-lines');
                if (lines > 30) statEl.classList.add('text-red-500');
                else statEl.classList.remove('text-red-500');
            },

            insert(text) {
                // Insere o conectivo onde o cursor estiver
                const textarea = document.getElementById('red-full-text');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const val = textarea.value;
                
                textarea.value = val.substring(0, start) + text + val.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + text.length;
                textarea.focus();
                this.updateStats();
            },

            save() {
                const total = document.getElementById('red-total-score').innerText;
                Store.state.user.xp += parseInt(total) / 10;
                UI.toast(`Redação Salva! Nota: ${total}`, "success");
                Store.save();
                document.getElementById('modal-redacao-score').close();
            }
        };

        // =================================================================
        // INTEGRAÇÃO GEMINI AI (COM TENTATIVA AUTOMÁTICA)
        // =================================================================
        window.GeminiProcessor = {
            retryCount: 0,
            maxRetries: 3,

            analyze(isRetry = false) {
                // Se não for retentativa, reseta o contador
                if (!isRetry) this.retryCount = 0;

                const key = Store.state.settings.geminiKey;
                if (!key) {
                    alert("Configure sua API Key nas Configurações!");
                    if(window.Settings && window.Settings.tab) {
                         document.getElementById('modal-settings').showModal();
                         Settings.tab('data');
                    }
                    return;
                }

                const fullText = document.getElementById('red-full-text').value;
                if (fullText.length < 20) {
                    UI.toast("Texto muito curto para analisar.", "error");
                    return;
                }

                const btn = document.getElementById('btn-ai-analyze');
                // Só muda o texto do botão na primeira vez
                if (!isRetry) {
                    btn.dataset.original = btn.innerHTML; // Salva texto original
                    btn.disabled = true;
                    btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Analisando...`;
                }

                const prompt = `
                    Aja como um corretor oficial do ENEM. Corrija a redação abaixo.
                    REDAÇÃO: "${fullText}"
                    SAÍDA (HTML simples):
                    <h3>Nota: [0-1000]</h3>
                    <p><strong>Comentário:</strong> [Resumo]</p>
                    <ul>
                        <li><strong>C1:</strong> [Nota] - [Justificativa]</li>
                        <li><strong>C2:</strong> [Nota] - [Justificativa]</li>
                        <li><strong>C3:</strong> [Nota] - [Justificativa]</li>
                        <li><strong>C4:</strong> [Nota] - [Justificativa]</li>
                        <li><strong>C5:</strong> [Nota] - [Justificativa]</li>
                    </ul>
                    <p><strong>Dica:</strong> [Dica Prática]</p>
                `;

                // Tenta usar o modelo FLASH (mais rápido), se falhar muito, tenta o PRO
                const model = this.retryCount > 1 ? 'gemini-pro' : 'gemini-3-flash-preview';

                fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                })
                .then(r => r.json())
                .then(data => {
                    // SE DER ERRO DE "OVERLOADED" (SOBRECARGA)
                    if (data.error && (data.error.code === 503 || data.error.message.includes('overloaded'))) {
                        if (this.retryCount < this.maxRetries) {
                            this.retryCount++;
                            const delay = 2000 * this.retryCount; // Espera 2s, depois 4s...
                            
                            UI.toast(`Servidor cheio. Tentando de novo em ${delay/1000}s... (${this.retryCount}/${this.maxRetries})`, "warning");
                            btn.innerHTML = `<i class="ph-bold ph-hourglass"></i> Aguardando...`;
                            
                            setTimeout(() => this.analyze(true), delay);
                            return; // Para aqui e espera a próxima tentativa
                        } else {
                            throw new Error("O Google está muito congestionado agora. Tente daqui a pouco.");
                        }
                    }

                    if (data.error) throw new Error(data.error.message);

                    // SUCESSO
                    const aiText = data.candidates[0].content.parts[0].text.replace(/```html|```/g, '');
                    document.getElementById('ai-content').innerHTML = aiText;
                    document.getElementById('modal-ai-result').showModal();
                    
                    Store.state.user.xp += 50;
                    Store.save();
                    
                    // Reseta botão
                    btn.disabled = false;
                    btn.innerHTML = btn.dataset.original;
                })
                .catch(err => {
                    console.error(err);
                    UI.toast("Erro: " + err.message, "error");
                    btn.disabled = false;
                    btn.innerHTML = btn.dataset.original;
                });
            }
        };

        // =================================================================
        // LOUSA VIRTUAL AVANÇADA
        // =================================================================
        window.Whiteboard = {
            canvas: null,
            ctx: null,
            isDrawing: false,
            
            // Estado Atual
            currentTool: 'pen', // 'pen' ou 'eraser'
            color: '#3b82f6',
            size: 3,
            lastX: 0,
            lastY: 0,

            open() {
                const modal = document.getElementById('modal-whiteboard');
                modal.showModal();
                
                // Configura o canvas se for a primeira vez
                if (!this.canvas) {
                    this.init();
                    // Define o tamanho inicial para preencher a tela
                    this.resize(); 
                }
            },

            init() {
                this.canvas = document.getElementById('whiteboard-canvas');
                this.ctx = this.canvas.getContext('2d');

                // Mouse Events
                this.canvas.addEventListener('mousedown', (e) => this.start(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stop());
                this.canvas.addEventListener('mouseout', () => this.stop());

                // Touch Events (Celular/Tablet)
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    // Simula evento de mouse
                    const mouseEvent = new MouseEvent("mousedown", {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                }, { passive: false });

                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent("mousemove", {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                }, { passive: false });

                this.canvas.addEventListener('touchend', () => this.stop());

                // Redimensionar tela
                window.addEventListener('resize', () => this.resize());
            },

            resize() {
                // OBS: Ao redimensionar o canvas, o desenho some. 
                // Para manter, precisaríamos salvar a imagem em memória.
                // Como é rascunho, vamos apenas resetar o tamanho.
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                // Reconfigura o contexto (perde-se ao redimensionar)
                this.updateContext();
            },

            // --- FERRAMENTAS ---

            setTool(tool) {
                this.currentTool = tool;
                
                // Atualiza visual dos botões
                const btnPen = document.getElementById('btn-tool-pen');
                const btnEraser = document.getElementById('btn-tool-eraser');

                if (tool === 'pen') {
                    btnPen.className = "p-2 rounded-lg bg-blue-600 text-white transition-all shadow-lg scale-110";
                    btnEraser.className = "p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition-all";
                    this.canvas.style.cursor = "crosshair";
                    
                    // Se a borracha estava gigante, volta o pincel para um tamanho normal (opcional)
                    if(this.size > 20) { this.setSize(3); document.querySelector('input[type=range]').value = 3; }
                    
                } else {
                    btnEraser.className = "p-2 rounded-lg bg-white text-slate-900 transition-all shadow-lg scale-110";
                    btnPen.className = "p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition-all";
                    this.canvas.style.cursor = "cell"; // Cursor de borracha
                    
                    // Aumenta o tamanho automaticamente para facilitar apagar
                    this.setSize(30); 
                    document.querySelector('input[type=range]').value = 30;
                }
                
                this.updateContext();
            },

            setColor(hex) {
                this.color = hex;
                this.setTool('pen'); // Se mudou cor, volta para pincel
                this.updateContext();
            },

            setSize(val) {
                this.size = parseInt(val);
                document.getElementById('wb-size-val').innerText = val + 'px';
                this.updateContext();
            },

            updateContext() {
                if(!this.ctx) return;
                
                this.ctx.lineWidth = this.size;
                this.ctx.lineCap = 'round'; // Ponta redonda
                this.ctx.lineJoin = 'round'; // Curva suave

                if (this.currentTool === 'eraser') {
                    // MODO BORRACHA: "destination-out" torna os pixels transparentes
                    this.ctx.globalCompositeOperation = 'destination-out';
                } else {
                    // MODO PINCEL: "source-over" desenha por cima
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.strokeStyle = this.color;
                }
            },

            clear() {
                if(confirm("Limpar todo o quadro?")) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    UI.toast("Quadro limpo", "info");
                }
            },

            // --- DESENHO ---

            start(e) {
                this.isDrawing = true;
                this.lastX = e.clientX - this.canvas.offsetLeft;
                this.lastY = e.clientY - this.canvas.offsetTop;
            },

            draw(e) {
                if (!this.isDrawing) return;
                
                const currentX = e.clientX - this.canvas.offsetLeft;
                const currentY = e.clientY - this.canvas.offsetTop;

                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(currentX, currentY);
                this.ctx.stroke();

                this.lastX = currentX;
                this.lastY = currentY;
            },

            stop() {
                this.isDrawing = false;
            }
        };

        // =================================================================
        // SIMULADO (Item 8)
        // =================================================================
        window.Simulado = {
            currentQuestions: [],
            answers: {},

            start(qty) {
                if(Store.state.quiz.length < qty) {
                    if(!confirm(`Você tem apenas ${Store.state.quiz.length} questões. Iniciar com todas?`)) return;
                    qty = Store.state.quiz.length;
                }
                
                // Shuffle simples
                const shuffled = [...Store.state.quiz].sort(() => 0.5 - Math.random());
                this.currentQuestions = shuffled.slice(0, qty);
                this.answers = {};

                document.getElementById('sim-start').classList.add('hidden');
                document.getElementById('sim-result').classList.add('hidden');
                document.getElementById('sim-exam').classList.remove('hidden');
                
                this.renderQuestions();
            },

            renderQuestions() {
                const container = document.getElementById('sim-questions');
                container.innerHTML = this.currentQuestions.map((q, idx) => `
                    <div class="bg-card p-6 rounded-2xl border border-slate-200/10">
                        <div class="flex justify-between mb-4">
                            <span class="font-bold text-brand-600">Questão ${idx+1}</span>
                            <span class="text-xs bg-bg-main px-2 py-1 rounded border border-slate-200/10">${q.topic}</span>
                        </div>
                        <p class="text-txt-main mb-6 leading-relaxed text-sm">${q.text}</p>
                        <div class="space-y-2">
                            ${q.options.map((opt, i) => `
                                <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200/10 hover:bg-brand-50 cursor-pointer transition-colors">
                                    <input type="radio" name="sim-q-${q.id}" value="${i}" class="accent-brand-600 w-4 h-4" onchange="Simulado.answers['${q.id}'] = ${i}">
                                    <span class="text-sm text-txt-muted">${opt}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            },

            finish() {
                if(!confirm("Entregar prova e ver resultado?")) return;
                
                let hits = 0;
                this.currentQuestions.forEach(q => {
                    if(this.answers[q.id] === q.correctIndex) hits++;
                });

                const score = Math.round((hits / this.currentQuestions.length) * 100);
                
                document.getElementById('sim-exam').classList.add('hidden');
                document.getElementById('sim-result').classList.remove('hidden');
                document.getElementById('sim-score-display').innerText = `${score}%`;
                
                let msg = "";
                if(score === 100) msg = "Perfeito! Você destruiu!";
                else if(score >= 80) msg = "Excelente desempenho!";
                else if(score >= 50) msg = "Na média, continue estudando.";
                else msg = "Precisa revisar mais...";
                
                document.getElementById('sim-msg').innerText = `${msg} (${hits}/${this.currentQuestions.length} acertos)`;
                
                Store.state.user.xp += (hits * 10) + (score > 80 ? 100 : 0);
                Store.save();
            },

            close() {
                document.getElementById('sim-result').classList.add('hidden');
                document.getElementById('sim-start').classList.remove('hidden');
            }
        };
        
        // =================================================================
        // SISTEMA DE TIMER (POMODORO)
        // =================================================================
        window.Timer = {
            interval: null,
            seconds: 25 * 60,
            isRunning: false,
            
            set(timer) {
                const inp = document.getElementById('timer-input');
                inp.value = `${timer}`;
                Timer.saveEdit();
            },

            toggle() {
                const btn = document.getElementById('btn-timer-main');
                if(this.isRunning) {
                    clearInterval(this.interval);
                    this.isRunning = false;
                    btn.innerHTML = '<i class="ph-fill ph-play"></i>';
                } else {
                    // Previne iniciar com 0 ou negativo
                    if (this.seconds <= 0) this.seconds = 25 * 60;

                    this.isRunning = true;
                    btn.innerHTML = '<i class="ph-fill ph-pause"></i>';
                    this.interval = setInterval(() => {
                        this.seconds--;
                        this.updateDisplay();
                        if(this.seconds <= 0) {
                            clearInterval(this.interval);
                            this.isRunning = false;
                            
                            // FIX: Resetar botão e tempo para o próximo ciclo
                            btn.innerHTML = '<i class="ph-fill ph-play"></i>';
                            this.seconds = 25 * 60;
                            this.updateDisplay();

                            // Tenta tocar audio
                            try { new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play(); } catch(e){}
                            Store.state.user.xp += 100;
                            UI.toast("Foco Concluído! +100XP", "success");
                            Store.save();
                        }
                    }, 1000);
                }
            },
            
            updateDisplay() {
                const m = Math.floor(this.seconds / 60).toString().padStart(2, '0');
                const s = (this.seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
                document.title = `${m}:${s} - Orbit`;
            },
            
            edit() {
                if(this.isRunning) return;
                const disp = document.getElementById('timer-display');
                const inp = document.getElementById('timer-input');
                inp.value = disp.innerText;
                disp.classList.add('hidden');
                inp.classList.remove('hidden');
                inp.focus();
            },
            
            saveEdit() {
                const inp = document.getElementById('timer-input');
                const parts = inp.value.split(':');
                if(parts.length > 0) {
                    const m = parseInt(parts[0]) || 25;
                    const s = parseInt(parts[1]) || 0;
                    this.seconds = m * 60 + s;
                    this.updateDisplay();
                }
                inp.classList.add('hidden');
                document.getElementById('timer-display').classList.remove('hidden');
            },

            reset() {
                clearInterval(this.interval);
                this.isRunning = false;
                this.seconds = 25 * 60;
                this.updateDisplay();
                document.getElementById('btn-timer-main').innerHTML = '<i class="ph-fill ph-play"></i>';
            }
        };

        // =================================================================
        // ESTADO GLOBAL DA APLICAÇÃO (DATA STORE)
        // =================================================================
        const Store = {
            state: {
                user: { xp: 0, level: 1, streak: 0, inventory: [], name: 'Visitante' },
                settings: { theme: 'light', keybinds: { 'zen': 'z', 'new': 'n' } },
                week: { 'segunda': [], 'terca': [], 'quarta': [], 'quinta': [], 'sexta': [], 'sabado': [], 'domingo': [] },
                anchors: [], 
                quiz: [], 
                quizHistory: [], // NOVO: Histórico para corrigir stats ao deletar
                stats: { hits: 0, misses: 0 },
                mindmaps: [], 
                trash: [], 
                lastLogin: null
            },
            firebase: { db: null, auth: null, userRef: null },

            init() {
                // Carregar LocalStorage
                try {
                    const local = localStorage.getItem('orbit_v7_state');
                    if(local) {
                        const parsed = JSON.parse(local);
                        this.state = { ...this.state, ...parsed };
                        
                        // Migração de dados legados
                        if(parsed.mindmap && (!this.state.mindmaps || this.state.mindmaps.length === 0)) {
                            this.state.mindmaps = [{
                                id: 'default-' + Date.now(),
                                name: 'Rascunho Geral',
                                subject: 'Geral',
                                nodes: parsed.mindmap.nodes || [],
                                lines: parsed.mindmap.lines || [],
                                createdAt: Date.now()
                            }];
                            delete this.state.mindmap;
                            this.save();
                        }
                    }
                } catch(e) { console.error("Erro no State:", e); }

                if(!this.state.mindmaps) this.state.mindmaps = [];
                if(!this.state.quizHistory) this.state.quizHistory = []; // Garante array se migrando de versão antiga

                // Conectar Firebase Automaticamente
                this.connectFirebase(embeddedFirebaseConfig);
                
                // Verificações
                this.checkDailyReset();
                this.cleanTrash();
                Settings.setTheme(this.state.settings.theme);
                
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                    document.getElementById('app-layout').classList.remove('opacity-0');
                }, 800);

                UI.renderAll();
                setTimeout(() => MindMap.renderExplorer(), 100);

                if (this.state.settings.geminiKey) {
                    const inputKey = document.getElementById('sett-gemini-key');
                    if(inputKey) inputKey.placeholder = "Chave salva e segura (Oculta)";
                }
            },

            save() {
            // TRAVA DE SEGURANÇA MÁXIMA
            if (window.isResetting === true) return;

                // ... resto do código ...
                localStorage.setItem('orbit_v7_state', JSON.stringify(this.state));
                if(this.firebase.userRef) {
                    setDoc(this.firebase.userRef, this.state, {merge: true}).catch(console.error);
                }
                if(window.UI) UI.renderStats();
            },

            async connectFirebase(config) {
                try {
                    const app = initializeApp(config);
                    this.firebase.auth = getAuth(app);
                    this.firebase.db = getFirestore(app);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'orbit-v7';
                    
                    // Auth Logic Mandated by System Rules
                    // FIX: Envolver em try/catch para ignorar erro de token mismatch em projetos customizados
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(this.firebase.auth, __initial_auth_token);
                        }
                    } catch (e) {
                        console.warn("Token do sistema ignorado (Projeto Customizado):", e.code);
                        // Se falhar o token customizado, tentamos anônimo se não houver usuário persistido
                        if (!this.firebase.auth.currentUser) {
                             // Opcional: await signInAnonymously(this.firebase.auth);
                             // Deixamos sem nada para o onAuthStateChanged decidir ou o usuário clicar em logar
                        }
                    }

                    onAuthStateChanged(this.firebase.auth, (u) => {
                        if(u && !u.isAnonymous) {
                            // CORREÇÃO CRÍTICA DE CAMINHO (PATH FIX)
                            this.firebase.userRef = doc(this.firebase.db, 'artifacts', appId, 'users', u.uid, 'data', 'orbit_state');
                            
                            document.getElementById('user-name').innerText = u.displayName || "Usuário";
                            document.getElementById('user-avatar').src = u.photoURL || "https://ui-avatars.com/api/?name=User&background=random";
                            document.getElementById('btn-auth').innerHTML = `<span>Sair</span> <i class="ph-bold ph-sign-out"></i>`;
                            document.getElementById('btn-auth').onclick = Auth.logout;
                            
                            onSnapshot(this.firebase.userRef, (snap) => {
                                if(snap.exists()) {
                                    this.state = {...this.state, ...snap.data()};
                                    UI.renderAll();
                                    MindMap.renderExplorer();
                                    if(MindMap.currentMap) MindMap.render(); 
                                }
                            });
                        } else {
                            // Usuário anônimo ou deslogado
                            document.getElementById('user-name').innerText = "Visitante";
                            document.getElementById('btn-auth').innerHTML = `<span>Entrar com Google</span> <i class="ph-bold ph-google-logo"></i>`;
                            document.getElementById('btn-auth').onclick = Auth.login;
                        }
                    });
                } catch(e) { console.error("Erro Firebase", e); UI.toast("Erro na conexão Cloud", "error"); }
            },

            checkDailyReset() {
                const now = new Date();
                const formatter = new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Sao_Paulo', year: 'numeric', month: '2-digit', day: '2-digit' });
                const todayStr = formatter.format(now);

                if (this.state.lastLogin !== todayStr) {
                    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = formatter.format(yesterday);

                    // Streak lógica: Se logou ontem, aumenta. Se não, reseta.
                    if (this.state.lastLogin === yesterdayStr) this.state.user.streak++;
                    else if (this.state.lastLogin) this.state.user.streak = 0; // Resetou

                    this.state.anchors.forEach(a => a.completed = false);
                    this.state.lastLogin = todayStr;
                    this.save();
                }
            },
            
            incrementStreak() {
                // Função para garantir que streak aumente com atividade
                // Se o usuário ainda não ganhou streak hoje por atividade (opcional), poderia ser implementado
                // Por enquanto, apenas salva o estado atual
                this.save();
            },

            cleanTrash() {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                this.state.trash = this.state.trash.filter(item => (now - item.dateDeleted) < oneDay);
            }
        };

        // =================================================================
        // AUTH
        // =================================================================
        window.Auth = {
            login() {
                if(Store.firebase.auth) {
                    const provider = new GoogleAuthProvider();
                    signInWithPopup(Store.firebase.auth, provider)
                        .then((result) => {
                            UI.toast("Conectado: " + result.user.displayName, "success");
                            // Recarrega para garantir sync limpo se necessário, ou deixa o listener lidar
                        })
                        .catch(e => UI.toast("Erro login Google: " + e.message, "error"));
                } else {
                    UI.toast("Erro no módulo Auth", "error");
                }
            },
            logout() {
                if(Store.firebase.auth) signOut(Store.firebase.auth);
                location.reload();
            }
        };



        // =================================================================
        // UI & RENDERIZADORES
        // =================================================================
        const UI = {
            renderAll() {
                this.renderDashboard();
                this.renderCronograma();
                this.renderStats();
                Quiz.render();
                Shop.render();
                
                const dateOpts = { weekday: 'long', day: 'numeric', month: 'long' };
                document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', dateOpts);
            },

            renderStats() {
                const currentXP = Store.state.user.xp;
                const nextLevel = Store.state.user.level * 1000;
                const pct = (currentXP % 1000) / 10;
                
                document.getElementById('display-xp').innerText = `${currentXP} XP`;
                document.getElementById('stat-level').innerText = `Nível ${Store.state.user.level}`;
                document.getElementById('stat-xp-detail').innerText = `${currentXP}/${nextLevel} XP`;
                document.getElementById('xp-bar').style.width = `${pct}%`;
                document.getElementById('stat-streak').innerText = `${Store.state.user.streak} Dias`;
                document.getElementById('shop-balance').innerText = `${currentXP} XP`;
            },

            renderDashboard() {
                const agrid = document.getElementById('anchors-grid');
                agrid.innerHTML = Store.state.anchors.map((a, i) => `
                    <div onclick="Actions.toggleAnchor(${i})" class="bg-card p-4 rounded-2xl border ${a.completed ? 'border-brand-500 bg-brand-50' : 'border-slate-200/10'} hover:scale-[1.02] transition-all cursor-pointer select-none relative group">
                        <button onclick="event.stopPropagation(); Actions.deleteAnchor(${i})" class="absolute top-2 right-2 text-txt-muted hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-bold ph-trash"></i></button>
                        <i class="ph-fill ph-${a.icon} text-2xl ${a.completed ? 'text-brand-600' : 'text-txt-muted'} mb-2 block"></i>
                        <span class="font-bold text-sm text-txt-main ${a.completed ? 'line-through opacity-50' : ''}">${a.title}</span>
                    </div>
                `).join('');
                
                const days = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                const dayKey = days[new Date().getDay()];
                const tasks = Store.state.week[dayKey] || [];
                const done = tasks.filter(t => t.completed).length;
                document.getElementById('stat-tasks-done').innerText = `${done}/${tasks.length}`;
                
                const tContainer = document.getElementById('today-tasks');
                if (tasks.length === 0) {
                    tContainer.innerHTML = `<i class="ph-duotone ph-coffee text-4xl mb-2"></i><p class="text-sm">Livre por hoje!</p>`;
                } else {
                    tContainer.classList.remove('items-center', 'justify-center');
                    tContainer.innerHTML = `<div class="w-full space-y-2">${tasks.map(t => this.generateTaskHTML(t, dayKey)).join('')}</div>`;
                }
            },

            renderCronograma() {
                const map = { 'segunda': 'Seg', 'terca': 'Ter', 'quarta': 'Qua', 'quinta': 'Qui', 'sexta': 'Sex', 'sabado': 'Sáb', 'domingo': 'Dom' };
                
                // CORREÇÃO: Definimos a ordem exata aqui
                const daysOrder = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'];
                
                const container = document.getElementById('week-columns');
                
                container.innerHTML = daysOrder.map(day => {
                    const tasks = Store.state.week[day] || [];
                    
                    return `
                    <div class="w-72 bg-card rounded-2xl border border-slate-200/10 flex flex-col h-full shrink-0 shadow-sm snap-center">
                        <div class="p-4 border-b border-slate-200/10 flex justify-between items-center bg-bg-main/50 rounded-t-2xl">
                            <span class="font-bold text-txt-main">${map[day]}</span>
                            <button onclick="Actions.openTaskModal('${day}')" class="w-8 h-8 rounded-lg hover:bg-brand-100 text-brand-600 flex items-center justify-center transition-colors"><i class="ph-bold ph-plus"></i></button>
                        </div>
                        <div class="p-3 flex-1 overflow-y-auto space-y-3 custom-scrollbar">
                            ${tasks.map(t => this.generateTaskHTML(t, day)).join('')}
                        </div>
                    </div>
                `}).join('');
            },

            generateTaskHTML(t, day) {
                return `
                <div class="group bg-bg-main p-3 rounded-xl border ${t.completed ? 'border-brand-200 bg-brand-50/30' : 'border-slate-200/10'} hover:border-brand-300 transition-all shadow-sm">
                    <div class="flex items-start gap-3">
                        <div onclick="Actions.toggleTask('${day}', '${t.id}')" class="mt-1 w-5 h-5 rounded border cursor-pointer flex items-center justify-center transition-colors ${t.completed ? 'bg-brand-500 border-brand-500 text-white' : 'border-slate-300 bg-white'}">
                            ${t.completed ? '<i class="ph-bold ph-check text-xs"></i>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold text-txt-main truncate ${t.completed ? 'line-through text-txt-muted' : ''}">${t.title}</p>
                            <div class="flex items-center gap-2 mt-1">
                                ${t.tag ? `<span class="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded font-bold">${t.tag}</span>` : ''}
                                ${t.pomodoros ? `<button title="Tempo pomodoro" onclick="Timer.set(${t.pomodoros}), router('foco', true)" class="text-[10px] px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded font-bold flex items-center gap-1"><i class="ph-fill ph-clock"></i> ${t.pomodoros}m</button>` : ''}
                            </div>
                        </div>
                        <div class="hidden group-hover:flex flex-col gap-1">
                            <button onclick="Actions.addSubtask('${day}', '${t.id}')" class="text-txt-muted hover:text-brand-600" title="Add Subtarefa"><i class="ph-bold ph-list-plus"></i></button>
                            <button onclick="Actions.deleteTask('${day}', '${t.id}')" class="text-txt-muted hover:text-red-500" title="Excluir"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                    
                    ${(t.subtasks && t.subtasks.length > 0) ? `
                        <div class="mt-3 pl-3 border-l-2 border-slate-100 space-y-1">
                            ${t.subtasks.map((st, idx) => `
                                <div class="flex items-center gap-2 text-xs text-txt-muted group/sub">
                                    <input type="checkbox" ${st.checked ? 'checked' : ''} onchange="Actions.toggleSubtask('${day}', '${t.id}', ${idx})" class="accent-brand-500 w-3 h-3 cursor-pointer">
                                    <span class="${st.checked ? 'line-through' : ''} flex-1 truncate">${st.text}</span>
                                    <button onclick="Actions.deleteSubtask('${day}', '${t.id}', ${idx})" class="opacity-0 group-hover/sub:opacity-100 hover:text-red-500"><i class="ph-bold ph-x"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>`;
            },

            toast(msg, type='info') {
                const el = document.createElement('div');
                const colors = { success: 'bg-emerald-600', error: 'bg-red-500', info: 'bg-slate-800' };
                el.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg shadow-black/10 text-xs font-bold flex items-center gap-2 animate-slide-up backdrop-blur-md`;
                el.innerHTML = msg;
                document.getElementById('toast-area').appendChild(el);
                setTimeout(() => el.remove(), 3500);
            }
        };

        // =================================================================
        // AÇÕES DO CRONOGRAMA (CORRIGIDO)
        // =================================================================
        window.Actions = {
            activeDay: null,
            
            openTaskModal(day) {
                this.activeDay = day;
                document.getElementById('task-text').value = '';
                document.getElementById('task-time').value = '';
                document.getElementById('task-duration').value = '25'; // Padrão 25min
                document.getElementById('modal-task').showModal();
            },

            addTask() {
                const text = document.getElementById('task-text').value;
                const tag = document.getElementById('task-tag').value;
                const time = document.getElementById('task-time').value;
                const duration = document.getElementById('task-duration').value; // Pega os minutos

                if(text) {
                    if(!Store.state.week[this.activeDay]) Store.state.week[this.activeDay] = [];
                    
                    Store.state.week[this.activeDay].push({ 
                        id: Date.now(), 
                        text, 
                        tag, 
                        time, 
                        pomodoros: duration ? parseInt(duration) : null, // Salva para usar no seu botão
                        done: false 
                    });
                    
                    Store.save();
                    UI.renderCronograma();
                    document.getElementById('modal-task').close();
                }
            },

            toggleTask(day, id) {
                const task = Store.state.week[day].find(t => t.id === id);
                if(task) {
                    task.done = !task.done;
                    if(task.done) {
                        Store.state.user.xp += 50;
                        UI.toast(`Tarefa concluída! +50 XP`, "success");
                    } else {
                        Store.state.user.xp = Math.max(0, Store.state.user.xp - 50);
                        UI.toast(`Tarefa reaberta. -50 XP`, "error");
                    }
                    Store.save();
                    UI.renderCronograma();
                }
            },

            deleteTask(day, id) {
                if(confirm("Apagar tarefa?")) {
                    Store.state.week[day] = Store.state.week[day].filter(t => t.id !== id);
                    Store.save();
                    UI.renderCronograma();
                }
            }
        };

        // Adicione essa linha no final do script para garantir compatibilidade se o HTML antigo chamar addTask()
        window.addTask = window.Actions.addTask; 

        // =================================================================
        // ATUALIZAÇÃO DO UI (Com seu botão de Pomodoro)
        // =================================================================
        // Substitua a função generateTaskHTML dentro do objeto UI por esta:
        
        UI.generateTaskHTML = function(t, day) {
            const colors = { 
                atividades: 'bg-yellow-100 text-yellow-700 border-yellow-200', 
                matematica: 'bg-blue-100 text-blue-700 border-blue-200', 
                natureza: 'bg-green-100 text-green-700 border-green-200', 
                humanas: 'bg-orange-100 text-orange-700 border-orange-200',
                linguagens: 'bg-purple-100 text-purple-700 border-purple-200',
                redacao: 'bg-pink-100 text-pink-700 border-pink-200'
            };
            const c = colors[t.tag] || 'bg-slate-100 text-slate-700';
            
            // Badge do Horário (Agendamento)
            const timeBadge = t.time 
                ? `<div class="flex items-center gap-1 text-[10px] font-mono font-bold text-txt-muted bg-bg-main px-1.5 py-0.5 rounded border border-slate-200/10"><i class="ph-bold ph-clock"></i> ${t.time}</div>` 
                : '';

            // SEU BOTÃO DE POMODORO (Inserido aqui)
            const pomodoroBtn = t.pomodoros 
                ? `<button title="Iniciar Foco" onclick="Timer.set(${t.pomodoros}); router('foco')" class="text-[10px] px-2 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 rounded-lg font-bold flex items-center gap-1 transition-colors"><i class="ph-fill ph-timer"></i> ${t.pomodoros}m</button>` 
                : '';

            return `
            <div class="group bg-bg-main p-3 rounded-xl border border-slate-200/10 hover:border-brand-400 transition-all shadow-sm relative ${t.done ? 'opacity-50 grayscale' : ''}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-md border ${c}">${t.tag}</span>
                    <div class="flex gap-2">
                        ${pomodoroBtn}
                        ${timeBadge}
                    </div>
                </div>
                
                <p class="text-sm font-medium text-txt-main mb-3 leading-tight ${t.done ? 'line-through' : ''}">${t.text}</p>
                
                <div class="flex justify-between items-center mt-2 border-t border-slate-100 dark:border-slate-800 pt-2">
                    <button onclick="Actions.toggleTask('${day}', ${t.id})" class="text-xs font-bold ${t.done ? 'text-green-600' : 'text-txt-muted hover:text-brand-600'} flex items-center gap-1">
                        <i class="ph-bold ${t.done ? 'ph-check-circle' : 'ph-circle'} text-lg"></i> ${t.done ? 'Feito' : 'Concluir'}
                    </button>
                    <button onclick="Actions.deleteTask('${day}', ${t.id})" class="text-txt-muted hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                </div>
            </div>`;
        };

        // =================================================================
        // MAPA MENTAL AVANÇADO (Pan & Mobile)
        // =================================================================
        window.MindMap = {
            drag: { active: false, node: null, offset: {x:0, y:0} },
            pan: { active: false, start: {x:0, y:0}, offset: {x:0, y:0} },
            selected: null,
            canvas: null,
            currentMap: null,
            isReadOnly: false,

            init() {
                this.canvas = document.getElementById('mm-viewport');
                const world = document.getElementById('mm-world');
                
                // --- Eventos de Mouse ---
                this.canvas.addEventListener('mousedown', (e) => this.onStart(e));
                window.addEventListener('mousemove', (e) => this.onMove(e));
                window.addEventListener('mouseup', () => this.onEnd());
                
                // --- Eventos de Touch (Mobile) ---
                this.canvas.addEventListener('touchstart', (e) => this.onStart(e), {passive: false});
                window.addEventListener('touchmove', (e) => this.onMove(e), {passive: false});
                window.addEventListener('touchend', () => this.onEnd());

                this.canvas.addEventListener('dblclick', (e) => {
                    if(e.target === this.canvas || e.target.id === 'mm-svg' || e.target.classList.contains('mindmap-bg')) {
                        if(!this.isReadOnly) this.addNodeAt(e.offsetX - this.pan.offset.x, e.offsetY - this.pan.offset.y);
                    }
                });
            },

            // Unifica Mouse e Touch
            getPoint(e) {
                if(e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                return { x: e.clientX, y: e.clientY };
            },

            onStart(e) {
                const pt = this.getPoint(e);
                const target = e.target;
                
                // 1. Verificar se clicou em um NÓ
                const nodeEl = target.closest('.mm-node');
                
                if (nodeEl && !this.isReadOnly) {
                    // Lógica de Nó
                    const rect = nodeEl.getBoundingClientRect();
                    // Área de Resize (canto inferior direito)
                    if (pt.x > rect.right - 20 && pt.y > rect.bottom - 20) {
                        return; // Deixa o navegador fazer o resize nativo
                    }

                    e.stopPropagation();
                    const id = parseInt(nodeEl.id.replace('node-', ''));
                    
                    // CTRL + Click (Conectar)
                    if(e.ctrlKey) {
                        if(this.selected && this.selected !== id) {
                            this.currentMap.lines.push({from: this.selected, to: id});
                            this.selected = null;
                            UI.toast("Conectado!");
                        } else {
                            this.selected = id;
                            UI.toast("Selecione outro para conectar");
                        }
                    } else {
                        // Iniciar Arrasto do Nó
                        this.selected = id;
                        const n = this.currentMap.nodes.find(node => node.id === id);
                        if(n && n.color) document.getElementById('mm-color-picker').value = n.color;

                        this.drag.active = true;
                        this.drag.node = n;
                        
                        // Offset relativo ao mundo (considerando o pan atual)
                        // Posição Real do Mouse no Mundo = (MouseClient - CanvasRect) - PanOffset
                        const canvasRect = this.canvas.getBoundingClientRect();
                        const worldMouseX = pt.x - canvasRect.left - this.pan.offset.x;
                        const worldMouseY = pt.y - canvasRect.top - this.pan.offset.y;
                        
                        this.drag.offset = {
                            x: worldMouseX - n.x,
                            y: worldMouseY - n.y
                        };
                    }
                    this.render();
                } else {
                    // 2. Clicou no Fundo -> Pan (Mover câmera)
                    this.selected = null;
                    this.pan.active = true;
                    this.pan.start = { x: pt.x - this.pan.offset.x, y: pt.y - this.pan.offset.y };
                    this.render();
                }
            },

            onMove(e) {
                const pt = this.getPoint(e);
                
                if (this.drag.active && this.drag.node) {
                    e.preventDefault(); // Evita scroll no mobile
                    const canvasRect = this.canvas.getBoundingClientRect();
                    const worldMouseX = pt.x - canvasRect.left - this.pan.offset.x;
                    const worldMouseY = pt.y - canvasRect.top - this.pan.offset.y;

                    this.drag.node.x = worldMouseX - this.drag.offset.x;
                    this.drag.node.y = worldMouseY - this.drag.offset.y;
                    this.render();
                } 
                else if (this.pan.active) {
                    e.preventDefault();
                    this.pan.offset.x = pt.x - this.pan.start.x;
                    this.pan.offset.y = pt.y - this.pan.start.y;
                    this.updateWorldTransform();
                }
            },

            onEnd() {
                if (this.drag.active) {
                    this.drag.active = false;
                    this.drag.node = null;
                    Store.save();
                }
                if (this.pan.active) {
                    this.pan.active = false;
                }

                if(this.selected && this.currentMap) {
                    const el = document.getElementById(`node-${this.selected}`);
                    if (!el) return;

                    const n = this.currentMap.nodes.find(node => node.id === this.selected);
                    if(n && (el.offsetWidth !== n.width || el.offsetHeight !== n.height)) {
                        n.width = el.offsetWidth;
                        n.height = el.offsetHeight;
                        Store.save();
                        this.render();
                    }
                }
            },

            updateWorldTransform() {
                const world = document.getElementById('mm-world');
                if(world) world.style.transform = `translate(${this.pan.offset.x}px, ${this.pan.offset.y}px)`;
            },

            render() {
                if(!this.currentMap) return;
                const l = document.getElementById('mm-nodes-layer');
                const svg = document.getElementById('mm-svg');
                const nodes = this.currentMap.nodes || [];
                const lines = this.currentMap.lines || [];

                if(svg) {
                    svg.innerHTML = lines.map(line => {
                        const n1 = nodes.find(n => n.id === line.from);
                        const n2 = nodes.find(n => n.id === line.to);
                        if(n1 && n2) {
                            // Calcula o centro baseado no tamanho salvo ou padrão
                            const w1 = parseInt(n1.width) || 140; const h1 = parseInt(n1.height) || 60;
                            const w2 = parseInt(n2.width) || 140; const h2 = parseInt(n2.height) || 60;
                            return `<line x1="${n1.x + w1/2 + 5000}" y1="${n1.y + h1/2 + 5000}" x2="${n2.x + w2/2 + 5000}" y2="${n2.y + h2/2 + 5000}" stroke="#94a3b8" stroke-width="2" />`;
                        }
                        return '';
                    }).join('');
                }

                if(l) {
                    l.innerHTML = nodes.map(n => {
                        const isSelected = this.selected === n.id;
                        // Força a borda transparente se não selecionado para ficar bonito com cor cheia
                        const borderStyle = isSelected ? `border-color: var(--text-main);` : `border-color: transparent;`;
                        const bgStyle = `background-color: ${n.color || 'var(--brand-500)'};`;
                        // APLICA O TAMANHO SALVO AQUI
                        const sizeStyle = n.width ? `width:${n.width}px; height:${n.height}px;` : '';
                        
                        return `
                        <div id="node-${n.id}" class="mm-node ${isSelected ? 'selected' : ''}" 
                             style="transform: translate(${n.x}px, ${n.y}px); ${bgStyle} ${borderStyle} ${sizeStyle}"
                             onmousedown="MindMap.onNodeDown(event, ${n.id})"
                             onmouseup="MindMap.onNodeUp(event, ${n.id})">
                            <textarea oninput="MindMap.updateText(${n.id}, this.value)" onmousedown="event.stopPropagation()">${n.text}</textarea>
                        </div>`;
                    }).join('');
                }
            },

            // 2. Impede que o arraste comece se você clicar na pontinha de redimensionar
            onNodeDown(e, id) {
                const el = e.currentTarget;
                const rect = el.getBoundingClientRect();
                // Se clicar nos ultimos 20px (canto inferior direito), é resize, não drag
                if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) {
                    e.stopPropagation();
                    return; 
                }

                e.stopPropagation();
                // Lógica de Conexão com CTRL
                if(e.ctrlKey) {
                    if(this.selected && this.selected !== id) {
                        this.currentMap.lines.push({from: this.selected, to: id});
                        this.selected = null;
                        UI.toast("Conectado!");
                    } else {
                        this.selected = id;
                        UI.toast("Selecione outro para conectar");
                    }
                    this.render();
                    return;
                }

                // Inicia Drag
                this.selected = id;
                const n = this.currentMap.nodes.find(node => node.id === id);
                if(n && n.color) document.getElementById('mm-color-picker').value = n.color;

                this.drag.active = true;
                this.drag.node = n;
                
                const canvasRect = this.canvas.getBoundingClientRect();
                const worldMouseX = (e.touches ? e.touches[0].clientX : e.clientX) - canvasRect.left - this.pan.offset.x;
                const worldMouseY = (e.touches ? e.touches[0].clientY : e.clientY) - canvasRect.top - this.pan.offset.y;
                
                this.drag.offset = { x: worldMouseX - n.x, y: worldMouseY - n.y };
                this.render();
            },

            // 3. SALVA O NOVO TAMANHO QUANDO VOCÊ SOLTA O MOUSE
            onNodeUp(e, id) {
                const el = document.getElementById(`node-${id}`);
                const n = this.currentMap.nodes.find(node => node.id === id);
                
                if(el && n) {
                    if(el.offsetWidth !== n.width || el.offsetHeight !== n.height) {
                        n.width = el.offsetWidth;
                        n.height = el.offsetHeight;
                        Store.save();
                        this.render();
                    }
                }
            },

            toggleViewMode() {
                this.isReadOnly = !this.isReadOnly;
                const ws = document.getElementById('mm-workspace');
                const btn = document.getElementById('btn-mm-view');
                const indicator = document.getElementById('indicator-readonly');
                
                if(this.isReadOnly) {
                    ws.classList.add('readonly');
                    btn.classList.add('bg-brand-100', 'text-brand-700');
                    indicator.classList.remove('hidden');
                    UI.toast("Modo Visualização Ativado");
                } else {
                    ws.classList.remove('readonly');
                    btn.classList.remove('bg-brand-100', 'text-brand-700');
                    indicator.classList.add('hidden');
                    UI.toast("Modo Edição");
                }
            },

            renderExplorer() {
                const list = document.getElementById('mm-list');
                const maps = Store.state.mindmaps || [];
                const grouped = maps.reduce((acc, map) => {
                    const subj = map.subject || 'Geral';
                    if(!acc[subj]) acc[subj] = [];
                    acc[subj].push(map); return acc;
                }, {});

                if(maps.length === 0) { list.innerHTML = `<div class="col-span-full text-center py-12 opacity-50">Nenhum mapa criado.</div>`; return; }

                let html = '';
                for(const [subj, items] of Object.entries(grouped)) {
                    html += `<div class="col-span-full font-bold text-xs text-txt-muted uppercase mt-4 mb-2 tracking-wider">${subj}</div>`;
                    items.forEach(map => {
                        html += `
                        <div class="bg-card p-6 rounded-2xl border border-slate-200/10 hover:border-brand-300 hover:shadow-lg transition-all group flex flex-col h-48 relative">
                             <div onclick="MindMap.open('${map.id}', false)" class="flex-1 flex items-center justify-center opacity-20 group-hover:opacity-40 transition-opacity cursor-pointer">
                                <i class="ph-fill ph-tree-structure text-5xl text-brand-500"></i>
                             </div>
                             <div class="mt-4 mb-3">
                                <h3 class="font-bold text-txt-main truncate">${map.name}</h3>
                                <p class="text-xs text-txt-muted">${new Date(map.createdAt).toLocaleDateString()}</p>
                             </div>
                             <div class="flex gap-2 mt-auto">
                                <button id="btn-mm-view" onclick="MindMap.open('${map.id}', true)" class="flex-1 bg-bg-main hover:bg-brand-50 text-brand-600 py-2 rounded-lg text-xs font-bold transition-colors border border-slate-100">
                                    <i class="ph-bold ph-eye"></i> Ver
                                </button>
                                <button onclick="MindMap.open('${map.id}', false)" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-2 rounded-lg text-xs font-bold transition-colors">
                                    <i class="ph-bold ph-pencil-simple"></i> Editar
                                </button>
                             </div>
                        </div>`;
                    });
                }
                list.innerHTML = html;
            },
            
            create() {
                const name = document.getElementById('map-name').value;
                const subject = document.getElementById('map-subject').value;
                if(!name) return;
                const newMap = { id: 'map-' + Date.now(), name, subject: subject || 'Geral', createdAt: Date.now(), nodes: [{id: 1, x: 300, y: 200, text: name, color: '#2563eb'}], lines: [] };
                Store.state.mindmaps.push(newMap); Store.save();
                document.getElementById('map-name').value = ''; document.getElementById('map-subject').value = '';
                document.getElementById('modal-create-map').close();
                this.renderExplorer(); this.open(newMap.id, false);
            },
            
            zoom(delta) {
                const newScale = this.scale + delta;
                if (newScale >= 0.5 && newScale <= 3.0) {
                    this.scale = newScale;
                    this.updateWorldTransform();
                    UI.toast(`Zoom: ${Math.round(this.scale * 100)}%`);
                }
            },

            resetZoom() {
                this.scale = 1;
                this.pan.offset = {x:0, y:0};
                this.updateWorldTransform();
                UI.toast("Zoom resetado");
            },

            updateWorldTransform() {
                const world = document.getElementById('mm-world');
                if(world) {
                    world.style.transform = `translate(${this.pan.offset.x}px, ${this.pan.offset.y}px) scale(${this.scale})`;
                }
            },

            open(id, readOnly = false) {
                this.currentMap = Store.state.mindmaps.find(m => m.id === id);
                if(!this.currentMap) return;

                document.getElementById('mm-explorer').classList.add('hidden');
                document.getElementById('mm-workspace').classList.remove('hidden');
                document.getElementById('mm-current-title').innerText = this.currentMap.name;
                
                this.isReadOnly = readOnly;
                const ws = document.getElementById('mm-workspace');
                const indicator = document.getElementById('indicator-readonly');
                const keys = document.getElementById('keys-map');
                
                if(this.isReadOnly) {
                    ws.classList.add('readonly');
                    indicator.classList.remove('hidden');
                    keys.classList.add('hidden');
                } else {
                    ws.classList.remove('readonly');
                    indicator.classList.add('hidden');
                    keys.classList.remove('hidden');
                }

                // Reseta câmera
                this.scale = 1; 
                this.pan.offset = {x:0, y:0}; 
                this.updateWorldTransform();
                
                this.render();
            },
            
            close() {
                this.currentMap = null;
                this.selected = null;
                
                document.getElementById('mm-workspace').classList.add('hidden');
                document.getElementById('mm-explorer').classList.remove('hidden');
                document.getElementById('keys-map').classList.remove('hidden');
                this.renderExplorer();
            },
            
            deleteMap() {
                if(!this.currentMap) return;
                if(confirm(`Excluir permanentemente "${this.currentMap.name}"?`)) {
                    Store.state.mindmaps = Store.state.mindmaps.filter(m => m.id !== this.currentMap.id);
                    Store.save(); this.close();
                }
            },

            addNode() { this.addNodeAt(300 - this.pan.offset.x, 300 - this.pan.offset.y); },
            addNodeAt(x, y) {
                if(!this.currentMap) return;
                const color = document.getElementById('mm-color-picker').value;
                this.currentMap.nodes.push({ id: Date.now(), x: x - 70, y: y - 25, text: 'Nova Ideia', color: color, width: 140, height: 60 });
                Store.save(); this.render();
            },
            
            deleteSelectedNode() {
                if (this.selected && this.currentMap) {
                    this.currentMap.lines = this.currentMap.lines.filter(l => l.from !== this.selected && l.to !== this.selected);
                    this.currentMap.nodes = this.currentMap.nodes.filter(n => n.id !== this.selected);
                    
                    this.selected = null;
                    Store.save();
                    this.render();
                    UI.toast("Nó removido.");
                } else {
                    UI.toast("Selecione um nó para remover.");
                }
            },
            updateText(id, txt) { const n = this.currentMap.nodes.find(n => n.id === id); if(n) n.text = txt; },
            updateColor(color) { if(this.selected && this.currentMap) { const n = this.currentMap.nodes.find(n => n.id === this.selected); if(n) { n.color = color; this.render(); Store.save(); } } },
            save() { Store.save(); UI.toast("Mapa salvo!"); }
        };
        setTimeout(() => MindMap.init(), 500);

         // =================================================================
        // Adicionar botão na toolbar do mapa (já no HTML, adicione este JS)
        // =================================================================        
        window.MindMap.exportImage = function() {
            const el = document.getElementById('mm-viewport');
            // Remove transform temporariamente para capturar tudo (opcional, html2canvas lida bem com transform)
            // Mas para garantir qualidade, vamos focar no 'mm-world' centralizado
            UI.toast("Gerando imagem...", "info");
            
            html2canvas(el, { backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-card') }).then(canvas => {
                const link = document.createElement('a');
                link.download = `mapa-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                UI.toast("Download iniciado!", "success");
            });
        };

        // =================================================================
        // LIXEIRA & SETTINGS
        // =================================================================
        window.Trash = {
            add(item, type, context) {
                Store.state.trash.push({ item, type, context, dateDeleted: Date.now() });
                Store.save();
            },
            restore(index) {
                const trashItem = Store.state.trash[index];
                if(trashItem.type === 'task') {
                    if(!Store.state.week[trashItem.context]) Store.state.week[trashItem.context] = [];
                    Store.state.week[trashItem.context].push(trashItem.item);
                    UI.toast("Tarefa restaurada!");
                }
                Store.state.trash.splice(index, 1);
                Store.save();
                this.open(); // Re-render modal
                UI.renderAll();
            },
            open() {
                const c = document.getElementById('trash-container');
                if(Store.state.trash.length === 0) c.innerHTML = '<p class="text-center text-xs text-txt-muted py-4">Lixeira Vazia.</p>';
                else c.innerHTML = Store.state.trash.map((t, i) => `
                    <div class="flex justify-between items-center p-2 border-b border-slate-100 text-xs" style="color: var(--text-main);">
                        <div><span class="font-bold ">${t.type}:</span> ${t.item.title || 'Item'}</div>
                        <div class="flex items-center gap-2">
                            <span class="text-txt-muted">${new Date(t.dateDeleted).toLocaleTimeString()}</span>
                            <button onclick="Trash.restore(${i})" class="text-brand-600 hover:bg-brand-50 p-1 rounded" title="Restaurar"><i class="ph-bold ph-arrow-u-up-left"></i></button>
                        </div>
                    </div>`).join('');
                document.getElementById('modal-trash').showModal();
            },
            empty() { Store.state.trash = []; Store.save(); this.open(); }
        };

        window.Settings = {
            setTheme(t) {
                Store.state.settings.theme = t;
                document.body.className = `h-screen w-screen font-sans theme-${t}`;
                if(t === 'light') document.body.classList.remove('theme-light');
                Store.save();
            },
            tab(id) {
                document.querySelectorAll('.sett-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('tab-'+id).classList.remove('hidden');
                // Fix: Highlight active tab
                document.querySelectorAll('.sett-tab').forEach(b => b.classList.remove('active-sett-tab'));
                document.getElementById('tab-btn-'+id).classList.add('active-sett-tab');
            },
            saveCloud() {
                UI.toast("Configuração automática ativa.");
            },

        async confirmHardReset() {
            if(!confirm("⚠️ PERIGO: Apagar tudo para sempre?")) return;

                window.isResetting = true; 
                if(window.saveInterval) clearInterval(window.saveInterval);

                // 1. Zera a Memória RAM
                const zeroState = {
                    user: { name: 'Visitante', xp: 0, level: 1, streak: 0, inventory: [] },
                    tasks: [], habits: [], history: {}, mindmaps: [], quiz: [],
                    settings: { theme: 'light' },
                    lastLogin: new Date().toISOString()
                };
                Store.state = zeroState; 
                
                UI.toast("Formatando Nuvem...", "warning");

                try {
                    const user = auth.currentUser;
                    if (user) {
                        // --- CORREÇÃO DO CAMINHO AQUI ---
                        // O app usa esse caminho longo, o reset tem que usar o mesmo!
                        const appId = 'orbit-v7'; 
                        const correctPath = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'orbit_state');
                        
                        // Sobrescreve o arquivo exato com zeros
                        await setDoc(correctPath, zeroState);
                        console.log("Banco de dados REAL sobrescrito.");
                    }

                    localStorage.clear();
                    sessionStorage.clear();
                    await signOut(auth);

                    alert("Reset Realizado com Sucesso!");
                    window.location.reload();

                } catch (error) {
                    console.error("Erro fatal:", error);
                    alert("Erro: " + error.message);
                    window.isResetting = false; 
                }
            },
        };

        // Atualização no Objeto Settings para salvar a Key
        window.Settings.saveGeminiKey = function() {
            const key = document.getElementById('sett-gemini-key').value.trim();
            if(key) {
                if(!Store.state.settings) Store.state.settings = {};
                Store.state.settings.geminiKey = key;
                Store.save();
                UI.toast("Chave Gemini salva!", "success");
                document.getElementById('sett-gemini-key').value = "";
            }
        };

        // =================================================================
        // QUIZ IMPORT JSON
        // =================================================================
        window.Quiz = {
            render() {
                const list = document.getElementById('quiz-list');
                const search = document.getElementById('q-search').value.toLowerCase();
                const filtered = Store.state.quiz.filter(q => q.text.toLowerCase().includes(search) || (q.topic && q.topic.toLowerCase().includes(search)));
                
                // ATUALIZAR GRÁFICO SEMPRE (Mesmo se lista vazia)
                this.updateChart();
                
                if(filtered.length === 0) { 
                    list.innerHTML = `<div class="text-center py-10 opacity-50">Sem questões. Importe alguma!</div>`; 
                    return; 
                }
                
                list.innerHTML = filtered.map((q) => `
                    <div class="bg-card p-5 rounded-2xl border border-slate-200/10 shadow-sm relative group">
                        <button onclick="Quiz.delete('${q.id}')" class="absolute top-3 right-3 p-2 text-txt-muted hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity z-10" title="Excluir Questão">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                        <div class="mb-3"><span class="text-[10px] uppercase font-bold bg-brand-50 text-brand-600 px-2 py-1 rounded">${q.topic}</span></div>
                        <p class="font-bold text-txt-main mb-4 text-sm leading-relaxed pr-8">${q.text}</p>
                        <div class="space-y-2">
                            ${q.options.map((opt, i) => `
                                <button onclick="Quiz.answer('${q.id}', ${i}, this)" class="w-full text-left p-3 rounded-xl border border-slate-200/10 hover:bg-brand-50 transition-all text-sm text-txt-muted flex gap-3 group">
                                    <span class="w-6 h-6 rounded bg-bg-main border border-slate-200 flex items-center justify-center text-xs font-bold group-hover:bg-brand-500 group-hover:text-white uppercase">${String.fromCharCode(97+i)}</span>
                                    <span>${opt}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>`).join('');
            },
            
            delete(id) {
                if(confirm("Tem certeza que deseja excluir esta questão?")) {
                    // Correção de Estatísticas (Acertos/Erros)
                    if(Store.state.quizHistory) {
                        const related = Store.state.quizHistory.filter(h => h.qId == id);
                        
                        // Subtrai do placar o que foi ganho/perdido com essa questão
                        related.forEach(h => {
                            if(h.result === 'hit') Store.state.stats.hits = Math.max(0, Store.state.stats.hits - 1);
                            if(h.result === 'miss') Store.state.stats.misses = Math.max(0, Store.state.stats.misses - 1);
                        });

                        // Limpa do histórico
                        Store.state.quizHistory = Store.state.quizHistory.filter(h => h.qId != id);
                    }

                    Store.state.quiz = Store.state.quiz.filter(q => q.id != id);

                    // RESET TOTAL se não houver mais questões
                    if(Store.state.quiz.length === 0) {
                        Store.state.stats.hits = 0;
                        Store.state.stats.misses = 0;
                        Store.state.quizHistory = [];
                    }

                    Store.save();
                    this.render();
                    UI.toast("Questão removida.");
                }
            },

            processImport() {
                let text = document.getElementById('import-area').value.trim();
                const subject = document.getElementById('import-subject').value || 'Geral';
                
                // FIX: Detecta e corrige lista de objetos sem colchetes (Ex: {...}, {...})
                if (text.startsWith('{') && text.endsWith('}') && text.includes('}')) {
                    // Se não começa com [ mas parece ser múltiplos objetos ou um único objeto, tenta parsear
                    // Se falhar o parse direto, tenta envolver em colchetes
                    try {
                        JSON.parse(text);
                    } catch {
                        text = `[${text}]`;
                    }
                }

                // Tenta importar como JSON
                try {
                    if(text.startsWith('[') || text.startsWith('{')) {
                        const data = JSON.parse(text);
                        const items = Array.isArray(data) ? data : [data];
                        let count = 0;
                        
                        items.forEach(item => {
                            if(item.text && item.options) {
                                // CORREÇÃO DE INDEX (1=A -> 0=A)
                                let rawIndex = (item.correctIndex !== undefined) ? parseInt(item.correctIndex) : 1;
                                if(rawIndex < 1) rawIndex = 1;
                                
                                Store.state.quiz.push({
                                    id: Date.now() + Math.random(), // ID único garantido
                                    topic: item.topic || subject,
                                    text: item.text,
                                    options: item.options,
                                    correctIndex: rawIndex - 1
                                });
                                count++;
                            }
                        });
                        
                        if (count > 0) {
                            UI.toast(`Sucesso! ${count} questões importadas.`);
                            finishImport(); 
                            return;
                        }
                    }
                } catch(e) { 
                    console.error("Erro JSON:", e);
                    // Se o usuário tentou colar JSON (começa com [ ou {) e falhou, avise o erro
                    if(text.startsWith('[') || text.startsWith('{')) {
                        alert("Erro no formato JSON: " + e.message + "\n\nDica: Verifique se usou aspas duplas (\") em tudo e se não sobrou vírgula no final.");
                        return; // Impede fallback para texto que geraria lixo
                    }
                }

                // Parser Texto (Fallback para colar 1 questão direto do PDF)
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                if(lines.length === 0) return;
                
                let questionText = lines[0]; 
                let options = [];
                const optRegex = /^[a-eA-E][).]\s*(.*)/;
                
                lines.forEach((line, i) => {
                    if(i === 0) return;
                    const match = line.match(optRegex);
                    if(match) options.push(match[1]); 
                    else if(options.length === 0) questionText += " " + line; 
                });
                
                if(options.length < 2) options = ["Verdadeiro", "Falso"];
                
                Store.state.quiz.push({ 
                    id: Date.now() + Math.random(), 
                    topic: subject, 
                    text: questionText, 
                    options: options, 
                    correctIndex: 0 
                });
                
                finishImport();

                function finishImport() {
                    document.getElementById('modal-import').close();
                    document.getElementById('import-area').value = '';
                    Store.save(); 
                    UI.renderAll();
                }
            },

            answer(qId, optIdx, btn) {
                // Busca a questão pelo ID para garantir consistência
                const question = Store.state.quiz.find(q => q.id == qId);
                if (!question) return;

                const isCorrect = (optIdx === question.correctIndex);
                
                // Grava no histórico para permitir rollback se deletar
                if(!Store.state.quizHistory) Store.state.quizHistory = [];
                Store.state.quizHistory.push({ qId: qId, result: isCorrect ? 'hit' : 'miss' });

                const parent = btn.parentNode;
                parent.querySelectorAll('button').forEach(b => { b.disabled = true; b.classList.add('opacity-50'); });
                btn.classList.remove('opacity-50');
                
                if(isCorrect) {
                    btn.classList.add('bg-emerald-100', 'border-emerald-500', 'text-emerald-700');
                    Store.state.stats.hits++; 
                    Store.state.user.xp += 15; 
                    UI.toast("Correto! +15XP", "success");
                } else {
                    btn.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                    Store.state.stats.misses++;
                    
                    // Mostra a correta
                    const correctBtn = parent.children[question.correctIndex];
                    if(correctBtn) {
                        correctBtn.classList.remove('opacity-50');
                        correctBtn.classList.add('bg-emerald-100', 'border-emerald-500');
                    }
                    
                    UI.toast("Incorreto", "error");
                }
                Store.save(); this.updateChart();
            },

            updateChart() {
                const ctx = document.getElementById('chart-performance');
                if(!ctx) return;
                if(window.perfChart) window.perfChart.destroy();
                
                document.getElementById('stat-hits').innerText = Store.state.stats.hits;
                document.getElementById('stat-misses').innerText = Store.state.stats.misses;
                
                window.perfChart = new Chart(ctx, { 
                    type: 'doughnut', 
                    data: { 
                        labels: ['Acertos', 'Erros'], 
                        datasets: [{ 
                            data: [Store.state.stats.hits, Store.state.stats.misses], 
                            backgroundColor: ['#10b981', '#ef4444'], 
                            borderWidth: 0, 
                        }] 
                    }, 
                    options: { cutout: '75%', plugins: { legend: { display: false } } } 
                });
            }
        };

        window.openTrash = () => Trash.open();
        // Resto dos utils permanece...
        window.router = (view, closesidebar) => {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+view).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('bg-brand-50', 'text-brand-600'));
            document.getElementById('nav-'+view).classList.add('bg-brand-50', 'text-brand-600');
            toggleSidebar(); // Fecha a sidebar no mobile ao navegar
            const title = document.getElementById('page-title');
            title.innerText = view === 'dashboard' ? 'Dashboard' : view === 'cronograma' ? 'Cronograma' : view === 'mindmap' ? 'Mapas Mentais' : view === 'questoes' ? 'Vestibular' : view === 'foco' ? 'Modo Foco' : view === 'flashcards' ? 'Flashcards' : view === 'redacao' ? 'Redação' : view === 'simulado' ? 'Simulado' : view === 'loja' ? 'Conquistas' : 'Dashboard';

            if(closesidebar); closeSidebar();
            if(view === 'mindmap') setTimeout(() => { MindMap.renderExplorer(); }, 50);
            if(view === 'questoes') Quiz.updateChart();
        };
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('mobile-overlay');
            if (sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); } 
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        };

        window.closeSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('mobile-overlay');
            sb.classList.add('-translate-x-full'); ov.classList.add('hidden');
        };

        window.openSettings = () => document.getElementById('modal-settings').showModal();
        window.toggleUserMenu = () => { const m = document.getElementById('user-menu'); m.classList.toggle('hidden'); m.classList.toggle('flex'); };
        window.toggleZen = () => {
            const sb = document.getElementById('sidebar'); const hdr = document.querySelector('header'); const menu = document.getElementById('sidebarMenu');
            if(sb.classList.contains('zen-hidden')) { sb.classList.remove('zen-hidden'); hdr.classList.remove('zen-hidden'); menu.classList.remove('hidden'); UI.toast("Modo Zen Desativado"); } 
            else { sb.classList.add('zen-hidden'); UI.toast("Modo Zen Ativado (Z para sair)"); menu.classList.add('hidden');}
        };
        window.distributePomodoro = () => {
            const min = prompt("Minutos totais para hoje:", "120"); if(!min) return;
            const day = ['domingo','segunda','terca','quarta','quinta','sexta','sabado'][new Date().getDay()];
            const tasks = Store.state.week[day]; if(!tasks || !tasks.length) return alert("Sem tarefas hoje.");
            const perTask = Math.floor(parseInt(min) / tasks.length);
            tasks.forEach(t => t.pomodoros = perTask); Store.save(); UI.renderAll(); UI.toast(`Distribuído: ${perTask}m por tarefa`);
        };
        window.openAnchorModal = () => { const title = prompt("Nome do novo hábito:"); if(title) { Store.state.anchors.push({title, icon: 'star', completed: false}); Store.save(); UI.renderDashboard(); } };
        window.Shop = {
            render() {
                const items = [ { id: 'badge_focus', name: 'Mestre do Foco', price: 500, icon: 'brain', color: 'text-pink-500' }, { id: 'badge_fire', name: 'Imparável', price: 1000, icon: 'fire', color: 'text-orange-500' }, { id: 'badge_king', name: 'Rei dos Estudos', price: 5000, icon: 'crown', color: 'text-yellow-500' } ];
                document.getElementById('shop-grid').innerHTML = items.map(i => {
                    const owned = Store.state.user.inventory.includes(i.id);
                    return `<div class="bg-card p-6 rounded-3xl border ${owned ? 'border-brand-500 bg-brand-50/20' : 'border-slate-200/10'} text-center relative overflow-hidden group"><div class="bg-bg-main w-20 h-20 rounded-full mx-auto flex items-center justify-center mb-4 shadow-inner"><i class="ph-fill ph-${i.icon} text-4xl ${i.color}"></i></div><h3 class="font-bold text-txt-main">${i.name}</h3><p class="text-sm font-bold text-brand-600 mb-4">${i.price} XP</p><button onclick="Shop.buy('${i.id}', ${i.price})" ${owned ? 'disabled' : ''} class="w-full py-2 rounded-xl font-bold text-sm transition-all ${owned ? 'bg-green-500 text-white' : 'bg-brand-600 text-white hover:bg-brand-700'}">${owned ? 'Adquirido' : 'Comprar'}</button></div>`;
                }).join('');
            },
            buy(id, price) {
                if(Store.state.user.xp >= price) { Store.state.user.xp -= price; Store.state.user.inventory.push(id); Store.save(); UI.renderAll(); UI.toast("Item comprado!", "success"); } 
                else { UI.toast("XP Insuficiente", "error"); }
            }
        }
        document.addEventListener('keydown', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if(e.key.toLowerCase() === 'z') toggleZen();
            if(e.key.toLowerCase() === 'n') Actions.openTaskModal(['domingo','segunda','terca','quarta','quinta','sexta','sabado'][new Date().getDay()]);
        });

        // =================================================================
        // FLASHCARDS (Item 17) - CÓDIGO CORRIGIDO
        // =================================================================
        window.Flashcards = {
            activeDeck: null,
            queue: [],
            currentCardIndex: 0,
            isFlipped: false,

            init: function() {
                if(!Store.state.decks) Store.state.decks = [];
                this.renderDecks();
            },

            renderDecks: function() {
                const grid = document.getElementById('fc-decks-grid');
                // Segurança: Se não existir array de decks, cria um vazio
                if(!Store.state.decks) Store.state.decks = [];
                
                if(Store.state.decks.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-10 opacity-50">Nenhum baralho criado.</div>';
                    return;
                }
                
                // Mapeia os baralhos para HTML
                grid.innerHTML = Store.state.decks.map(d => `
                    <div class="bg-card p-6 rounded-2xl border border-slate-200/10 hover:border-brand-500 transition-all group relative">
                        <button onclick="Flashcards.deleteDeck('${d.id}')" class="absolute top-4 right-4 text-txt-muted hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-bold ph-trash"></i></button>
                        <h3 class="font-bold text-lg text-txt-main mb-1">${d.name}</h3>
                        <p class="text-xs text-txt-muted mb-4">${d.cards.length} cartas</p>
                        <div class="flex gap-2">
                            <button onclick="Flashcards.openAddCard('${d.id}')" class="flex-1 py-2 bg-bg-main rounded-lg text-xs font-bold text-txt-muted hover:text-brand-600 border border-slate-200/10">+ Carta</button>
                            <button onclick="Flashcards.startStudy('${d.id}')" class="flex-1 py-2 bg-brand-600 rounded-lg text-xs font-bold text-white hover:bg-brand-700 shadow-lg shadow-brand-500/20">Estudar</button>
                        </div>
                    </div>
                `).join('');
            },

            createDeck: function() {
                const nameInput = document.getElementById('deck-name');
                const name = nameInput.value;
                if(!name) return;
                
                if(!Store.state.decks) Store.state.decks = [];
                
                Store.state.decks.push({ id: 'd-' + Date.now(), name: name, cards: [] });
                Store.save();
                
                nameInput.value = '';
                document.getElementById('modal-create-deck').close();
                this.renderDecks();
            },

            deleteDeck: function(id) {
                if(confirm("Apagar baralho permanentemente?")) {
                    Store.state.decks = Store.state.decks.filter(d => d.id !== id);
                    Store.save();
                    this.renderDecks();
                }
            },

            openAddCard: function(deckId) {
                document.getElementById('card-deck-id').value = deckId;
                document.getElementById('modal-add-card').showModal();
            },

            addCard: function() {
                const deckId = document.getElementById('card-deck-id').value;
                const frontInput = document.getElementById('card-front');
                const backInput = document.getElementById('card-back');
                
                const front = frontInput.value;
                const back = backInput.value;
                
                if(!front || !back) return;
                
                const deck = Store.state.decks.find(d => d.id === deckId);
                if(deck) {
                    deck.cards.push({ 
                        id: 'c-' + Date.now(), 
                        front: front, 
                        back: back, 
                        level: 0 
                    });
                    Store.save();
                    UI.toast("Carta adicionada!");
                }
                
                frontInput.value = '';
                backInput.value = '';
                frontInput.focus();
                this.renderDecks();
            },

            startStudy: function(deckId) {
                const deck = Store.state.decks.find(d => d.id === deckId);
                if(!deck || deck.cards.length === 0) {
                    UI.toast("Baralho vazio!", "error");
                    return;
                }
                
                this.activeDeck = deck;
                // Embaralha as cartas
                this.queue = [...deck.cards].sort(() => Math.random() - 0.5);
                this.currentCardIndex = 0;
                this.isFlipped = false;

                document.getElementById('fc-decks-view').classList.add('hidden');
                document.getElementById('fc-study-view').classList.remove('hidden');
                this.showCard();
            },

            showCard: function() {
                // Verifica se acabou
                if(this.currentCardIndex >= this.queue.length) {
                    UI.toast("Estudo concluído! +100XP", "success");
                    Store.state.user.xp += 100;
                    Store.save();
                    this.closeStudy();
                    return;
                }

                const card = this.queue[this.currentCardIndex];
                document.getElementById('fc-front-text').innerText = card.front;
                document.getElementById('fc-back-text').innerText = card.back;
                
                // Reset visual (garante que começa mostrando a frente)
                this.isFlipped = false;
                document.getElementById('fc-card-inner').classList.remove('rotate-y-180');
                
                // Esconde controles
                const controls = document.getElementById('fc-controls');
                controls.classList.remove('opacity-100', 'pointer-events-auto');
                controls.classList.add('opacity-0', 'pointer-events-none');
            },

            flip: function() {
                if(this.isFlipped) return;
                this.isFlipped = true;
                document.getElementById('fc-card-inner').classList.add('rotate-y-180');
                
                // Mostra controles
                const controls = document.getElementById('fc-controls');
                controls.classList.remove('opacity-0', 'pointer-events-none');
                controls.classList.add('opacity-100', 'pointer-events-auto');
            },

            next: function(difficulty) {
                // Aqui entraria a lógica de SRS (repetição espaçada)
                // Por enquanto apenas avança
                this.currentCardIndex++;
                this.showCard();
            },

            closeStudy: function() {
                document.getElementById('fc-study-view').classList.add('hidden');
                document.getElementById('fc-decks-view').classList.remove('hidden');
                this.renderDecks();
            }
        };

        // Inicializa após 1 segundo
        setTimeout(() => { if(window.Flashcards) window.Flashcards.init(); }, 1000);

        // =================================================================
        // HABILITAR TAB NA REDAÇÃO (INDENTAÇÃO DE PARÁGRAFO)
        // =================================================================
        document.addEventListener('keydown', function(e) {
            // Verifica se a tecla é TAB e se estamos no editor de redação
            if (e.key === 'Tab' && e.target.id === 'red-full-text') {
                e.preventDefault(); // Impede de sair do campo

                const textarea = e.target;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const val = textarea.value;
                const indent = "    "; // 4 espaços para simular parágrafo

                // Insere o espaço onde o cursor está
                textarea.value = val.substring(0, start) + indent + val.substring(end);

                // Coloca o cursor logo após o espaço inserido
                textarea.selectionStart = textarea.selectionEnd = start + indent.length;
                
                // Atualiza contagem de palavras/linhas
                if(window.Redacao) Redacao.updateStats();
            }
        });

        Store.init();
    </script>
</body>
</html>
